<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="PacketScript overview: A Lua scripting engine for in-kernel packet processing" /><meta name="author" content="Shahriar" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/packetscript-lua-kernel/" /><meta property="og:url" content="https://rayanfam.com/topics/packetscript-lua-kernel/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-02-09T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="PacketScript overview: A Lua scripting engine for in-kernel packet processing" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Shahriar" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Shahriar"},"dateModified":"2022-04-13T21:12:10+00:00","datePublished":"2019-02-09T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"PacketScript overview: A Lua scripting engine for in-kernel packet processing","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/packetscript-lua-kernel/"},"url":"https://rayanfam.com/topics/packetscript-lua-kernel/"}</script><title>PacketScript overview: A Lua scripting engine for in-kernel packet processing | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>PacketScript overview: A Lua scripting engine for in-kernel packet processing</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>PacketScript overview: A Lua scripting engine for in-kernel packet processing</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Xcess">Shahriar</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1549670400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-02-09 </em> </span> <span> Updated <em class="timeago" data-ts="1649884330" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-14 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="679 words"> <em>3 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/linux-tux-large.jpg" alt="" data-proofer-ignore></p><p>As I was surfing the net, trying to find a way to prototype network protocols or features in Linux. I stumbled upon PacketScript.</p><p>PacketScript is the an implementation of the Lua VM inside Linux kernel. Such implementations aren’t new ,luak and lunatik have been existed for some time. However what makes PacketScript different is the ability to mangle network packets with Lua. Not just running Lua code in kernel. as a matter of fact PacketScript uses lunatik underneath as its Lua in kernel engine.</p><p>PacketScript is built on existing technologies, ensuring more future maintainability. It is built on iptables infrastructure and on existing xtable-addons platform. Using xtables-addons makes PacketScript needless of kernel patching and compiling. You simply need to install the kernel module. xtables-addons also provides help for adding features into iptables command line interface.</p><p>PacketScript was work of <em>André Graf</em> as his master thesis in University of Basel. Since its original publication of <a href="https://cn.dmi.unibas.ch/pub/doc/2010-msthGraf.pdf">thesis</a> and <a href="https://github.com/dergraf/PacketScript">source code,</a> It has gone unmaintained since. It is currently working and I’m not aware of any bugs but the lack of maintenance may make this project unsuitable for production usage (unless forked and maintained by yourself).</p><p><strong>Note that PacketScript compiles on linux kernel 2.x. (unless you apply the patch)</strong></p><p>Being very disappointed from the kernel version supported by PacketScript, I found a <a href="https://github.com/openwrt/packages/blob/master/net/xtables-addons/patches/201-fix-lua-packetscript.patch">patch</a> by OpenWrt team who has ported PacketScript to 4.x kernels! The patch is for OpenWrt but you can easily apply it to the source and build on any other distro. (I am using PacketScript on OpenWrt myself).</p><p>If you want to use PacketScript on OpenWrt you just need to select it in menuconfig (Network-&gt;IPTables-&gt;ipt-mod-lua).</p><p>We will use Debian stable (jessie) in this guide to learn the patching process. The same process can be used for other distros too. Let’s Start :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="p">.</span> <span class="n">Installing</span> <span class="n">dependencies</span>
<span class="cp"># apt install libxtables-dev linux-headers-$(uname -r) build-essential pkg-config
</span>
<span class="mi">2</span><span class="p">.</span> <span class="n">Download</span> <span class="n">xtables</span><span class="o">-</span><span class="n">addons</span> <span class="n">https</span><span class="o">:</span><span class="c1">//sourceforge.net/projects/xtables-addons and extract files.</span>

<span class="mi">3</span><span class="p">.</span> <span class="n">Download</span> <span class="n">patches</span>

<span class="err">$</span> <span class="n">cd</span> <span class="n">xtables</span><span class="o">-</span><span class="n">addons</span><span class="o">-</span><span class="mi">3</span><span class="p">.</span><span class="mi">2</span><span class="o">/</span>
<span class="err">$</span> <span class="n">wget</span> <span class="s">"https://github.com/openwrt-mirror/openwrt/raw/master/package/network/utils/xtables-addons/patches/201-fix-lua-packetscript.patch"</span>
<span class="err">$</span> <span class="n">wget</span> <span class="s">"https://raw.githubusercontent.com/openwrt-mirror/openwrt/master/package/network/utils/xtables-addons/patches/200-add-lua-packetscript.patch"</span>

<span class="mi">4</span><span class="p">.</span> <span class="n">Apply</span> <span class="n">patches</span>

<span class="err">$</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="o">-</span><span class="n">add</span><span class="o">-</span><span class="n">lua</span><span class="o">-</span><span class="n">packetscript</span><span class="p">.</span><span class="n">patch</span>
<span class="err">$</span> <span class="n">patch</span> <span class="o">-</span><span class="n">p1</span> <span class="o">&lt;</span> <span class="mi">201</span><span class="o">-</span><span class="n">fix</span><span class="o">-</span><span class="n">lua</span><span class="o">-</span><span class="n">packetscript</span><span class="p">.</span><span class="n">patch</span>

<span class="mi">5</span><span class="p">.</span> <span class="n">change</span> <span class="n">config</span> <span class="n">files</span> <span class="p">(</span><span class="n">only</span> <span class="n">necessary</span> <span class="k">if</span> <span class="n">patch</span> <span class="n">fails</span> <span class="n">at</span> <span class="n">config</span> <span class="n">files</span><span class="p">)</span>
<span class="n">At</span> <span class="n">this</span> <span class="n">stage</span> <span class="n">due</span> <span class="n">to</span> <span class="n">difference</span> <span class="n">between</span> <span class="n">xtables</span><span class="o">-</span><span class="n">addons</span> <span class="n">version</span> <span class="n">the</span> <span class="n">first</span> <span class="n">patch</span> <span class="n">may</span> <span class="n">fail</span> <span class="n">at</span> <span class="n">config</span> <span class="n">file</span><span class="p">,</span> <span class="n">You</span> <span class="n">need</span> <span class="n">to</span> <span class="n">change</span> <span class="n">them</span> <span class="n">manually</span> <span class="n">and</span> <span class="n">remove</span> <span class="n">all</span> <span class="n">patch</span> <span class="n">rejects</span> <span class="n">and</span> <span class="n">backups</span><span class="p">.</span>

<span class="mi">5</span><span class="p">.</span><span class="mi">1</span><span class="p">.</span> <span class="n">Change</span> <span class="n">configs</span>
<span class="n">add</span> <span class="err">'</span><span class="n">build_LUA</span><span class="o">=</span><span class="n">m</span><span class="err">'</span> <span class="n">to</span> <span class="n">the</span> <span class="err">'</span><span class="n">xtables</span><span class="o">-</span><span class="n">addons</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">xy</span><span class="o">/</span><span class="n">mconfig</span><span class="err">'</span> <span class="n">file</span>
<span class="n">add</span> <span class="err">'</span><span class="n">obj</span><span class="o">-</span><span class="err">$</span><span class="p">{</span><span class="n">build_LUA</span><span class="p">}</span> <span class="o">+=</span> <span class="n">LUA</span><span class="o">/</span><span class="err">'</span> <span class="n">to</span> <span class="n">the</span> <span class="err">'</span><span class="n">xtables</span><span class="o">-</span><span class="n">addons</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">xy</span><span class="o">/</span><span class="n">extensions</span><span class="o">/</span><span class="n">Mbuild</span><span class="err">'</span> <span class="n">file</span>
<span class="n">add</span> <span class="err">'</span><span class="n">obj</span><span class="o">-</span><span class="err">$</span><span class="p">{</span><span class="n">build_LUA</span><span class="p">}</span> <span class="o">+=</span> <span class="n">LUA</span><span class="o">/</span><span class="err">'</span> <span class="n">to</span> <span class="n">the</span> <span class="err">'</span><span class="n">xtables</span><span class="o">-</span><span class="n">addons</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="n">xy</span><span class="o">/</span><span class="n">extensions</span><span class="o">/</span><span class="n">Kbuild</span><span class="err">'</span> <span class="n">file</span>

<span class="mi">5</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span> <span class="n">Remove</span> <span class="n">rejects</span> <span class="n">and</span> <span class="n">backups</span>
<span class="err">$</span> <span class="n">find</span> <span class="o">-</span><span class="n">name</span> <span class="s">"*.rej"</span> <span class="o">-</span><span class="n">delete</span>
<span class="err">$</span> <span class="n">find</span> <span class="o">-</span><span class="n">name</span> <span class="s">"*.orig"</span> <span class="o">-</span><span class="n">delete</span>

<span class="mi">6</span><span class="p">.</span> <span class="n">Build</span> <span class="o">&amp;</span> <span class="n">Install</span>

<span class="err">$</span> <span class="n">make</span>
<span class="cp"># make install
</span></pre></table></code></div></div><p>Note that despite installing, the module may not be loaded, to do so:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp"># insmod /lib/modules/$(uname -r)/extra/xt_LUA.ko
</span></pre></table></code></div></div><p><em>Note: Module may not be installed in a valid location in order to be detected by modprobe. use symlinks or change the Makefile accordingly. See</em> <a href="https://wiki.archlinux.org/index.php/Kernel_module"><em>this</em></a> <em>or</em> <a href="https://www.cyberciti.biz/faq/linux-how-to-load-a-kernel-module-automatically-at-boot-time/"><em>this</em></a><em>.</em></p><p>Now everything should be ready:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">root</span><span class="err">@</span><span class="n">debian</span><span class="o">:~</span><span class="err">#</span> <span class="n">iptables</span> <span class="o">-</span><span class="n">I</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">j</span> <span class="n">LUA</span>
<span class="n">iptables</span> <span class="n">v1</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="o">:</span> <span class="n">LUA</span><span class="o">:</span> <span class="o">--</span><span class="n">script</span> <span class="n">parameter</span> <span class="n">required</span>
<span class="n">Try</span> <span class="err">`</span><span class="n">iptables</span> <span class="o">-</span><span class="n">h</span><span class="err">'</span> <span class="n">or</span> <span class="err">'</span><span class="n">iptables</span> <span class="o">--</span><span class="n">help</span><span class="err">'</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="p">.</span>
</pre></table></code></div></div><p><img data-src="../../assets/images/iptables-lua.png" alt="" data-proofer-ignore></p><hr /><h3 id="destination-nat-dnat"><span class="mr-2">Destination NAT (DNAT)</span><a href="#destination-nat-dnat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Create a lua script like this (<strong>dnat.lua</strong>) :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">function</span> <span class="n">process_packet</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
	<span class="n">local</span> <span class="n">ip</span> <span class="o">=</span> <span class="n">p</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">packet_eth</span><span class="p">)</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">packet_ip</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">not</span> <span class="n">ip</span> <span class="n">then</span> <span class="k">return</span> <span class="n">NF_DROP</span> <span class="n">end</span>
	<span class="n">ip</span><span class="o">:</span><span class="n">daddr</span><span class="p">()</span><span class="o">:</span><span class="n">set</span><span class="p">(</span><span class="s">"2.1.1.1"</span><span class="p">)</span> 
	<span class="k">return</span> <span class="n">XT_CONTINUE</span>
<span class="n">end</span>
</pre></table></code></div></div><p>Then push it into kernel like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp"># iptables -t mangle -A POSTROUTING -d 8.8.8.8 -j LUA --script dnat.lua
</span></pre></table></code></div></div><p><em>It is recommended to utilize Netfilter matches and extensions and use PacketScript when they cannot do what you want for performance reasons.</em></p><p>I am prototyping some new features in PacketScript. If my employer agreed upon open sourcing those I will create a GitHub repo and update this post with this links.</p><p>No guide is available on the internet for PacketScript. I hope this post would be useful. I am glad to answer questions in comments. Let me know of your network prototyping tools.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kernel-mode/'>kernel-mode</a>, <a href='/categories/linux/'>linux</a>, <a href='/categories/network/'>network</a>, <a href='/categories/tutorials/'>tutorials</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/iptables/" class="post-tag no-text-decoration" >iptables</a> <a href="/tags/kernel/" class="post-tag no-text-decoration" >kernel</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/lua/" class="post-tag no-text-decoration" >lua</a> <a href="/tags/lunatik/" class="post-tag no-text-decoration" >lunatik</a> <a href="/tags/packetscript/" class="post-tag no-text-decoration" >packetscript</a> <a href="/tags/xtables/" class="post-tag no-text-decoration" >xtables</a> <a href="/tags/xtables-addons/" class="post-tag no-text-decoration" >xtables-addons</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PacketScript overview: A Lua scripting engine for in-kernel packet processing - Rayanfam Blog&amp;url=https://rayanfam.com/topics/packetscript-lua-kernel/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=PacketScript overview: A Lua scripting engine for in-kernel packet processing - Rayanfam Blog&amp;u=https://rayanfam.com/topics/packetscript-lua-kernel/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/packetscript-lua-kernel/&amp;text=PacketScript overview: A Lua scripting engine for in-kernel packet processing - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/captive-portal-detection-sample/"><div class="card-body"> <em class="timeago small" data-ts="1531612800" > 2018-07-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Captive portal detection with a working sample in all major OSs!</h3><div class="text-muted small"><p> Hi everyone I’ve been working on a project which involves a developing a captive portal system from scratch. and I’m going to gradually post more of challenges we faced and the way we solved them...</p></div></div></a></div><div class="card"> <a href="/topics/start-linux-kernel-module-development/"><div class="card-body"> <em class="timeago small" data-ts="1539907200" > 2018-10-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Start linux kernel module development!</h3><div class="text-muted small"><p> Hi everyone! In this post I’m going to introduce you to the world of linux kernel module development. I am a newcomer in this field myself but I decided to document everything in this blog as I ...</p></div></div></a></div><div class="card"> <a href="/topics/mount-in-linux/"><div class="card-body"> <em class="timeago small" data-ts="1535673600" > 2018-08-31 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Tour of Mount in Linux</h3><div class="text-muted small"><p> I had windows 10 installed on my laptop because of serious incompatibility of ROG laptops with Linux and my desire to play some games after years of living in bash! This continued for a year and ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/call-gates-ring-transitioning-in-ia-32-mode/" class="btn btn-outline-primary" prompt="Older"><p>Call Gates' Ring Transitioning in IA-32 Mode</p></a> <a href="/topics/hypervisor-from-scratch-part-6/" class="btn btn-outline-primary" prompt="Newer"><p>Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/packetscript-lua-kernel/'; this.page.identifier = '/topics/packetscript-lua-kernel/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
