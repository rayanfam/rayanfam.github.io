<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hypervisor From Scratch - Part 1: Basic Concepts &amp; Configure Testing Environment" /><meta name="author" content="Sina Karvandi" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/hypervisor-from-scratch-part-1/" /><meta property="og:url" content="https://rayanfam.com/topics/hypervisor-from-scratch-part-1/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-08-21T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hypervisor From Scratch - Part 1: Basic Concepts &amp; Configure Testing Environment" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Sina Karvandi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sina Karvandi"},"dateModified":"2024-12-13T14:16:09+00:00","datePublished":"2018-08-21T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Hypervisor From Scratch - Part 1: Basic Concepts &amp; Configure Testing Environment","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/hypervisor-from-scratch-part-1/"},"url":"https://rayanfam.com/topics/hypervisor-from-scratch-part-1/"}</script><title>Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Intel80x86">Sina Karvandi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1534809600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-08-21 </em> </span> <span> Updated <em class="timeago" data-ts="1734099369" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-12-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2374 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/hypervisor-from-scratch-1-cover.png" alt="" data-proofer-ignore></p><p><strong>If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out <a href="https://github.com/HyperDbg/HyperDbg">HyperDbg</a> Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and reversing applications. A free and comprehensive tutorial on hypervisor-based reverse engineering is available at <a href="https://ost2.fyi/dbg3301">OpenSecurityTraining2’s website</a> (<em>preferred</em>) and <a href="https://www.youtube.com/playlist?list=PLUFkSN0XLZ-kF1f143wlw8ujlH2A45nZY">YouTube</a>, which demonstrates numerous practical examples on how to utilize hypervisors for reverse engineering.</strong></p><p><strong>Notice</strong>: The <em><strong>Hypervisor From Scratch</strong></em> tutorial is completely revised in <strong>August 2022</strong>. Codes from all parts are updated, unnecessary details are removed, and new explanations and materials are added to the tutorial.</p><h2 id="introduction"><span class="mr-2"><strong>Introduction</strong></span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Welcome to the first part of a multi-part series of tutorials called “<strong>Hypervisor From Scratch</strong>”. As the name implies, this course contains technical details to create a basic Virtual Machine based on hardware virtualization. If you follow this tutorial, you’ll be able to create your own virtual environment and understand how VMWare, VirtualBox, KVM, and other virtualization software use processors’ facilities to create a virtual environment. Moreover, you can learn how the “VMM” module of the <a href="https://github.com/HyperDbg/HyperDbg">HyperDbg Debugger</a> works internally.</p><p>The full source code of this tutorial is available on GitHub :</p><p>[<a href="https://github.com/SinaKarvandi/Hypervisor-From-Scratch">https://github.com/SinaKarvandi/Hypervisor-From-Scratch</a>]</p><h2 id="table-of-contents"><span class="mr-2"><strong>Table of Contents</strong></span><a href="#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>Introduction</strong><li><strong>Table of Contents</strong><li><strong>Overview</strong><li><strong>Hypervisors and Platforms</strong><li><strong>Installing Tools</strong><li><strong>Configuring A Testing Environment</strong><li><strong>Creating A Driver</strong><ul><li>Disabling The Driver Signature Enforcement (DSE)</ul><li><strong>Nested-Virtualization</strong><ul><li>Hyper-V’s Nested-Virtualization<li>VMware Workstation’s Nested-Virtualization</ul><li><strong>Concepts</strong><li><strong>VMX Instructions</strong><li><strong>Related Work</strong><li><strong>Conclusion</strong><li><strong>References</strong></ul><h2 id="overview"><span class="mr-2"><strong>Overview</strong></span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Both Intel and AMD support virtualization in their modern CPUs. Intel introduced <strong>(VT-x technology)</strong> that was previously codenamed “<strong>Vanderpool</strong>” on November 13, 2005, in Pentium 4 series. The CPU flag for <strong>VT-x</strong> capability is “<strong>VMX</strong>” which stands for <strong>V</strong>irtual <strong>M</strong>achine e<strong>X</strong>tension.</p><p>AMD, on the other hand, developed its first generation of virtualization extensions under the codename “<strong>Pacifica</strong>” and initially published them as AMD <strong>Secure Virtual Machine (SVM)</strong>, but later marketed them under the trademark <em>AMD Virtualization</em>, abbreviated <strong><em>AMD-V</em></strong>.</p><p>There are two types of hypervisors. The “type 1” hypervisor is called a “bare-metal hypervisor” or “native” because it runs directly on a bare-metal physical server. A type 1 hypervisor has direct access to the hardware. With a type 1 hypervisor, there is no operating system to load as the hypervisor itself has the necessary functions to manage the system boot and startup.</p><p>Contrary to a type 1 hypervisor, a type 2 hypervisor loads inside an operating system, just like any other application. Because the type 2 hypervisor has to go through the operating system and is managed by the OS, the type 2 hypervisor (and its virtual machines) will run less efficiently (slower) than type 1 hypervisors.</p><p>Even though most of the concepts about the virtualization in Intel and AMD processors are the same, but there are some differences between <strong>Intel VT-x</strong> and <strong>AMD-V</strong>. For example, Intel and AMD use different instruction sets for virtualization.</p><p>The rest of these tutorials mainly focus on <strong>VT-x</strong> because Intel CPUs are more popular and widely used.</p><h2 id="hypervisors-and-platforms"><span class="mr-2"><strong>Hypervisors and Platforms</strong></span><a href="#hypervisors-and-platforms" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>These concepts are platform independent, which means you can easily run the same code routine in both Linux or Windows and expect the same behavior from the CPU, but I prefer to use Windows as its more easily debuggable (at least for me.), but I try to give some examples for Linux systems whenever needed.</p><p>Linux kernel manages faults like #GP and other exceptions and tries to avoid the kernel panic and keep the system up; thus, it’s better to test something like a hypervisor or any CPU-related programs. In contrast, Windows never tries to manage any unexpected exception and shows a Blue Screen Of Death whenever an unexpected exception occurs; therefore, you might get lots of BSODs while testing your hypervisor.</p><p>Considering the fact that I might (and will) make mistakes like misinformation, wrong implementation, or forget about mentioning some essential explanations in these series, I should say sorry in advance, and I’ll be glad and open to every comment that tells me the mistakes in the technical details. You can use the comments below to notify me about these possible errors.</p><p>That’s enough. Let’s get started!</p><h2 id="installing-tools"><span class="mr-2"><strong>Installing Tools</strong></span><a href="#installing-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>First, we need to install Visual Studio with WDK (Windows Driver Kit).</p><p>You can download the community (free) version of the Visual Studio:</p><p><a href="https://visualstudio.microsoft.com/vs/community">[https://visualstudio.microsoft.com/vs/community]</a>.</p><p>After installing Visual Studio, you can get the WDK from the below link:</p><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk">[https://docs.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk]</a>.</p><p>We’ll use <strong>WinDbg</strong> to debug our hypervisor. We can use WinDbg and WinDbg Preview to debug our hypervisor.</p><p>WinDbg is available in Windows SDK:</p><p><a href="https://developer.microsoft.com/en-us/windows/downloads/windows-sdk">[https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/]</a></p><p>Afterward, we should connect to debug the Windows kernel using WinDbg. You can read the following links to connect WinDbg to debug the kernel using KDNET.</p><ul><li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection">Setting Up KDNET Network Kernel Debugging Manually</a><li><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-a-network-debugging-connection-automatically">Setting Up KDNET Network Kernel Debugging Automatically</a></ul><p>The next step is downloading <strong>OSR Driver Loader</strong>. We use this tool to load our driver. You can download it using the below link:</p><p><a href="https://www.osronline.com/article.cfm?article=157">[https://www.osronline.com/article.cfm?article=157]</a>.</p><p>Finally, we need to download <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/debugview">SysInternals DebugView</a> for printing the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-dbgprint">DbgPrint()</a> results.</p><p><img data-src="../../assets/images/chameleon-1.jpg" alt="Chameleon" data-proofer-ignore></p><h2 id="configuring-a-testing-environment"><span class="mr-2"><strong>Configuring A Testing Environment</strong></span><a href="#configuring-a-testing-environment" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Most of the codes in this tutorial have to run at the kernel-level, and we must set up a Linux Kernel Module or a Windows Driver for this purpose.</p><p>As configuring a Virtual Machine Monitor (VMM) involves lots of assembly codes, we should be able to embed inline assemblies within our kernel project.</p><p>WDK (and also user-mode applications) no longer support inline assembly in an x64 environment, so we should be able to create a simple x64 project with the support for inline assembly codes.</p><p>I explained it step by step in one of my posts, so I highly recommend reading <a href="https://rayanfam.com/topics/inline-assembly-in-x64">this topic</a> to create a project with inline assembly support before continuing the rest of this part.</p><p>Now it’s time to create a driver!</p><h2 id="creating-a-driver"><span class="mr-2"><strong>Creating A Driver</strong></span><a href="#creating-a-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There is a good article <a href="https://resources.infosecinstitute.com/writing-a-windows-kernel-driver/">here</a> if you want to start with Windows Driver Kit (WDK).</p><p>For the first example, we’ll create an elementary WDK driver. In WDK, we need two essential functions, first is a Driver Entry function that works as a starting point where the driver starts its execution whenever it is loaded. The second is for Driver Unload, responsible for removing the objects used in the driver.</p><p>In the driver entry, our driver needs to register a device so we can communicate with our virtual environment from the user-mode. On the other hand, I defined <strong>DrvUnload</strong>, which uses the PnP Windows driver feature, and we can easily unload our driver and remove the device, then reload and create a new one.</p><p>The following code is responsible for creating a new device :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DriverName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">MyHypervisor"</span><span class="p">);</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">DosDevices</span><span class="se">\\</span><span class="s">MyHypervisor"</span><span class="p">);</span>

    <span class="n">NtStatus</span> <span class="o">=</span> <span class="n">IoCreateDevice</span><span class="p">(</span><span class="n">DriverObject</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DriverName</span><span class="p">,</span> <span class="n">FILE_DEVICE_UNKNOWN</span><span class="p">,</span> <span class="n">FILE_DEVICE_SECURE_OPEN</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DeviceObject</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">NtStatus</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DrvUnload</span><span class="p">;</span>
        <span class="n">DeviceObject</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">IO_TYPE_DEVICE</span><span class="p">;</span>
        <span class="n">DeviceObject</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">DO_DEVICE_INITIALIZING</span><span class="p">);</span>
        <span class="n">IoCreateSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DriverName</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>All in all, you can compile the following file to create our first WDK driver in Visual Studio (with WDK installed).</p><p>It contains a Driver Entry function which creates a device and registers the unloading routines. Whenever the driver is loaded, the <code class="language-c highlighter-rouge"><span class="n">DriverEntry</span></code> function is called, and when we unload it, <code class="language-c highlighter-rouge"><span class="n">DrvUnload</span></code> will be called. This function will remove the device that we registered before.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;ntddk.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wdf.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;wdm.h&gt;</span><span class="cp">
</span>
<span class="n">NTSTATUS</span>
<span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span><span class="p">);</span>

<span class="n">VOID</span>
<span class="nf">DrvUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">);</span>

<span class="cp">#pragma alloc_text(INIT, DriverEntry)
#pragma alloc_text(PAGE, DrvUnload)
</span>
<span class="n">NTSTATUS</span>
<span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">RegistryPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">NTSTATUS</span>       <span class="n">NtStatus</span>     <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">UNICODE_STRING</span> <span class="n">DriverName</span><span class="p">,</span> <span class="n">DosDeviceName</span><span class="p">;</span>

    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"DriverEntry Called."</span><span class="p">);</span>

    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DriverName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">MyHypervisor"</span><span class="p">);</span>
    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">DosDevices</span><span class="se">\\</span><span class="s">MyHypervisor"</span><span class="p">);</span>

    <span class="n">NtStatus</span> <span class="o">=</span> <span class="n">IoCreateDevice</span><span class="p">(</span><span class="n">DriverObject</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DriverName</span><span class="p">,</span> <span class="n">FILE_DEVICE_UNKNOWN</span><span class="p">,</span> <span class="n">FILE_DEVICE_SECURE_OPEN</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DeviceObject</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">NtStatus</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DrvUnload</span><span class="p">;</span>
        <span class="n">DeviceObject</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">IO_TYPE_DEVICE</span><span class="p">;</span>
        <span class="n">DeviceObject</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">DO_DEVICE_INITIALIZING</span><span class="p">);</span>
        <span class="n">IoCreateSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DriverName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">NtStatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">VOID</span>
<span class="nf">DrvUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">DriverObject</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UNICODE_STRING</span> <span class="n">DosDeviceName</span><span class="p">;</span>

    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"DrvUnload Called !"</span><span class="p">);</span>

    <span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">,</span> <span class="s">L"</span><span class="se">\\</span><span class="s">DosDevices</span><span class="se">\\</span><span class="s">MyHypervisor"</span><span class="p">);</span>

    <span class="n">IoDeleteSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">);</span>
    <span class="n">IoDeleteDevice</span><span class="p">(</span><span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DeviceObject</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Starting from the next version, the source code of each driver is available at <a href="https://github.com/SinaKarvandi/Hypervisor-From-Scratch">GitHub</a>, and we’ll talk about different features in WDK drivers. Don’t worry if you still don’t have any idea about a Windows Driver. We’ll work on it later in the next part. Just make sure to set up the environment for now.</p><h3 id="disabling-the-driver-signature-enforcement-dse"><span class="mr-2"><strong>Disabling The Driver Signature Enforcement (DSE)</strong></span><a href="#disabling-the-driver-signature-enforcement-dse" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>If you use Windows, you should disable Driver Signature Enforcement to load our driver. That’s because Microsoft prevents any not verified code from running in Windows Kernel (Ring 0).</p><p>To do this, press and hold the shift key and restart your computer. You should see a new window.</p><ol><li>Click <strong>Advanced options</strong>.<li>On the new Window, Click <strong>Startup Settings</strong>.<li>Click on <strong>Restart</strong>.<li>On the Startup Settings screen, press 7 or F7 to disable driver signature enforcement.</ol><p><img data-src="../../assets/images/driver-signature-enforcement-boot-menu.png" alt="Disable DSE" data-proofer-ignore></p><p>The latest thing I remember is enabling Windows Debugging messages through the registry. This way we can get <strong>DbgPrint()</strong> results through <strong>SysInternals DebugView</strong>.</p><p>Just perform the following steps:</p><p>Save the following content as <code class="language-c highlighter-rouge"><span class="n">dbgview</span><span class="p">.</span><span class="n">reg</span></code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Windows</span> <span class="n">Registry</span> <span class="n">Editor</span> <span class="n">Version</span> <span class="mi">5</span><span class="p">.</span><span class="mo">00</span>

<span class="p">[</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="err">\</span><span class="n">SYSTEM</span><span class="err">\</span><span class="n">CurrentControlSet</span><span class="err">\</span><span class="n">Control</span><span class="err">\</span><span class="n">Session</span> <span class="n">Manager</span><span class="err">\</span><span class="n">Debug</span> <span class="n">Print</span> <span class="n">Filter</span><span class="p">]</span>
<span class="s">"DEFAULT"</span><span class="o">=</span><span class="n">dword</span><span class="o">:</span><span class="mo">0000000</span><span class="n">f</span>
</pre></table></code></div></div><p>Double-click on <code class="language-c highlighter-rouge"><span class="n">dbgview</span><span class="p">.</span><span class="n">reg</span></code>. Reboot the machine, and it’s good to go.</p><h2 id="nested-virtualization"><span class="mr-2"><strong>Nested-virtualization</strong></span><a href="#nested-virtualization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>What if you don’t have access to a separate physical machine?</p><p>You can use VMware’s (or any other virtualization product) <strong>nested-virtualization</strong>.</p><h3 id="vmware-workstations-nested-virtualization"><span class="mr-2"><strong>VMware Workstation’s Nested-Virtualization</strong></span><a href="#vmware-workstations-nested-virtualization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>In order to set up a nested virtualization environment, make sure to enable the following features in your VM.</p><p><img data-src="../../assets/images/nested-virtualization-vmware-2.png" alt="VMWare Nested Virtualization" data-proofer-ignore></p><p>All the drivers are tested on both physical machines and VMware’s nested virtualization.</p><h3 id="hyper-vs-nested-virtualization"><span class="mr-2"><strong>Hyper-V’s Nested-Virtualization</strong></span><a href="#hyper-vs-nested-virtualization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Hyper-V differs from VMWare in many aspects. Therefore you can’t test your hypervisor on Hyper-V’s nested virtualization. In part 8, I’ll describe how to modify your hypervisor in a way that can be used in Hyper-V, so after part 8, you’ll be able to test your hypervisor on Hyper-V’s nested virtualization.</p><h2 id="concepts"><span class="mr-2"><strong>Concepts</strong></span><a href="#concepts" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>We will frequently use some keywords in the rest of these series, and you should know about them (Most of the definitions are derived from <strong>Intel software developer’s manual, volume 3C</strong>).</p><p><strong>Virtual Machine Monitor (VMM)</strong>: VMM acts as a host and has full control of the processor(s) and other platform hardware. A VMM is able to retain selective control of processor resources, physical memory, interrupt management, and I/O.</p><p><strong>Guest Software</strong>: Each virtual machine (VM) is a guest software environment.</p><p><strong>VMX Root Operation and VMX Non-root Operation</strong>: A VMM will run in VMX root operation, and guest software will run in VMX non-root operation.</p><p><strong>VMX transitions</strong>: Transitions between VMX root operation and VMX non-root operation.</p><p><strong>VM entries</strong>: Transitions into VMX non-root operation.</p><p><strong>Extended Page Table (EPT)</strong>: A mechanism that uses a second layer for converting the guest’s physical address to the host’s physical address.</p><p><strong>VM exits</strong>: Transitions from VMX non-root operation to VMX root operation.</p><p><strong>Virtual machine control structure (VMCS)</strong>: is a data structure in memory that exists exactly once per VM (or more precisely, one per virtual CPU) while the VMM manages it. With every change in the execution context between different VMs, the VMCS is restored for the current VM, defining the state of the VM’s virtual processor and VMM control Guest software using VMCS.</p><p>The VMCS consists of six logical groups:</p><ul><li>Guest-state area: Processor state saved into the guest state area on VM exits and loaded on VM entries.<li>Host-state area: Processor state loaded from the host state area on VM exits.<li>VM-execution control fields: Fields controlling processor operation in VMX non-root operation.<li>VM-exit control fields: Fields that control VM exits.<li>VM-entry control fields: Fields that control VM entries.<li>VM-exit information fields: Read-only fields to receive information on VM exits describing the cause and the nature of the VM exit.</ul><p>I found a great work illustrating the VMCS. The PDF version is also available <a href="../../assets/files/VMCS.pdf">here</a>.</p><p><img data-src="../../assets/images/VMCS-page-layout-1.jpeg" alt="VMCS" data-proofer-ignore></p><p><img data-src="../../assets/images/VMCS-page-layout-2.jpg" alt="VMCS" data-proofer-ignore></p><p>Don’t worry about the fields. I’ll explain most of them clearly in the latter parts. Just remember, VMCS Structure varies between different versions of a processor.</p><h2 id="vmx-instructions"><span class="mr-2"><strong>VMX Instructions</strong></span><a href="#vmx-instructions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>VMX introduces the following new instructions.</p><div class="table-wrapper"><table><thead><tr><th style="text-align: center">Intel Mnemonic<th style="text-align: center">Description<tbody><tr><td style="text-align: center">INVEPT<td style="text-align: center">Invalidate Translations Derived from EPT<tr><td style="text-align: center">INVVPID<td style="text-align: center">Invalidate Translations Based on VPID<tr><td style="text-align: center">VMCALL<td style="text-align: center">Call to VM Monitor<tr><td style="text-align: center">VMCLEAR<td style="text-align: center">Clear Virtual-Machine Control Structure<tr><td style="text-align: center">VMFUNC<td style="text-align: center">Invoke VM function<tr><td style="text-align: center">VMLAUNCH<td style="text-align: center">Launch Virtual Machine<tr><td style="text-align: center">VMRESUME<td style="text-align: center">Resume Virtual Machine<tr><td style="text-align: center">VMPTRLD<td style="text-align: center">Load Pointer to Virtual-Machine Control Structure<tr><td style="text-align: center">VMPTRST<td style="text-align: center">Store Pointer to Virtual-Machine Control Structure<tr><td style="text-align: center">VMREAD<td style="text-align: center">Read Field from Virtual-Machine Control Structure<tr><td style="text-align: center">VMWRITE<td style="text-align: center">Write Field to Virtual-Machine Control Structure<tr><td style="text-align: center">VMXOFF<td style="text-align: center">Leave VMX Operation<tr><td style="text-align: center">VMXON<td style="text-align: center">Enter VMX Operation</table></div><h2 id="vmm-life-cycle"><span class="mr-2"><strong>VMM Life Cycle</strong></span><a href="#vmm-life-cycle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="../../assets/images/vmm-life-cycle.png" alt="VM Cycle" data-proofer-ignore></p><ul><li>The following items summarize the life cycle of a VMM and its guest software, as well as the interactions between them:<ul><li>Software enters VMX operation by executing a VMXON instruction.<li>Using VM entries, a VMM can turn guests into VMs (one at a time). The VMM affects a VM entry using instructions VMLAUNCH and VMRESUME; it regains control using VM exits.<li>VM exits transfer control to an entry point specified by the VMM. The VMM can take action appropriate to the cause of the VM exit and then return to the VM using a VM entry.<li>Eventually, the VMM may decide to shut itself down and leave VMX operation. It does so by executing the VMXOFF instruction.</ul></ul><p>That’s enough for now!</p><h2 id="related-work"><span class="mr-2"><strong>Related Work</strong></span><a href="#related-work" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Other hypervisor-related works and materials.</p><p>Awesome virtualization (Introducing books, papers, projects, courses, CVEs, and other hypervisor hypervisor-related works) - <a href="https://github.com/Wenzel/awesome-virtualization"></a><a href="https://github.com/Wenzel/awesome-virtualization">https://github.com/Wenzel/awesome-virtualization</a></p><p>7 Days to Virtualization: A Series on Hypervisor Development - (<a href="https://revers.engineering/7-days-to-virtualization-a-series-on-hypervisor-development/">https://revers.engineering/7-days-to-virtualization-a-series-on-hypervisor-development/</a>)</p><p>At last, if you want to use hypervisors for debugging, researching, or reverse-engineering, you can use <a href="https://hyperdbg.org">HyperDbg Debugger</a>, as many innovative methods based on hypervisors are implemented in this debugger that will help you in your reversing journey.</p><h2 id="conclusion"><span class="mr-2"><strong>Conclusion</strong></span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this part, we study general keywords we should be aware of and create a simple testing environment for our future tests. In the next part, I will explain how to enable VMX on your machine using the driver we made above. Then we survey the rest of the virtualization, so see you in the next part.</p><p>The second part is also available <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-2/">here</a>.</p><h2 id="references"><span class="mr-2"><strong>References</strong></span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>[1] Intel® 64 and IA-32 architectures software developer’s manual combined volumes 3 (<a href="https://software.intel.com/en-us/articles/intel-sdm">https://software.intel.com/en-us/articles/intel-sdm</a>)</p><p>[2] Hardware-assisted Virtualization (<a href="http://www.cs.cmu.edu/~412/lectures/L04_VTx.pdf">http://www.cs.cmu.edu/~412/lectures/L04_VTx.pdf</a>)</p><p>[3] Writing Windows Kernel Driver (<a href="https://resources.infosecinstitute.com/writing-a-windows-kernel-driver/">https://resources.infosecinstitute.com/writing-a-windows-kernel-driver/</a>)</p><p>[4] What Is a Type 1 Hypervisor? – (<a href="http://www.virtualizationsoftware.com/type-1-hypervisors/">http://www.virtualizationsoftware.com/type-1-hypervisors/</a>)</p><p>[5] Intel / AMD CPU Internals – (<a href="https://github.com/LordNoteworthy/cpu-internals">https://github.com/LordNoteworthy/cpu-internals</a>)</p><p>[6] Windows 10: Disable Signed Driver Enforcement – (<a href="https://ph.answers.acer.com/app/answers/detail/a_id/38288/~/windows-10%3A-disable-signed-driver-enforcement">https://ph.answers.acer.com/app/answers/detail/a_id/38288/~/windows-10%3A-disable-signed-driver-enforcement</a>)</p><p>[7] Instruction Set Mapping » VMX Instructions – (<a href="https://docs.oracle.com/cd/E36784_01/html/E36859/gntbx.html">https://docs.oracle.com/cd/E36784_01/html/E36859/gntbx.html</a>)</p><p>[8] HyperDbg Documentation – (<a href="https://docs.hyperdbg.org">https://docs.hyperdbg.org</a>)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cpu/'>cpu</a>, <a href='/categories/hypervisor/'>hypervisor</a>, <a href='/categories/tutorials/'>tutorials</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hypervisor/" class="post-tag no-text-decoration" >hypervisor</a> <a href="/tags/hypervisor-tutorial/" class="post-tag no-text-decoration" >hypervisor-tutorial</a> <a href="/tags/vmx-tutorial/" class="post-tag no-text-decoration" >VMX-tutorial</a> <a href="/tags/create-a-virtual-machine/" class="post-tag no-text-decoration" >create-a-virtual-machine</a> <a href="/tags/how-to-create-virtual-machine/" class="post-tag no-text-decoration" >how-to-create-virtual-machine</a> <a href="/tags/hypervisor-fundamentals/" class="post-tag no-text-decoration" >hypervisor-fundamentals</a> <a href="/tags/hypervisor-tutorials/" class="post-tag no-text-decoration" >hypervisor-tutorials</a> <a href="/tags/intel-virtualization/" class="post-tag no-text-decoration" >intel-virtualization</a> <a href="/tags/intel-vmx/" class="post-tag no-text-decoration" >intel-vmx</a> <a href="/tags/intel-vtx-tutorial/" class="post-tag no-text-decoration" >intel-vtx-tutorial</a> <a href="/tags/using-cpu-virtualization/" class="post-tag no-text-decoration" >using-cpu-virtualization</a> <a href="/tags/vmm-implementation/" class="post-tag no-text-decoration" >vmm-implementation</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hypervisor From Scratch - Part 1: Basic Concepts &amp; Configure Testing Environment - Rayanfam Blog&amp;url=https://rayanfam.com/topics/hypervisor-from-scratch-part-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hypervisor From Scratch - Part 1: Basic Concepts &amp; Configure Testing Environment - Rayanfam Blog&amp;u=https://rayanfam.com/topics/hypervisor-from-scratch-part-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/hypervisor-from-scratch-part-1/&amp;text=Hypervisor From Scratch - Part 1: Basic Concepts &amp; Configure Testing Environment - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/hypervisor-from-scratch-part-2/"><div class="card-body"> <em class="timeago small" data-ts="1535932800" > 2018-09-03 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 2: Entering VMX Operation</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-5/"><div class="card-body"> <em class="timeago small" data-ts="1544918400" > 2018-12-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-6/"><div class="card-body"> <em class="timeago small" data-ts="1551052800" > 2019-02-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/inline-assembly-in-x64/" class="btn btn-outline-primary" prompt="Older"><p>x64 Inline Assembly in Windows Driver Kit</p></a> <a href="/topics/mount-in-linux/" class="btn btn-outline-primary" prompt="Newer"><p>A Tour of Mount in Linux</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/hypervisor-from-scratch-part-1/'; this.page.identifier = '/topics/hypervisor-from-scratch-part-1/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
