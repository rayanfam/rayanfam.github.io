<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hypervisor From Scratch – Part 2: Entering VMX Operation" /><meta name="author" content="Sina Karvandi" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/hypervisor-from-scratch-part-2/" /><meta property="og:url" content="https://rayanfam.com/topics/hypervisor-from-scratch-part-2/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-09-03T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hypervisor From Scratch – Part 2: Entering VMX Operation" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Sina Karvandi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sina Karvandi"},"dateModified":"2024-12-13T14:16:09+00:00","datePublished":"2018-09-03T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Hypervisor From Scratch – Part 2: Entering VMX Operation","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/hypervisor-from-scratch-part-2/"},"url":"https://rayanfam.com/topics/hypervisor-from-scratch-part-2/"}</script><title>Hypervisor From Scratch – Part 2: Entering VMX Operation | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hypervisor From Scratch – Part 2: Entering VMX Operation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hypervisor From Scratch – Part 2: Entering VMX Operation</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Intel80x86">Sina Karvandi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1535932800" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-09-03 </em> </span> <span> Updated <em class="timeago" data-ts="1734099369" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-12-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2838 words"> <em>15 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/hypervisor-from-scratch-2-cover.png" alt="" data-proofer-ignore></p><p><strong>If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out <a href="https://github.com/HyperDbg/HyperDbg">HyperDbg</a> Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and reversing applications. A free and comprehensive tutorial on hypervisor-based reverse engineering is available at <a href="https://ost2.fyi/dbg3301">OpenSecurityTraining2’s website</a> (<em>preferred</em>) and <a href="https://www.youtube.com/playlist?list=PLUFkSN0XLZ-kF1f143wlw8ujlH2A45nZY">YouTube</a>, which demonstrates numerous practical examples on how to utilize hypervisors for reverse engineering.</strong></p><h2 id="introduction"><span class="mr-2"><strong>Introduction</strong></span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>It’s the second part of a multiple series of a tutorial called “<strong>Hypervisor From Scratch</strong>”. First, please consider reading the <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-1/">first part</a> (Basic Concepts &amp; Configure Testing Environment) before reading this part, as it contains the essential knowledge you need to know in order to understand the rest of this tutorial. In this part, we’ll talk about WDK drivers and finally start enabling VT-x.</p><h2 id="table-of-contents"><span class="mr-2"><strong>Table of Contents</strong></span><a href="#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>Introduction</strong><li><strong>Table of Contents</strong><li><strong>Overview</strong><li><strong>IRP Major Functions</strong><ul><li>What is an IRP?<li>Configuring IRP Major Functions<li>IRP Major Functions List</ul><li><strong>Loading Driver and Checking Device</strong><li><strong>Viewing Debugging Messages In DbgView</strong><li><strong>Detecting Hypervisor Support</strong><ul><li>Setting CR4 VMXE Bit</ul><li><strong>Conclusion</strong><li><strong>References</strong></ul><h2 id="overview"><span class="mr-2"><strong>Overview</strong></span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this section, we will learn about <strong>Detecting Hypervisor Support</strong> for our processor, then we simply config the basic operations to <strong>Enable VMX</strong>, <strong>Entering VMX Operation</strong>, and we will learn more about <strong>Window Driver Kit (WDK)</strong>.</p><p>The source code of this tutorial is available at :</p><p>[<a href="https://github.com/SinaKarvandi/Hypervisor-From-Scratch/">https://github.com/SinaKarvandi/Hypervisor-From-Scratch/</a>]</p><h2 id="irp-major-functions"><span class="mr-2"><strong>IRP Major Functions</strong></span><a href="#irp-major-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Besides our kernel-mode driver (“<strong>MyHypervisorDriver</strong>”), we’ll create a user-mode application called “<strong>MyHypervisorApp</strong>”. First of all, I should encourage you to write most of the codes (whenever it’s possible) in user-mode rather than the kernel-mode, and that’s because you might not have handled exceptions properly. Hence, it leads to BSODs, or on the other hand, running less code in kernel-mode reduces the possibility of putting some nasty kernel-mode bugs.</p><p>If you remember from the <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-1/">previous part</a>, we created a Windows driver. Now we want to extend our project to support more IRP Major functions.</p><p>IRP Major Functions are located in a conventional Windows table created for every device. Once we register a device in Windows, we have to introduce a handler for these IRP Major Functions.</p><p>That’s like every device has a table of Major Functions. Whenever a user-mode application calls any of these functions, Windows finds the corresponding function (if the device driver supports that MJ Function), then passes an IRP to the kernel driver.</p><h3 id="what-is-an-irp"><span class="mr-2"><strong>What is an IRP?</strong></span><a href="#what-is-an-irp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>So, what is an <strong>IRP</strong>? IRP is a structure that represents an I/O Request Packet. This packet contains many details about its caller, parameters, state of the packet, etc. We extract the caller parameters from the IRP packet.</p><p>Now, we can handle the user-mode request in the kernel based on the details provided by IRP.</p><p>Remember, when our functions in the kernel driver receive the IRP packet, it’s the responsibility of our code to investigate the caller and check its privileges, etc.</p><h3 id="configuring-irp-major-functions"><span class="mr-2"><strong>Configuring IRP Major Functions</strong></span><a href="#configuring-irp-major-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>After registering a device (explained in the previous part), we need to introduce the Major Functions of our device.</p><p>The following code is responsible for configuring different IRP MJ Functions and introducing custom kernel-mode functions as the IRP handlers.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">NtStatus</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">Index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">Index</span> <span class="o">&lt;</span> <span class="n">IRP_MJ_MAXIMUM_FUNCTION</span><span class="p">;</span> <span class="n">Index</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">Index</span><span class="p">]</span> <span class="o">=</span> <span class="n">DrvUnsupported</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] Setting Devices major functions."</span><span class="p">);</span>
        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_CLOSE</span><span class="p">]</span>          <span class="o">=</span> <span class="n">DrvClose</span><span class="p">;</span>
        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_CREATE</span><span class="p">]</span>         <span class="o">=</span> <span class="n">DrvCreate</span><span class="p">;</span>
        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_DEVICE_CONTROL</span><span class="p">]</span> <span class="o">=</span> <span class="n">DrvIoctlDispatcher</span><span class="p">;</span>

        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_READ</span><span class="p">]</span>  <span class="o">=</span> <span class="n">DrvRead</span><span class="p">;</span>
        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_WRITE</span><span class="p">]</span> <span class="o">=</span> <span class="n">DrvWrite</span><span class="p">;</span>

        <span class="n">DriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DrvUnload</span><span class="p">;</span>

        <span class="n">IoCreateSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DosDeviceName</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DriverName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] There were some errors in creating device."</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>You can see that we used “<strong>DrvUnsupported</strong>” for all functions. This function handles all MJ Functions and tells the user that it’s not supported.</p><p>The main body of “<strong>DrvUnsupported</strong>” is like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span>
<span class="nf">DrvUnsupported</span><span class="p">(</span><span class="n">IN</span> <span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] This function is not supported :( !"</span><span class="p">);</span>

    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span>      <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We also introduce other Major Functions that are essential for our device. We’ll complete the implementation of some of these MJ Functions in the future parts.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span>
<span class="nf">DrvRead</span><span class="p">(</span><span class="n">IN</span> <span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] Not implemented yet :( !"</span><span class="p">);</span>

    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span>      <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span>
<span class="nf">DrvWrite</span><span class="p">(</span><span class="n">IN</span> <span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] Not implemented yet :( !"</span><span class="p">);</span>

    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span>      <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">NTSTATUS</span>
<span class="nf">DrvClose</span><span class="p">(</span><span class="n">IN</span> <span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] Not implemented yet :( !"</span><span class="p">);</span>

    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span>      <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Now let’s see the IRP MJ Functions list and other types of Windows Driver Kit handlers routine.</p><p><img data-src="../../assets/images/anime-girl-white.png" alt="" data-proofer-ignore></p><h3 id="irp-major-functions-list"><span class="mr-2"><strong>IRP Major Functions List</strong></span><a href="#irp-major-functions-list" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>We can use this list of IRP Major Functions to perform different operations in a WDK driver.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="cp">#define IRP_MJ_CREATE                   0x00
#define IRP_MJ_CREATE_NAMED_PIPE        0x01
#define IRP_MJ_CLOSE                    0x02
#define IRP_MJ_READ                     0x03
#define IRP_MJ_WRITE                    0x04
#define IRP_MJ_QUERY_INFORMATION        0x05
#define IRP_MJ_SET_INFORMATION          0x06
#define IRP_MJ_QUERY_EA                 0x07
#define IRP_MJ_SET_EA                   0x08
#define IRP_MJ_FLUSH_BUFFERS            0x09
#define IRP_MJ_QUERY_VOLUME_INFORMATION 0x0a
#define IRP_MJ_SET_VOLUME_INFORMATION   0x0b
#define IRP_MJ_DIRECTORY_CONTROL        0x0c
#define IRP_MJ_FILE_SYSTEM_CONTROL      0x0d
#define IRP_MJ_DEVICE_CONTROL           0x0e
#define IRP_MJ_INTERNAL_DEVICE_CONTROL  0x0f
#define IRP_MJ_SHUTDOWN                 0x10
#define IRP_MJ_LOCK_CONTROL             0x11
#define IRP_MJ_CLEANUP                  0x12
#define IRP_MJ_CREATE_MAILSLOT          0x13
#define IRP_MJ_QUERY_SECURITY           0x14
#define IRP_MJ_SET_SECURITY             0x15
#define IRP_MJ_POWER                    0x16
#define IRP_MJ_SYSTEM_CONTROL           0x17
#define IRP_MJ_DEVICE_CHANGE            0x18
#define IRP_MJ_QUERY_QUOTA              0x19
#define IRP_MJ_SET_QUOTA                0x1a
#define IRP_MJ_PNP                      0x1b
#define IRP_MJ_PNP_POWER                IRP_MJ_PNP // Obsolete....
#define IRP_MJ_MAXIMUM_FUNCTION         0x1b
</span></pre></table></code></div></div><p>Every major function will only trigger if we call its corresponding function from the user-mode. For instance, there is a function (in user-mode) called <strong>CreateFile</strong> (And all its variants like <strong>CreateFileA</strong> and <strong>CreateFileW</strong> for <strong>ASCII</strong> and <strong>Unicode</strong>), so every time we call <strong>CreateFile</strong>, the function that registered as <strong>IRP_MJ_CREATE</strong> will be called, if we call <strong>ReadFile</strong> then <strong>IRP_MJ_READ</strong>, or <strong>WriteFile</strong> then <strong>IRP_MJ_WRITE </strong> will be triggered.</p><p>You can see that Windows treats its devices like files, and everything we need to pass from user-mode to kernel-mode is available in an argument with the <code class="language-c highlighter-rouge"><span class="n">IRP</span> <span class="o">*</span></code> type and available as a buffer to the kernel IRP MJ Function handlers. Windows is responsible for copying the user-mode buffer to the kernel mode stack.</p><p>Don’t worry; we use it frequently in the rest of the project, but we only support <strong>IRP_MJ_CREATE</strong> in this part and left others unimplemented for future parts.</p><p>There are other terms called “IRP Minor Functions”. We left these functionalities as they’re not used in this series.</p><h2 id="loading-driver-and-checking-device"><span class="mr-2"><strong>Loading Driver and Checking Device</strong></span><a href="#loading-driver-and-checking-device" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In order to load our driver (<strong>MyHypervisorDriver</strong>), first, download <strong>OSR Driver Loader</strong>, then run <strong>Sysinternals DbgView</strong> as administrator. Ensure that your DbgView captures the kernel (you can check by going to <code class="language-c highlighter-rouge"><span class="n">Capture</span> <span class="o">-&gt;</span> <span class="n">Capture</span> <span class="n">Kernel</span></code>).</p><p><img data-src="../../assets/images/capture-kernel.png" alt="Enable Capturing Event" data-proofer-ignore></p><p>After that open the OSR Driver Loader (go to <code class="language-c highlighter-rouge"><span class="n">OsrLoader</span> <span class="o">-&gt;</span> <span class="n">kit</span><span class="o">-&gt;</span> <span class="n">WNET</span> <span class="o">-&gt;</span> <span class="n">AMD64</span> <span class="o">-&gt;</span> <span class="n">FRE</span></code>) and open <strong>OSRLOADER.exe</strong>. Now, if you build your driver, find the <strong>.sys</strong> file (in <code class="language-c highlighter-rouge"><span class="n">MyHypervisorDriver</span><span class="err">\</span><span class="n">x64</span><span class="err">\</span><span class="n">Debug</span><span class="err">\</span></code> should be a file named: “<strong>MyHypervisorDriver.sys</strong>”), in OSR Driver Loader, click to browse and select (MyHypervisorDriver.sys) and then click to “<strong>Register Service</strong>” after that, you see a message box that shows your driver registered successfully, you should click on “<strong>Start Service</strong>”.</p><p>Please note that you should have <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/download-the-wdk">WDK</a> installed for your Visual Studio in order to be able to build your project.</p><p><img data-src="../../assets/images/osr-driver-loader-gui.png" alt="Load Driver in OSR Driver Loader" data-proofer-ignore></p><p>Now come back to the DbgView, you should see that your driver loaded successfully, and a message “<strong>[*] DriverEntry Called.</strong>” should appear.</p><p>If there is no problem, then you’re good to go. Otherwise, you can check the next step if you have a problem with DbgView.</p><p>Keep in mind that now we have registered our driver, so we can use <strong>SysInternals WinObj</strong> to see whether “<strong>MyHypervisorDevice</strong>” is available or not.</p><p><img data-src="../../assets/images/winobj-devices.png" alt="WinObj" data-proofer-ignore></p><h2 id="viewing-debugging-messages-in-dbgview"><span class="mr-2"><strong>Viewing Debugging Messages In DbgView</strong></span><a href="#viewing-debugging-messages-in-dbgview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Unfortunately, for some unknown reason, I’m unable to view the result of <code class="language-c highlighter-rouge"><span class="n">DbgPrint</span><span class="p">()</span></code>. If you can see the result, then you can skip this step but if you have a problem, perform the following steps:</p><p>As I mentioned in <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-1/">part 1</a>:</p><p>Save the following content as <code class="language-c highlighter-rouge"><span class="n">dbgview</span><span class="p">.</span><span class="n">reg</span></code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">Windows</span> <span class="n">Registry</span> <span class="n">Editor</span> <span class="n">Version</span> <span class="mi">5</span><span class="p">.</span><span class="mo">00</span>

<span class="p">[</span><span class="n">HKEY_LOCAL_MACHINE</span><span class="err">\</span><span class="n">SYSTEM</span><span class="err">\</span><span class="n">CurrentControlSet</span><span class="err">\</span><span class="n">Control</span><span class="err">\</span><span class="n">Session</span> <span class="n">Manager</span><span class="err">\</span><span class="n">Debug</span> <span class="n">Print</span> <span class="n">Filter</span><span class="p">]</span>
<span class="s">"DEFAULT"</span><span class="o">=</span><span class="n">dword</span><span class="o">:</span><span class="mo">0000000</span><span class="n">f</span>
</pre></table></code></div></div><p>Double-click on <code class="language-c highlighter-rouge"><span class="n">dbgview</span><span class="p">.</span><span class="n">reg</span></code>. Reboot the machine, and it’s good to go.</p><p>This method should solve the problem, but if the problem still persists, we have another option. For this purpose, we can use WinDbg to find a Windows Kernel global variable called <code class="language-c highlighter-rouge"><span class="n">nt</span><span class="o">!</span><span class="n">Kd</span><span class="err">\</span><span class="n">_DEFAULT</span><span class="err">\</span><span class="n">_Mask</span></code>. This variable is responsible for showing the results in DbgView. It has a mask that I’m not aware of, so I just put a <code class="language-c highlighter-rouge"><span class="mh">0xffffffff</span></code> into it to simply make it show everything!</p><p>To do this, you need a Windows Kernel Debugging using WinDbg. In WinDbg, you can run the following command:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">eb</span> <span class="n">nt</span><span class="o">!</span><span class="n">kd_Default_Mask</span> <span class="n">ff</span> <span class="n">ff</span> <span class="n">ff</span> <span class="n">ff</span>
</pre></table></code></div></div><p><img data-src="../../assets/images/kd-DEFAULT-Mask.png" alt="kd_DEFAULT_Mask" data-proofer-ignore></p><p>After that, we should see the results and everything we’ll be ready for the next step.</p><p>Remember, this is an essential step for the rest of the topic because if we can’t see any kernel messages, sure, we can’t debug it too.</p><p><img data-src="../../assets/images/osrdriverloader-dbgview.png" alt="DbgView" data-proofer-ignore></p><h2 id="detecting-hypervisor-support"><span class="mr-2"><strong>Detecting Hypervisor Support</strong></span><a href="#detecting-hypervisor-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Discovering support for <strong>VMX</strong> is the first thing we should consider before enabling <strong>VT-x</strong>. This is covered in <strong>Intel Software Developer’s Manual volume 3C</strong> section <strong>23.6 DISCOVERING SUPPORT FOR VMX</strong>.</p><p>You could know the presence of VMX using <strong>CPUID</strong> if <strong>CPUID.1:ECX.VMX[bit 5] = 1</strong>, then VMX operation is supported.</p><p>First, we need to know whether or not we’re running on an Intel-based processor. We can understand this using the <code class="language-c highlighter-rouge"><span class="n">CPUID</span></code> instruction and finding the vendor string “<strong>GenuineIntel</strong>”.</p><p>The following function returns the vendor string by using the <code class="language-c highlighter-rouge"><span class="n">CPUID</span></code> instruction.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">string</span>
<span class="nf">GetCpuID</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// Initialize used variables</span>
    <span class="kt">char</span>   <span class="n">SysType</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span> <span class="c1">// Array consisting of 13 single bytes/characters</span>
    <span class="n">string</span> <span class="n">CpuID</span><span class="p">;</span>       <span class="c1">// The string that will be used to add all the characters to</span>
                        <span class="c1">// Starting coding in assembly language</span>
    <span class="n">_asm</span>
        <span class="p">{</span>
            <span class="c1">// Execute CPUID with EAX = 0 to get the CPU producer</span>
		<span class="n">XOR</span> <span class="n">EAX</span><span class="p">,</span> <span class="n">EAX</span>
		<span class="n">CPUID</span>
                    <span class="c1">// MOV EBX to EAX and get the characters one by one by using shift out right bitwise operation.</span>
		<span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span> <span class="n">EBX</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AL</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">AH</span>
		<span class="n">SHR</span> <span class="n">EAX</span><span class="p">,</span> <span class="mi">16</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">AL</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">AH</span>
                <span class="c1">// Get the second part the same way but these values are stored in EDX</span>
		<span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span> <span class="n">EDX</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">AL</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">AH</span>
		<span class="n">SHR</span> <span class="n">EAX</span><span class="p">,</span> <span class="mi">16</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">AL</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">AH</span>
                <span class="c1">// Get the third part</span>
		<span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span> <span class="n">ECX</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">AL</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">AH</span>
		<span class="n">SHR</span> <span class="n">EAX</span><span class="p">,</span> <span class="mi">16</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">AL</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">AH</span>
		<span class="n">MOV</span> <span class="n">SysType</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="mo">00</span>
        <span class="p">}</span>
    <span class="n">CpuID</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">SysType</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">CpuID</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The last step is checking for the presence of <strong>VMX</strong>. We can check it using the following code :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">bool</span>
<span class="nf">DetectVmxSupport</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">bool</span> <span class="n">VMX</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="kr">__asm</span> <span class="p">{</span>
		<span class="n">XOR</span>    <span class="n">EAX</span><span class="p">,</span> <span class="n">EAX</span>
		<span class="n">INC</span>    <span class="n">EAX</span>
		<span class="n">CPUID</span>
		<span class="n">BT</span>     <span class="n">ECX</span><span class="p">,</span> <span class="mh">0x5</span>
		<span class="n">JC</span>     <span class="n">VMXSupport</span>
		<span class="n">VMXNotSupport</span> <span class="o">:</span>
		<span class="n">JMP</span>     <span class="n">NopInstr</span>
		<span class="n">VMXSupport</span> <span class="o">:</span>
		<span class="n">MOV</span>    <span class="n">VMX</span><span class="p">,</span> <span class="mh">0x1</span>
		<span class="n">NopInstr</span> <span class="o">:</span>
		<span class="n">NOP</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">VMX</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>As you can see, it checks <code class="language-c highlighter-rouge"><span class="n">CPUID</span></code> with <code class="language-c highlighter-rouge"><span class="n">EAX</span><span class="o">=</span><span class="mi">1</span></code>, and if the 5th (6th) bit is one, then the VMX Operation is supported. We can also perform the same thing in Kernel Driver.</p><p>All in all, our main code to detect the support for VMX should be something like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre><td class="rouge-code"><pre><span class="kt">int</span>
<span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CpuId</span><span class="p">;</span>

    <span class="n">PrintAppearance</span><span class="p">();</span>

    <span class="n">CpuId</span> <span class="o">=</span> <span class="n">GetCpuID</span><span class="p">();</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"[*] The CPU Vendor is : %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">CpuID</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">CpuId</span> <span class="o">==</span> <span class="s">"GenuineIntel"</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[*] The Processor virtualization technology is VT-x. </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[*] This program is not designed to run in a non-VT-x environment !</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">DetectVmxSupport</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[*] VMX Operation is supported by your processor .</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"[*] VMX Operation is not supported by your processor .</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">HANDLE</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">L"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">MyHypervisorDevice"</span><span class="p">,</span>
                             <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
                             <span class="n">FILE_SHARE_READ</span> <span class="o">|</span>
                                 <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span>
                             <span class="nb">NULL</span><span class="p">,</span> <span class="c1">/// lpSecurityAttirbutes</span>
                             <span class="n">OPEN_EXISTING</span><span class="p">,</span>
                             <span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span>
                                 <span class="n">FILE_FLAG_OVERLAPPED</span><span class="p">,</span>
                             <span class="nb">NULL</span><span class="p">);</span> <span class="c1">/// lpTemplateFile</span>

    <span class="n">_getch</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The final result:</p><p><img data-src="../../assets/images/vmx-detection.png" alt="User-mode app" data-proofer-ignore></p><h2 id="enabling-vmx-operation"><span class="mr-2"><strong>Enabling VMX Operation</strong></span><a href="#enabling-vmx-operation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If the processor supports the VMX Operation, it’s time to enable it. As I told you above, <strong>IRP_MJ_CREATE</strong> is the first function that should be used to start the operation.</p><p>Before entering the VMX operation, we should enable VMX by setting CR4.VMXE[bit 13] = 1. VMX operation is then entered by executing the VMXON instruction. VMXON causes an invalid-opcode exception (#UD) if executed with CR4.VMXE = 0. Once in VMX operation, it is not possible to clear CR4.VMXE.</p><p>After that, we can leave the VMX operation by executing the VMXOFF instruction and, this time, CR4.VMXE can be cleared.</p><p>VMXON is also controlled by the IA32_FEATURE_CONTROL MSR (MSR address 3AH). This MSR is cleared to zero when a logical processor is reset.</p><p>Let’s look at the first bit of this MSR:</p><ul><li> Bit 0 is the lock bit. If this bit is clear, VMXON causes a general-protection (#GP) exception. If the lock bit is set, WRMSR to this MSR causes a general-protection exception; the MSR cannot be modified until a power-up reset.</ul><p>What does it mean? It means that we can disable the VMX feature without the ability to be enabled again. Only after a system reset, we can enable the VMX.</p><p>System BIOS can use this bit to provide a setup option for BIOS to disable support for VMX. To enable VMX support in a platform, BIOS must set bit 1, bit 2, or both, as well as the lock bit.</p><h3 id="setting-cr4-vmxe-bit"><span class="mr-2"><strong>Setting CR4 VMXE Bit</strong></span><a href="#setting-cr4-vmxe-bit" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Do you remember the previous part where I told you how to <a href="https://rayanfam.com/topics/inline-assembly-in-x64/">create an inline assembly in Windows Driver Kit (x64)</a>? </p><p>Now we should create some function to perform this operation in assembly.</p><p>Just in Header File (in my case <strong>Source.h</strong>) declare your function:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">extern</span> <span class="kt">void</span> <span class="kr">inline</span> <span class="nf">AsmEnableVmxOperation</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></table></code></div></div><p>Then in the assembly file (in my case, “SourceAsm.asm”), add this function (Which sets the 13th (14th) bit of CR4).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">AsmEnableVmxOperation</span> <span class="n">PROC</span> <span class="n">PUBLIC</span>

	<span class="n">PUSH</span> <span class="n">RAX</span>			    <span class="p">;</span> <span class="n">Save</span> <span class="n">the</span> <span class="n">state</span>
	
	<span class="n">XOR</span> <span class="n">RAX</span><span class="p">,</span> <span class="n">RAX</span>			<span class="p">;</span> <span class="n">Clear</span> <span class="n">the</span> <span class="n">RAX</span>
	<span class="n">MOV</span> <span class="n">RAX</span><span class="p">,</span> <span class="n">CR4</span>

	<span class="n">OR</span> <span class="n">RAX</span><span class="p">,</span><span class="mo">02000</span><span class="n">h</span>	    	<span class="p">;</span> <span class="n">Set</span> <span class="n">the</span> <span class="mi">14</span><span class="n">th</span> <span class="n">bit</span>
	<span class="n">MOV</span> <span class="n">CR4</span><span class="p">,</span> <span class="n">RAX</span>
	
	<span class="n">POP</span> <span class="n">RAX</span>			     	<span class="p">;</span> <span class="n">Restore</span> <span class="n">the</span> <span class="n">state</span>
	<span class="n">RET</span>

<span class="n">AsmEnableVmxOperation</span> <span class="n">ENDP</span>
</pre></table></code></div></div><p>Also, declare your function in the above of SourceAsm.asm.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PUBLIC</span> <span class="n">AsmEnableVmxOperation</span>
</pre></table></code></div></div><p>This assembly function should be called in <strong>DrvCreate</strong>:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span>
<span class="nf">DrvCreate</span><span class="p">(</span><span class="n">IN</span> <span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">IN</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//</span>
    <span class="c1">// Enabling VMX Operation</span>
    <span class="c1">//</span>
    <span class="n">AsmEnableVmxOperation</span><span class="p">();</span>
    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] VMX Operation Enabled Successfully !"</span><span class="p">);</span>

    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span>      <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
    <span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>At last, we should call the following function from the user-mode:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>    <span class="n">HANDLE</span> <span class="n">hWnd</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">(</span><span class="s">L"</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">MyHypervisorDevice"</span><span class="p">,</span>
                             <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
                             <span class="n">FILE_SHARE_READ</span> <span class="o">|</span>
                                 <span class="n">FILE_SHARE_WRITE</span><span class="p">,</span>
                             <span class="nb">NULL</span><span class="p">,</span> <span class="c1">/// lpSecurityAttirbutes</span>
                             <span class="n">OPEN_EXISTING</span><span class="p">,</span>
                             <span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span>
                                 <span class="n">FILE_FLAG_OVERLAPPED</span><span class="p">,</span>
                             <span class="nb">NULL</span><span class="p">);</span> <span class="c1">/// lpTemplateFile</span>
</pre></table></code></div></div><p>If you see the following result, you successfully completed the second part.</p><p><img data-src="../../assets/images/hypervisor-loaded.png" alt="Final Show" data-proofer-ignore></p><p><strong>Important Note:</strong> Please consider that your <strong>.asm</strong> file should have a different name from your main driver file (<strong>.c</strong> file). For example, if your driver file is “Source.c”, then using the name “Source.asm” causes weird linking errors in Visual Studio. You should change the name of your <strong>.asm</strong> file to something like “SourceAsm.asm” to avoid these linker errors.</p><h2 id="conclusion"><span class="mr-2"><strong>Conclusion</strong></span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this part, we learned about the basic stuff we need to know to create a Windows Driver Kit program, and then we entered our virtual environment to build a cornerstone for the rest of the parts.</p><p>In the third part, we’re getting deeper with Intel VT-x and making our driver even more advanced.</p><p>Note: Remember that hypervisors change over time because new features are added to the operating systems or new technologies are used. For example, updates to Meltdown &amp; Spectre have made a lot of changes to the hypervisors. So, if you want to use Hypervisor From Scratch in your projects, research, or whatever, you should use the <a href="https://github.com/HyperDbg/HyperDbg"><strong>HyperDbg</strong></a> drivers. <strong>HyperDbg</strong> is actively maintained, stable, and reliable, ensuring you avoid the errors and instability problems that can arise from using older parts of the tutorial series.</p><p>The third part is also available [here].(https://rayanfam.com/topics/hypervisor-from-scratch-part-3/).</p><p><img data-src="../../assets/images/aninme-girl-watching-monitor.jpg" alt="" data-proofer-ignore></p><h2 id="references"><span class="mr-2"><strong>References</strong></span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>[1] Intel® 64 and IA-32 architectures software developer’s manual combined volumes 3 (<a href="https://software.intel.com/en-us/articles/intel-sdm">https://software.intel.com/en-us/articles/intel-sdm</a>) </p><p>[2] IRP_MJ_DEVICE_CONTROL (<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control">https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/irp-mj-device-control</a>)</p><p>[3]  Windows Driver Kit Samples (<a href="https://github.com/Microsoft/Windows-driver-samples/blob/master/general/ioctl/wdm/sys/sioctl.c">https://github.com/Microsoft/Windows-driver-samples/blob/master/general/ioctl/wdm/sys/sioctl.c</a>)</p><p>[4] Setting Up Local Kernel Debugging of a Single Computer Manually (<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-local-kernel-debugging-of-a-single-computer-manually">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/setting-up-local-kernel-debugging-of-a-single-computer-manually</a>)</p><p>[5] Obtain processor manufacturer using CPUID (<a href="https://www.daniweb.com/programming/software-development/threads/112968/obtain-processor-manufacturer-using-cpuid">https://www.daniweb.com/programming/software-development/threads/112968/obtain-processor-manufacturer-using-cpuid</a>)</p><p>[6] Plug and Play Minor IRPs (<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/plug-and-play-minor-irps">https://docs.microsoft.com/en-us/windows-hardware/drivers/kernel/plug-and-play-minor-irps</a>)</p><p>[7] _FAST_IO_DISPATCH structure (<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/ns-wdm-_fast_io_dispatch">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/ns-wdm-_fast_io_dispatch</a>)</p><p>[8] Filtering IRPs and Fast I/O (<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filtering-irps-and-fast-i-o">https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/filtering-irps-and-fast-i-o</a>)</p><p>[9] Windows File System Filter Driver Development (<a href="https://www.apriorit.com/dev-blog/167-file-system-filter-driver">https://www.apriorit.com/dev-blog/167-file-system-filter-driver</a>)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cpu/'>cpu</a>, <a href='/categories/hypervisor/'>hypervisor</a>, <a href='/categories/tutorials/'>tutorials</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hypervisor/" class="post-tag no-text-decoration" >hypervisor</a> <a href="/tags/hypervisor-tutorial/" class="post-tag no-text-decoration" >hypervisor-tutorial</a> <a href="/tags/creating-virtual-machine/" class="post-tag no-text-decoration" >creating-virtual-machine</a> <a href="/tags/hypervisor-tutorials/" class="post-tag no-text-decoration" >hypervisor-tutorials</a> <a href="/tags/intel-vt-x-tutorial/" class="post-tag no-text-decoration" >intel-vt-x-tutorial</a> <a href="/tags/setting-up-virtual-machine-monitor/" class="post-tag no-text-decoration" >setting-up-virtual-machine-monitor</a> <a href="/tags/vmm-tutorials/" class="post-tag no-text-decoration" >vmm-tutorials</a> <a href="/tags/vmx-implementation/" class="post-tag no-text-decoration" >vmx-implementation</a> <a href="/tags/vmx-tutorials/" class="post-tag no-text-decoration" >vmx-tutorials</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hypervisor From Scratch – Part 2: Entering VMX Operation - Rayanfam Blog&amp;url=https://rayanfam.com/topics/hypervisor-from-scratch-part-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hypervisor From Scratch – Part 2: Entering VMX Operation - Rayanfam Blog&amp;u=https://rayanfam.com/topics/hypervisor-from-scratch-part-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/hypervisor-from-scratch-part-2/&amp;text=Hypervisor From Scratch – Part 2: Entering VMX Operation - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/hypervisor-from-scratch-part-1/"><div class="card-body"> <em class="timeago small" data-ts="1534809600" > 2018-08-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-5/"><div class="card-body"> <em class="timeago small" data-ts="1544918400" > 2018-12-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-6/"><div class="card-body"> <em class="timeago small" data-ts="1551052800" > 2019-02-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/mount-in-linux/" class="btn btn-outline-primary" prompt="Older"><p>A Tour of Mount in Linux</p></a> <a href="/topics/using-intels-streaming-simd-extensions-3-monitormwait-as-a-kernel-debugging-trick/" class="btn btn-outline-primary" prompt="Newer"><p>Using Intel's Streaming SIMD Extensions 3 (MONITOR MWAIT) As A Kernel Debugging Trick</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/hypervisor-from-scratch-part-2/'; this.page.identifier = '/topics/hypervisor-from-scratch-part-2/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
