<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Inside Windows Page Frame Number (PFN) – Part 2" /><meta name="author" content="Sina Karvandi" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/inside-windows-page-frame-number-part2/" /><meta property="og:url" content="https://rayanfam.com/topics/inside-windows-page-frame-number-part2/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-08-07T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Inside Windows Page Frame Number (PFN) – Part 2" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Sina Karvandi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sina Karvandi"},"dateModified":"2024-07-13T12:45:21+00:00","datePublished":"2018-08-07T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Inside Windows Page Frame Number (PFN) – Part 2","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/inside-windows-page-frame-number-part2/"},"url":"https://rayanfam.com/topics/inside-windows-page-frame-number-part2/"}</script><title>Inside Windows Page Frame Number (PFN) – Part 2 | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Inside Windows Page Frame Number (PFN) – Part 2</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Inside Windows Page Frame Number (PFN) – Part 2</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Intel80x86">Sina Karvandi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1533600000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-08-07 </em> </span> <span> Updated <em class="timeago" data-ts="1720874721" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-07-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1946 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/chameleon-2.jpeg" alt="" data-proofer-ignore></p><p>Hey there,</p><p>In the <a href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/">previous part</a>, I’d explained about Page Frame Number and its importance in the OSs architecture. In this part, I’ll trace PFN more practically. I strongly recommend to read the <a href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/">first part</a>, to make sure you didn’t miss anything about basic concepts.</p><p>As I described in the previous part, the PFN database is located at <strong>nt!MmPFNDatabase</strong>, in the previous versions of Windows (&lt;Windows 10) it was statically located at 0xFFFFFA8000000000 but in Windows 10, it’s subject to ASLR.</p><h1 id="converting-physical-address-to-virtual-address-and">Converting Physical Address to Virtual Address and </h1><h2 id="virtual-address-to-physical-address"><span class="mr-2">Virtual Address to Physical Address</span><a href="#virtual-address-to-physical-address" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><h2 id="mmgetvirtualforphysical-pa---va"><span class="mr-2">MmGetVirtualForPhysical (PA -&gt; VA)</span><a href="#mmgetvirtualforphysical-pa---va" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2></ul><p>One of the purposes of using PFN database is for converting physical address to virtual address but in Windows, you can simply call <strong>nt!MmGetVirtualForPhysical</strong> and convert your physical address to virtual address, you can see a complete list of Memory Manager Routines in <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff554435(v=vs.85).aspx">MSDN</a>.</p><p><img data-src="../../assets/images/MmGetVirtualForPhysical.png" alt="MmGetVirtualForPhysical" data-proofer-ignore></p><p>The <strong>MmGetVirtualForPhysical</strong> is the opposite of <strong>MmGetPhysicalAddress</strong> as it converts virtual address to physical address and MmXXX before every function in Windows kernel means it’s memory-management routine.</p><p>If we decompile this function using <strong>IDA Pro</strong>:</p><p><img data-src="../../assets/images/MmGetVirtualForPhysical-IDA.png" alt="MmGetVirtualForPhysical-IDA" data-proofer-ignore></p><p>So the source is simply like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">MmGetVirtualForPhysical</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int64</span> <span class="n">a1</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&amp;</span> <span class="mh">0xFFF</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)(</span><span class="mi">48</span> <span class="o">*</span> <span class="p">(</span><span class="n">a1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">-</span> <span class="mi">6047313952760</span><span class="n">i64</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="mmgetphysicaladdress-va---pa"><span class="mr-2">MmGetPhysicalAddress (VA -&gt; PA)</span><a href="#mmgetphysicaladdress-va---pa" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>This function is responsible for converting Virtual Address to Physical address and will eventually call <strong>MiGetPhysicalAddress</strong> so we keep investigating and if you decompile <strong>MiGetPhysicalAddress</strong> you’ll see some interesting function: <strong>nt!MiVaToPfn</strong>.</p><p><img data-src="../../assets/images/MmGetPhysicalAddress.png" alt="MiGetPhysicalAddress" data-proofer-ignore></p><p><strong>MiVaToPfn</strong>, as it seems, is used for converting the Virtual address to PFN.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">unsigned</span> <span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">MiVaToPfn</span><span class="p">(</span><span class="n">__int64</span> <span class="n">a1</span><span class="p">);</span>
</pre></table></code></div></div><p>Let’s track a special virtual address and find its corresponding PFN Record in PFN Database.</p><h2 id="tracking-pfn-records"><span class="mr-2">Tracking PFN Records</span><a href="#tracking-pfn-records" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>As I described in the first part, <strong>poi(nt!MmPfnDatabase)</strong>  can be used to get PFN Database Address:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="mi">0</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">?</span> <span class="n">poi</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">MmPfnDatabase</span><span class="p">)</span>
<span class="n">Evaluate</span> <span class="n">expression</span><span class="o">:</span> <span class="o">-</span><span class="mi">13194139533312</span> <span class="o">=</span> <span class="n">fffff400</span><span class="err">`</span><span class="mo">00000000</span>
</pre></table></code></div></div><p>Now, let choose a kernel location to see PFN Record e.g fffff80231612000 (the location where <strong>nt</strong> module is loaded). (If you want to find user-mode addresses then you should change your context (<strong>CR3</strong>) and perform the same thing based on your virtual address.)</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="mi">0</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="n">lm</span> <span class="n">m</span> <span class="n">nt</span>
<span class="n">Browse</span> <span class="n">full</span> <span class="n">module</span> <span class="n">list</span>
<span class="n">start</span>             <span class="n">end</span>                 <span class="n">module</span> <span class="n">name</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612000</span> <span class="n">fffff802</span><span class="err">`</span><span class="mf">31e9</span><span class="n">b000</span>   <span class="n">nt</span>         <span class="p">(</span><span class="n">pdb</span> <span class="n">symbols</span><span class="p">)</span>
</pre></table></code></div></div><p>I convert the fffff80231612000 to its corresponding physical address using <strong>!vtop 0 Address</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">vtop</span> <span class="mi">0</span> <span class="n">fffff80231612000</span>
<span class="n">Amd64VtoP</span><span class="o">:</span> <span class="n">Virt</span> <span class="n">fffff802</span><span class="err">`</span><span class="mi">31612000</span><span class="p">,</span> <span class="n">pagedir</span> <span class="mi">1</span><span class="n">aa000</span>
<span class="n">Amd64VtoP</span><span class="o">:</span> <span class="n">PML4E</span> <span class="mi">1</span><span class="n">aaf80</span>
<span class="n">Amd64VtoP</span><span class="o">:</span> <span class="n">PDPE</span> <span class="mi">909040</span>
<span class="n">Amd64VtoP</span><span class="o">:</span> <span class="n">PDE</span> <span class="mi">90</span><span class="n">ac58</span>
<span class="n">Amd64VtoP</span><span class="o">:</span> <span class="n">PTE</span> <span class="mi">914090</span>
<span class="n">Amd64VtoP</span><span class="o">:</span> <span class="n">Mapped</span> <span class="n">phys</span> <span class="mi">2012000</span>
<span class="n">Virtual</span> <span class="n">address</span> <span class="n">fffff80231612000</span> <span class="n">translates</span> <span class="n">to</span> <span class="n">physical</span> <span class="n">address</span> <span class="mi">2012000</span><span class="p">.</span>
</pre></table></code></div></div><p>As you can see it maps to 2012000 and both results of physical and virtual addresses are the same.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">dc</span> <span class="mi">2012000</span>
<span class="cp"># 2012000 00905a4d 00000003 00000004 0000ffff MZ..............
# 2012010 000000b8 00000000 00000040 00000000 ........@.......
# 2012020 00000000 00000000 00000000 00000000 ................
# 2012030 00000000 00000000 00000000 00000108 ................
# 2012040 0eba1f0e cd09b400 4c01b821 685421cd ........!..L.!Th
# 2012050 70207369 72676f72 63206d61 6f6e6e61 is program canno
# 2012060 65622074 6e757220 206e6920 20534f44 t be run in DOS 
# 2012070 65646f6d 0a0d0d2e 00000024 00000000 mode....$.......
</span><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">fffff802</span><span class="err">`</span><span class="mi">31612000</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612000</span>  <span class="mo">00</span><span class="mi">905</span><span class="n">a4d</span> <span class="mo">00000003</span> <span class="mo">00000004</span> <span class="mo">0000</span><span class="n">ffff</span>  <span class="n">MZ</span><span class="p">..............</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612010</span>  <span class="mo">000000</span><span class="n">b8</span> <span class="mo">00000000</span> <span class="mo">00000040</span> <span class="mo">00000000</span>  <span class="p">........</span><span class="err">@</span><span class="p">.......</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612020</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span>  <span class="p">................</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612030</span>  <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">00000000</span> <span class="mo">0000010</span><span class="mi">8</span>  <span class="p">................</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612040</span>  <span class="mi">0</span><span class="n">eba1f0e</span> <span class="n">cd09b400</span> <span class="mi">4</span><span class="n">c01b821</span> <span class="mi">685421</span><span class="n">cd</span>  <span class="p">......</span>	<span class="p">.</span><span class="o">!</span><span class="p">..</span><span class="n">L</span><span class="p">.</span><span class="o">!</span><span class="n">Th</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612050</span>  <span class="mi">70207369</span> <span class="mi">72676</span><span class="n">f72</span> <span class="mi">63206</span><span class="n">d61</span> <span class="mi">6</span><span class="n">f6e6e61</span>  <span class="n">is</span> <span class="n">program</span> <span class="n">canno</span>
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612060</span>  <span class="mi">65622074</span> <span class="mf">6e757220</span> <span class="mf">206e6920</span> <span class="mi">20534</span><span class="n">f44</span>  <span class="n">t</span> <span class="n">be</span> <span class="n">run</span> <span class="n">in</span> <span class="n">DOS</span> 
<span class="n">fffff802</span><span class="err">`</span><span class="mi">31612070</span>  <span class="mi">65646</span><span class="n">f6d</span> <span class="mi">0</span><span class="n">a0d0d2e</span> <span class="mo">00000024</span> <span class="mo">00000000</span>  <span class="n">mode</span><span class="p">....</span><span class="err">$</span><span class="p">.......</span>
</pre></table></code></div></div><p>We know that the default size of every page in Windows is 4086 Bytes so if we divide our physical address by 4096 (1000h) we can get our PFN Record Number.</p><p>In our case, (2012000h/1000h) is equal to 2012, so our PFN Record Number is 2012.</p><p>There is also another command called <strong>!pte</strong> which gives your PFN Number too. Let’s verify if we found the correct value.</p><p><img data-src="../../assets/images/pfn-record-windbg.png" alt="PFN Record Number" data-proofer-ignore></p><p>Ok, <strong>!pte</strong> and our result are the same. Now let’s find its record. First, you should get the <strong>nt!_MmPfn</strong>’s size.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">??</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">_MmPfn</span><span class="p">)</span>
<span class="kt">unsigned</span> <span class="n">int64</span> <span class="mh">0x30</span>
</pre></table></code></div></div><p>From the above, we have the address of <strong>nt!MmPfnDatabase</strong> (fffff400`00000000) and every record is exactly 0x30 Bytes so the final command is something like this:</p><p><strong>dt nt!_MmPfn (Address of MmPfnDatabase) + (PFN Record Number * _MmPfn size).</strong></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_MmPfn</span> <span class="p">(</span><span class="n">fffff400</span><span class="err">`</span><span class="mo">00000000</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x2012</span> <span class="o">*</span> <span class="mh">0x30</span><span class="p">))</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">ListEntry</span>        <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0x00000000</span><span class="err">`</span><span class="mo">00000000</span> <span class="o">-</span> <span class="mh">0xfffffafc</span><span class="err">`</span><span class="mo">011</span><span class="mi">8</span><span class="n">b090</span> <span class="p">]</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TreeNode</span>         <span class="o">:</span> <span class="n">_RTL_BALANCED_NODE</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">u1</span>               <span class="o">:</span> <span class="o">&lt;</span><span class="n">unnamed</span><span class="o">-</span><span class="n">tag</span><span class="o">&gt;</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">PteAddress</span>       <span class="o">:</span> <span class="mh">0xfffffafc</span><span class="err">`</span><span class="mo">011</span><span class="mi">8</span><span class="n">b090</span> <span class="n">_MMPTE</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">VolatilePteAddress</span> <span class="o">:</span> <span class="mh">0xfffffafc</span><span class="err">`</span><span class="mo">011</span><span class="mi">8</span><span class="n">b090</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">PteLong</span>          <span class="o">:</span> <span class="mh">0xfffffafc</span><span class="err">`</span><span class="mo">011</span><span class="mi">8</span><span class="n">b090</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">OriginalPte</span>      <span class="o">:</span> <span class="n">_MMPTE</span>
   <span class="o">+</span><span class="mh">0x018</span> <span class="n">u2</span>               <span class="o">:</span> <span class="n">_MIPFNBLINK</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">u3</span>               <span class="o">:</span> <span class="o">&lt;</span><span class="n">unnamed</span><span class="o">-</span><span class="n">tag</span><span class="o">&gt;</span>
   <span class="o">+</span><span class="mh">0x024</span> <span class="n">NodeBlinkLow</span>     <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x026</span> <span class="n">Unused</span>           <span class="o">:</span> <span class="mi">0</span><span class="n">y0000</span>
   <span class="o">+</span><span class="mh">0x026</span> <span class="n">Unused2</span>          <span class="o">:</span> <span class="mi">0</span><span class="n">y0000</span>
   <span class="o">+</span><span class="mh">0x027</span> <span class="n">ViewCount</span>        <span class="o">:</span> <span class="mi">0</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x027</span> <span class="n">NodeFlinkLow</span>     <span class="o">:</span> <span class="mi">0</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">u4</span>               <span class="o">:</span> <span class="o">&lt;</span><span class="n">unnamed</span><span class="o">-</span><span class="n">tag</span><span class="o">&gt;</span>
</pre></table></code></div></div><p>We can also use <strong>!pfn</strong> to get the details of our PFN Record directly.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">pfn</span> <span class="mi">2012</span>
    <span class="n">PFN</span> <span class="mo">00002012</span> <span class="n">at</span> <span class="n">address</span> <span class="n">FFFFF40000060360</span>
    <span class="n">flink</span>       <span class="mo">00000000</span>  <span class="n">blink</span> <span class="o">/</span> <span class="n">share</span> <span class="n">count</span> <span class="mo">00000001</span>  <span class="n">pteaddress</span> <span class="n">FFFFFAFC0118B090</span>
    <span class="n">reference</span> <span class="n">count</span> <span class="mo">0001</span>    <span class="n">used</span> <span class="n">entry</span> <span class="n">count</span>  <span class="mo">0000</span>      <span class="n">Cached</span>    <span class="n">color</span> <span class="mi">0</span>   <span class="n">Priority</span> <span class="mi">4</span>
    <span class="n">restore</span> <span class="n">pte</span> <span class="mo">000000</span><span class="mi">80</span>  <span class="n">containing</span> <span class="n">page</span> <span class="mo">000</span><span class="mi">914</span>  <span class="n">Active</span>     <span class="n">M</span>       
    <span class="n">Modified</span>                
</pre></table></code></div></div><p>You can see, we computed the correct value previously.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">?</span><span class="p">(</span><span class="n">fffff400</span><span class="err">`</span><span class="mo">00000000</span> <span class="o">+</span> <span class="p">(</span><span class="mh">0x2012</span> <span class="o">*</span> <span class="mh">0x30</span><span class="p">))</span>
<span class="n">Evaluate</span> <span class="n">expression</span><span class="o">:</span> <span class="o">-</span><span class="mi">13194139139232</span> <span class="o">=</span> <span class="n">fffff400</span><span class="err">`</span><span class="mo">00060360</span>
</pre></table></code></div></div><p>You can also traverse through all the PFN Entries, just remember to get the maximum allocated pages (Physical or Virtual).</p><p>These variables can help you get precise statistics about memory allocations.</p><ul><li><strong>MmAvailablePages</strong>: <em>Total number of available pages on the system the sum of the pages on the zeroed, free, and standby lists</em><li><strong>MmResidentAvailablePages</strong>: <em>Total number of physical pages that would be available if every process were at its minimum working set size</em><li><strong>MmNumberOfPhysicalPages</strong>: <em>Total number of physical pages available on the system</em></ul><h2 id="pfn-data-structures"><span class="mr-2">PFN Data Structures</span><a href="#pfn-data-structures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This section is derived from <a href="http://blog.rekall-forensic.com/2016/05/rekall-and-windows-pfn-database.html">here</a>, which worth reading:</p><h3 id="free-zero-and-bad-lists"><span class="mr-2">Free, Zero and Bad lists</span><a href="#free-zero-and-bad-lists" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>We start off by discussing these states - they are the simplest to understand. Pages which can take on any of these states (A flag in the _MMPTE.u3.e1.PageLocation) are kept in their own lists of Free pages (ready to be used), Zero pages (already cleared) or Bad pages (will never be used).</p><h3 id="active-pages-pteaddress-points-at-a-hardware-pte"><span class="mr-2">Active Pages: PteAddress points at a hardware PTE.</span><a href="#active-pages-pteaddress-points-at-a-hardware-pte" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>If the PFN Type is set to Active, then the physical page is used by something. <strong>The most important thing to realize is that a valid physical page (frame) must be managed by a PTE</strong>.  Since that PTE record must also be accessible to the kernel, it must be mapped in the kernel’s virtual address space.</p><p>When the PFN is Active, it contains 3 important pieces of information:</p><ol><li><p><strong>The virtual address of the PTE that is managing this physical page</strong> (in _MMPFN.PteAddress).</p><li><p><strong>The Page Frame (Physical page number) of the PTE that is managing this physical page</strong> (in _MMPFN.u4.PteFrame). Note these two values provide the virtual and physical address of the PTE.</p><li><p>The OriginalPte value (usually the prototype PTE which controls this page). When Windows installs a hardware PTE from a prototype PTE, it will copy the original prototype PTE into this field.</p></ol><p>If you want to know about prototype PTE, then there is a good article <a href="https://www.codemachine.com/article_protopte.html">here</a>.</p><p>From the first line, you should understand how to change page attributes for your physical memory.</p><p>Let’s see…</p><p><img data-src="../../assets/images/PTE-in-PFN.png" alt="Convert page pfn to pte" data-proofer-ignore></p><p>The Page Table Entry should be converted to binary to see its attributes. First I get the PTE Adress values and then convert it to binary format using <strong>.formats</strong>.</p><p>Note that I choose the first one because its <strong>Physical-Page Base Address</strong> is equal to 2012 (our PFN Number), the lowest 12 bits are used for attributes while bits 12 to 52 are used to show <strong>Physical Address</strong>.</p><p>0x02012963 —–&gt;  <strong>10000000010010</strong>(Used for Physical Address),100101100011(used for attributes.)</p><p><strong>10000000010010</strong> —–&gt; 0x2012</p><p>The following image shows its bits position and meaning. (The last one is PTE.)</p><p><img data-src="../../assets/images/regular-paging-structures.png" alt="Paging Tables" data-proofer-ignore></p><h2 id="windbg-vm-extension"><span class="mr-2">Windbg !vm extension</span><a href="#windbg-vm-extension" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>As I mentioned in the previous part, there is also another extension, called <strong>!vm</strong>.</p><p>The Windbg documentation says:</p><blockquote><p>!vm<br /> The !vm extension displays summary information about virtual memory use statistics on the target system.</p><p>!vm [Flags]<br /> Parameters</p><p>Flags<br /> Specifies what information will be displayed in the output from this command. This can be any sum of the following bits. The default is 0, which causes the display to include system-wide virtual memory statistics as well as memory statistics for each process.</p><p>Bit 0 (0x1)<br /> Causes the display to omit process-specific statistics.</p><p>Bit 1 (0x2)<br /> Causes the display to include memory management thread stacks.</p><p>Bit 2 (0x4)<br /> (Windows XP and later) Causes the display to include terminal server memory usage.</p><p>Bit 3 (0x8)<br /> (Windows XP and later) Causes the display to include the page file write log.</p><p>Bit 4 (0x10)<br /> (Windows XP and later) Causes the display to include working set owner thread stacks.</p><p>Bit 5 (0x20)<br /> (Windows Vista and later) Causes the display to include kernel virtual address usage.</p></blockquote><p>The above extension can be used to get some statistics about memory allocation and the most important field for us is <strong>PFN Array Commit</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="mi">1</span><span class="o">:</span> <span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">vm</span>
<span class="n">Page</span> <span class="n">File</span><span class="o">:</span> <span class="err">\</span><span class="o">??</span><span class="err">\</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">pagefile</span><span class="p">.</span><span class="n">sys</span>
  <span class="n">Current</span><span class="o">:</span>   <span class="mi">1179648</span> <span class="n">Kb</span>  <span class="n">Free</span> <span class="n">Space</span><span class="o">:</span>   <span class="mi">1173572</span> <span class="n">Kb</span>
  <span class="n">Minimum</span><span class="o">:</span>   <span class="mi">1179648</span> <span class="n">Kb</span>  <span class="n">Maximum</span><span class="o">:</span>      <span class="mi">6291456</span> <span class="n">Kb</span>
<span class="n">Page</span> <span class="n">File</span><span class="o">:</span> <span class="err">\</span><span class="o">??</span><span class="err">\</span><span class="n">C</span><span class="o">:</span><span class="err">\</span><span class="n">swapfile</span><span class="p">.</span><span class="n">sys</span>
  <span class="n">Current</span><span class="o">:</span>     <span class="mi">16384</span> <span class="n">Kb</span>  <span class="n">Free</span> <span class="n">Space</span><span class="o">:</span>     <span class="mi">16376</span> <span class="n">Kb</span>
  <span class="n">Minimum</span><span class="o">:</span>     <span class="mi">16384</span> <span class="n">Kb</span>  <span class="n">Maximum</span><span class="o">:</span>      <span class="mi">3144940</span> <span class="n">Kb</span>
<span class="n">No</span> <span class="n">Name</span> <span class="k">for</span> <span class="n">Paging</span> <span class="n">File</span>
  <span class="n">Current</span><span class="o">:</span>   <span class="mi">8388084</span> <span class="n">Kb</span>  <span class="n">Free</span> <span class="n">Space</span><span class="o">:</span>   <span class="mi">8032544</span> <span class="n">Kb</span>
  <span class="n">Minimum</span><span class="o">:</span>   <span class="mi">8388084</span> <span class="n">Kb</span>  <span class="n">Maximum</span><span class="o">:</span>      <span class="mi">8388084</span> <span class="n">Kb</span>

<span class="n">Physical</span> <span class="n">Memory</span><span class="o">:</span>           <span class="mi">524157</span> <span class="p">(</span>    <span class="mi">2096628</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Available</span> <span class="n">Pages</span><span class="o">:</span>           <span class="mi">313062</span> <span class="p">(</span>    <span class="mi">1252248</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">ResAvail</span> <span class="n">Pages</span><span class="o">:</span>            <span class="mi">451681</span> <span class="p">(</span>    <span class="mi">1806724</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Locked</span> <span class="n">IO</span> <span class="n">Pages</span><span class="o">:</span>                <span class="mi">0</span> <span class="p">(</span>          <span class="mi">0</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Free</span> <span class="n">System</span> <span class="n">PTEs</span><span class="o">:</span>      <span class="mi">4294977640</span> <span class="p">(</span><span class="mi">17179910560</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Modified</span> <span class="n">Pages</span><span class="o">:</span>             <span class="mi">11735</span> <span class="p">(</span>      <span class="mi">46940</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Modified</span> <span class="n">PF</span> <span class="n">Pages</span><span class="o">:</span>          <span class="mi">11693</span> <span class="p">(</span>      <span class="mi">46772</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Modified</span> <span class="n">No</span> <span class="n">Write</span> <span class="n">Pages</span><span class="o">:</span>        <span class="mi">0</span> <span class="p">(</span>          <span class="mi">0</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">NonPagedPool</span> <span class="n">Usage</span><span class="o">:</span>             <span class="mi">0</span> <span class="p">(</span>          <span class="mi">0</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">NonPagedPoolNx</span> <span class="n">Usage</span><span class="o">:</span>       <span class="mi">14108</span> <span class="p">(</span>      <span class="mi">56432</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">NonPagedPool</span> <span class="n">Max</span><span class="o">:</span>      <span class="mi">4294967296</span> <span class="p">(</span><span class="mi">17179869184</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span>  <span class="mi">0</span><span class="o">:</span>               <span class="mi">27632</span> <span class="p">(</span>     <span class="mi">110528</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span>  <span class="mi">1</span><span class="o">:</span>                <span class="mi">2344</span> <span class="p">(</span>       <span class="mi">9376</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span>  <span class="mi">2</span><span class="o">:</span>                <span class="mi">2402</span> <span class="p">(</span>       <span class="mi">9608</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span>  <span class="mi">3</span><span class="o">:</span>                <span class="mi">2393</span> <span class="p">(</span>       <span class="mi">9572</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span>  <span class="mi">4</span><span class="o">:</span>                <span class="mi">2308</span> <span class="p">(</span>       <span class="mi">9232</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span> <span class="n">Usage</span><span class="o">:</span>            <span class="mi">37079</span> <span class="p">(</span>     <span class="mi">148316</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span> <span class="n">Maximum</span><span class="o">:</span>     <span class="mi">4294967296</span> <span class="p">(</span><span class="mi">17179869184</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Processor</span> <span class="n">Commit</span><span class="o">:</span>             <span class="mi">728</span> <span class="p">(</span>       <span class="mi">2912</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Session</span> <span class="n">Commit</span><span class="o">:</span>              <span class="mi">2947</span> <span class="p">(</span>      <span class="mi">11788</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Shared</span> <span class="n">Commit</span><span class="o">:</span>              <span class="mi">24440</span> <span class="p">(</span>      <span class="mi">97760</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Special</span> <span class="n">Pool</span><span class="o">:</span>                   <span class="mi">0</span> <span class="p">(</span>          <span class="mi">0</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Kernel</span> <span class="n">Stacks</span><span class="o">:</span>               <span class="mi">6825</span> <span class="p">(</span>      <span class="mi">27300</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Pages</span> <span class="n">For</span> <span class="n">MDLs</span><span class="o">:</span>              <span class="mi">1378</span> <span class="p">(</span>       <span class="mi">5512</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Pages</span> <span class="n">For</span> <span class="n">AWE</span><span class="o">:</span>                  <span class="mi">0</span> <span class="p">(</span>          <span class="mi">0</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">NonPagedPool</span> <span class="n">Commit</span><span class="o">:</span>        <span class="mi">12147</span> <span class="p">(</span>      <span class="mi">48588</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PagedPool</span> <span class="n">Commit</span><span class="o">:</span>           <span class="mi">37079</span> <span class="p">(</span>     <span class="mi">148316</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Driver</span> <span class="n">Commit</span><span class="o">:</span>              <span class="mi">10370</span> <span class="p">(</span>      <span class="mi">41480</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Boot</span> <span class="n">Commit</span><span class="o">:</span>                 <span class="mi">2167</span> <span class="p">(</span>       <span class="mi">8668</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">PFN</span> <span class="n">Array</span> <span class="n">Commit</span><span class="o">:</span>            <span class="mi">6687</span> <span class="p">(</span>      <span class="mi">26748</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">System</span> <span class="n">PageTables</span><span class="o">:</span>            <span class="mi">446</span> <span class="p">(</span>       <span class="mi">1784</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">ProcessLockedFilePages</span><span class="o">:</span>        <span class="mi">15</span> <span class="p">(</span>         <span class="mi">60</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Pagefile</span> <span class="n">Hash</span> <span class="n">Pages</span><span class="o">:</span>            <span class="mi">3</span> <span class="p">(</span>         <span class="mi">12</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Sum</span> <span class="n">System</span> <span class="n">Commit</span><span class="o">:</span>         <span class="mi">105232</span> <span class="p">(</span>     <span class="mi">420928</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Total</span> <span class="n">Private</span><span class="o">:</span>             <span class="mi">161822</span> <span class="p">(</span>     <span class="mi">647288</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Misc</span><span class="o">/</span><span class="n">Transient</span> <span class="n">Commit</span><span class="o">:</span>       <span class="mi">2124</span> <span class="p">(</span>       <span class="mi">8496</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Committed</span> <span class="n">pages</span><span class="o">:</span>           <span class="mi">269178</span> <span class="p">(</span>    <span class="mi">1076712</span> <span class="n">Kb</span><span class="p">)</span>
<span class="n">Commit</span> <span class="n">limit</span><span class="o">:</span>              <span class="mi">819069</span> <span class="p">(</span>    <span class="mi">3276276</span> <span class="n">Kb</span><span class="p">)</span>

  <span class="n">Pid</span> <span class="n">ImageName</span>                        <span class="n">Commit</span>   <span class="n">SharedCommit</span>        <span class="n">Debt</span>

  <span class="mi">81</span><span class="n">c</span> <span class="n">MsMpEng</span><span class="p">.</span><span class="n">exe</span>                   <span class="mi">112764</span> <span class="n">Kb</span>        <span class="mi">7400</span> <span class="n">Kb</span>        <span class="mi">0</span> <span class="n">Kb</span>
<span class="p">...</span>
  <span class="n">f10</span> <span class="n">userinit</span><span class="p">.</span><span class="n">exe</span>                      <span class="mi">72</span> <span class="n">Kb</span>           <span class="mi">0</span> <span class="n">Kb</span>        <span class="mi">0</span> <span class="n">Kb</span>
  <span class="mi">830</span> <span class="n">coredpussvr</span><span class="p">.</span><span class="n">exe</span>                   <span class="mi">72</span> <span class="n">Kb</span>           <span class="mi">0</span> <span class="n">Kb</span>        <span class="mi">0</span> <span class="n">Kb</span>
  <span class="mi">1</span><span class="n">f0</span> <span class="n">smss</span><span class="p">.</span><span class="n">exe</span>                          <span class="mi">72</span> <span class="n">Kb</span>           <span class="mi">0</span> <span class="n">Kb</span>        <span class="mi">0</span> <span class="n">Kb</span>
</pre></table></code></div></div><p>That’s it guys, hope you enjoy reading this topic. If you have any question, then you can use the comments.</p><p>Have fun surveying Windows!</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>[Inside Windows Page Frame Number (PFN) – Part 1] (<a href="https://rayanfam.com/topics/inside-windows-page-frame-number-part1/">https://rayanfam.com/topics/inside-windows-page-frame-number-part1/</a>)  </p><p>[Memory Manager Routines] (<a href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff554435(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/hardware/ff554435(v=vs.85).aspx</a>)  </p><p>[Page Frame Number Database] (<a href="https://flylib.com/books/en/4.491.1.69/1/">https://flylib.com/books/en/4.491.1.69/1/</a>)</p><p>[Rekall and the windows PFN database] (<a href="http://blog.rekall-forensic.com/2016/05/rekall-and-windows-pfn-database.html">http://blog.rekall-forensic.com/2016/05/rekall-and-windows-pfn-database.html</a>)</p><p>[Prototype PTEs] (<a href="https://www.codemachine.com/article_protopte.html">https://www.codemachine.com/article_protopte.html</a>)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/debugging/'>debugging</a>, <a href='/categories/kernel-mode/'>kernel-mode</a>, <a href='/categories/windows/'>windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/migetphysicaladdress/" class="post-tag no-text-decoration" >migetphysicaladdress</a> <a href="/tags/mivatopfn/" class="post-tag no-text-decoration" >mivatopfn</a> <a href="/tags/mmavailablepages/" class="post-tag no-text-decoration" >mmavailablepages</a> <a href="/tags/mmgetphysicaladdress/" class="post-tag no-text-decoration" >mmgetphysicaladdress</a> <a href="/tags/mmgetvirtualforphysical/" class="post-tag no-text-decoration" >mmgetvirtualforphysical</a> <a href="/tags/mmnumberofphysicalpages/" class="post-tag no-text-decoration" >mmnumberofphysicalpages</a> <a href="/tags/mmresidentavailablepages/" class="post-tag no-text-decoration" >mmresidentavailablepages</a> <a href="/tags/nt-mmpfn/" class="post-tag no-text-decoration" >nt_mmpfn</a> <a href="/tags/page-management-in-windows/" class="post-tag no-text-decoration" >page-management-in-windows</a> <a href="/tags/pfn/" class="post-tag no-text-decoration" >pfn</a> <a href="/tags/pfn-database/" class="post-tag no-text-decoration" >pfn-database</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Inside Windows Page Frame Number (PFN) – Part 2 - Rayanfam Blog&amp;url=https://rayanfam.com/topics/inside-windows-page-frame-number-part2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Inside Windows Page Frame Number (PFN) – Part 2 - Rayanfam Blog&amp;u=https://rayanfam.com/topics/inside-windows-page-frame-number-part2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/inside-windows-page-frame-number-part2/&amp;text=Inside Windows Page Frame Number (PFN) – Part 2 - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/inside-windows-page-frame-number-part1/"><div class="card-body"> <em class="timeago small" data-ts="1531958400" > 2018-07-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Inside Windows Page Frame Number (PFN) - Part 1</h3><div class="text-muted small"><p> Introduction (Page Frame Number) Windows and almost all the OSs use Page Frame Number Database in order to have a track of virtually allocated pages to know which page must be freed or evicted o...</p></div></div></a></div><div class="card"> <a href="/topics/finding-the-real-access-rights-needed-by-handles/"><div class="card-body"> <em class="timeago small" data-ts="1559779200" > 2019-06-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Why you should not always trust MSDN: Finding Real Access Rights Needed By Handles</h3><div class="text-muted small"><p> Introduction Hi guys, The title of this topic is somehow weird, if you think everything in MSDN is 100% match with what Microsoft implemented in Windows (like what I used to think), you’re defi...</p></div></div></a></div><div class="card"> <a href="/topics/fooling-windows-about-cpu/"><div class="card-body"> <em class="timeago small" data-ts="1506816000" > 2017-10-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Fooling Windows about its internal CPU</h3><div class="text-muted small"><p> In this post, I’m gonna show you how you can fool windows about its internal structure and sometimes give it wrong information about its internal capabilities or internal information which can br...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/cisco-switch-sec-cheatsheet/" class="btn btn-outline-primary" prompt="Older"><p>Cisco switch security features cheatsheet</p></a> <a href="/topics/inline-assembly-in-x64/" class="btn btn-outline-primary" prompt="Newer"><p>x64 Inline Assembly in Windows Driver Kit</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/inside-windows-page-frame-number-part2/'; this.page.identifier = '/topics/inside-windows-page-frame-number-part2/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
