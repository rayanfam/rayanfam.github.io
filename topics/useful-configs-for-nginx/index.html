<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Useful Configs for NGINX" /><meta name="author" content="Shahriar" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/useful-configs-for-nginx/" /><meta property="og:url" content="https://rayanfam.com/topics/useful-configs-for-nginx/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-03-06T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Useful Configs for NGINX" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Shahriar" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Shahriar"},"dateModified":"2022-04-13T21:12:10+00:00","datePublished":"2018-03-06T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Useful Configs for NGINX","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/useful-configs-for-nginx/"},"url":"https://rayanfam.com/topics/useful-configs-for-nginx/"}</script><title>Useful Configs for NGINX | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Useful Configs for NGINX</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Useful Configs for NGINX</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/Xcess">Shahriar</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1520294400" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-03-06 </em> </span> <span> Updated <em class="timeago" data-ts="1649884330" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-04-14 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1009 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/NGINX-logo.png" alt="" data-proofer-ignore></p><p>After posting the first of my <em>linux SysAdmin quick config sample series</em> titled “Useful Configs for squid” (which you can read <a href="https://rayanfam.com/topics/useful-config-squid3/">here</a>). I decided to write another post, this time about the powerful and popular web/cache server <strong>NGINX</strong>!</p><p>I spent quite some time reading through nginx official docs and other blogs/websites while testing each configuration directive in different scenarios. Some of the options presented in this post do not have good or any documentation. I hope you find them useful!</p><p><em>*** snippets are tested on nginx on Debian 8 (jessie) but they will work on other distros/OSs with minimal or no modification.</em></p><p><em>Disclaimer: These configuration files are meant to be small and simple and designed to help you get an idea of what is possible with NGINX or quickly test some of its capabilities in a lab environment. although they probably work but they may be far from complete at times. So It’s up to you to research further if you want to leverage nginx in production.</em></p><hr /><h2 id="connecting-to-php"><span class="mr-2">Connecting to PHP</span><a href="#connecting-to-php" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Probably the first thing you want to do after installing nginx is to connect it to some php interpreter to be able to run your web application.</p><ul><li>Install PHP (on debian : <code class="language-c highlighter-rouge"><span class="n">apt</span> <span class="n">install</span> <span class="n">php5</span> <span class="n">php5</span><span class="o">-</span><span class="n">fpm</span></code>)<li>change NGINX config file like this (essentially only uncomment the relevant section):</ul><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">location</span> <span class="o">~</span> <span class="err">\</span><span class="p">.</span><span class="n">php</span><span class="err">$</span> <span class="p">{</span>
     <span class="n">include</span> <span class="n">snippets</span><span class="o">/</span><span class="n">fastcgi</span><span class="o">-</span><span class="n">php</span><span class="p">.</span><span class="n">conf</span><span class="p">;</span>

     <span class="cp"># With php5-cgi alone:
</span>     <span class="cp">#fastcgi_pass 127.0.0.1:9000;
</span>     <span class="cp"># With php5-fpm:
</span>     <span class="n">fastcgi_pass</span> <span class="n">unix</span><span class="o">:/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">php5</span><span class="o">-</span><span class="n">fpm</span><span class="p">.</span><span class="n">sock</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><ul><li>add <em>index.php</em> to index line<li>verify socket properties in <em>/etc/php5/fpm/pools.d/www.conf</em><ul><li>socket permissions and user must be correct (they are correct in a default Debian Jessie install)</ul></ul><h2 id="redirect-http-to-https"><span class="mr-2">Redirect HTTP to HTTPS</span><a href="#redirect-http-to-https" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>There any many ways to accomplish this. Some websites advocate the use of <em>if__($scheme …</em> but <strong>THIS IS WRONG</strong>. it causes performance issues and also <em>if</em> in nginx behaves differently and you might get unexpected results. The correct way to do this is presented below, <strong>no <em>rewrite, if , etc</em> are needed</strong> <a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/#taxing-rewrites">this</a>(see ):</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">301</span> <span class="n">https</span><span class="o">:</span><span class="c1">//$server_name$request_uri;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>*** Note that since we are doing a <strong>permanent redirect (301)</strong>, it will be cached by browsers so it will be a one time thing and they will connect to https port by default in subsequent visits.</p><p> </p><h2 id="nginx-reverse-proxy"><span class="mr-2">Nginx Reverse Proxy</span><a href="#nginx-reverse-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Reverse proxy is a very popular and useful feature of nginx. It’s important that you completely understand how it works and how to use it effectively. <em>a large number of websites and services are based on nginx reverse proxy like Netflix, CloudFlare CDN and many more!</em></p><p>basic reverse proxy:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="n">server_name</span> <span class="n">rayanfam</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>
    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//&lt;IP of other web server&gt;/[path of real website if not hosted on root];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This feature is usually utilized minimally like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">server</span> <span class="p">{</span>
    <span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
    <span class="n">server_name</span> <span class="n">www</span><span class="p">.</span><span class="n">rayanfam</span><span class="p">.</span><span class="n">com</span> <span class="n">devel</span><span class="p">.</span><span class="n">rayanfam</span><span class="p">.</span><span class="n">com</span> <span class="n">rayanfam</span><span class="p">.</span><span class="n">com</span><span class="p">;</span>

    <span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//222.222.222.222:8080;</span>
        <span class="n">proxy_set_header</span> <span class="n">Host</span> <span class="err">$</span><span class="n">host</span><span class="p">;</span>
        <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Real</span><span class="o">-</span><span class="n">IP</span> <span class="err">$</span><span class="n">remote_addr</span><span class="p">;</span>
        <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">For</span> <span class="err">$</span><span class="n">proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="n">proxy_set_header</span> <span class="n">X</span><span class="o">-</span><span class="n">Forwarded</span><span class="o">-</span><span class="n">Proto</span> <span class="err">$</span><span class="n">scheme</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>I suggest you read <a href="https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/">official docs</a> on this feature at least, there are many good articles on reverse proxying with nginx on other websites too.</p><h2 id="forward-proxy"><span class="mr-2">Forward Proxy</span><a href="#forward-proxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This is not a very used feature but for the sake of completeness and also because it is not available on other websites I will show you how to configure nginx as a forward proxy for your organization. It will do the job very well!</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">server</span> <span class="p">{</span>
	<span class="n">listen</span> <span class="mi">80</span><span class="p">;</span>
	<span class="n">server_name</span> <span class="n">_</span><span class="p">;</span>
	<span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
		<span class="n">resolver</span> <span class="mi">8</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">8</span><span class="p">;</span>
		<span class="n">proxy_pass</span> <span class="n">http</span><span class="o">:</span><span class="c1">//$http_host$uri$is_args$args;</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><em>*** Do not host this on a public facing IP!</em></p><h2 id="ip-based-block"><span class="mr-2">IP-based Block</span><a href="#ip-based-block" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>You may want to deny or allow access only from a specific ip range. you can achieve this with iptables, but this is an acceptable way too:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">location</span> <span class="o">/</span> <span class="p">{</span>
    <span class="n">allow</span> <span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">20</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">24</span><span class="p">;</span>
    <span class="n">deny</span> <span class="n">all</span><span class="p">;</span>
    <span class="cp">#... other directives
</span><span class="p">}</span>
</pre></table></code></div></div><h2 id="custom-error-pages"><span class="mr-2">Custom Error Pages</span><a href="#custom-error-pages" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>You can easily customize your error page using nginx and setup fancy error pages for all types of error (<a href="https://github.com/login_404">GitHub</a> is my favorite ^_^ ):</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="cp"># Both are mandatory. error paged should be marked as internal
</span>
<span class="n">error_page</span> <span class="mi">403</span> <span class="o">/</span><span class="n">forbidden</span><span class="p">.</span><span class="n">html</span><span class="p">;</span>

<span class="n">location</span> <span class="o">/</span><span class="n">forbidden</span><span class="p">.</span><span class="n">html</span> <span class="p">{</span>
    <span class="n">internal</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="log-format-and-destination"><span class="mr-2">Log format and Destination</span><a href="#log-format-and-destination" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Changing the log format and log destination is trivial in nginx. I create a new access log format and then use it to log to syslog facility.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cp"># creating log format
</span><span class="n">log_format</span> <span class="n">mylogformat</span> <span class="err">‘$</span><span class="n">remote_addr</span> <span class="err">$</span><span class="n">request</span><span class="err">’</span>

<span class="cp"># log to a file using mylogformat
</span><span class="n">access_log</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">custom_access</span><span class="p">.</span><span class="n">log</span> <span class="n">mylogformat</span><span class="p">;</span>

<span class="cp"># log to syslog server using mylogformat
</span><span class="n">access_log</span> <span class="n">syslog</span><span class="o">:</span><span class="n">server</span><span class="o">=</span><span class="mi">192</span><span class="p">.</span><span class="mi">168</span><span class="p">.</span><span class="mi">10</span><span class="p">.</span><span class="mi">10</span> <span class="n">mylogformat</span><span class="p">;</span>
</pre></table></code></div></div><p><em>you can view official nginx docs regarding field names for logs and support for <a href="https://nginx.org/en/docs/syslog.html">syslog</a>, etc.</em></p><h2 id="basic-caching-with-nginx"><span class="mr-2">Basic Caching with Nginx</span><a href="#basic-caching-with-nginx" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This snippet is intended to give you a very rough idea of caching with nginx and the minimal configuration required to activate that. In a real server more sophisticated caching will probably be required but this will get you started on this topic.</p><p><em>*** Caching is one of the most advanced  features of nginx, make sure to study and understand it.</em></p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="cp"># First create the directory and set the required permissions#
</span>
<span class="n">proxy_cache_path</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">nginx</span> <span class="n">keys_zone</span><span class="o">=</span><span class="n">CACHE</span><span class="o">:</span><span class="mi">10</span><span class="n">m</span><span class="p">;</span>

<span class="n">server</span> <span class="p">{</span>
    <span class="n">proxy_cache</span> <span class="n">CACHE</span><span class="p">;</span>
    <span class="cp"># ... other directives
</span><span class="p">}</span>
</pre></table></code></div></div><h2 id="http-basic-authentication"><span class="mr-2">HTTP Basic Authentication</span><a href="#http-basic-authentication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>It’s the simplest form of authentication you can have for your website or a single page. yet it is effective and secure (if your password is only known by you of course). <strong>BE CAREFUL</strong> <strong>not to put your password file in your web directory!</strong> (yes I’ve seen people do that)</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">run</span> <span class="n">this</span> <span class="n">command</span> <span class="n">in</span> <span class="n">your</span> <span class="n">shell</span><span class="p">.</span> <span class="n">It</span><span class="err">'</span><span class="n">s</span> <span class="n">not</span> <span class="n">part</span> <span class="n">of</span> <span class="n">nginx</span> <span class="n">config</span><span class="o">:</span>
<span class="err">$</span> <span class="n">htpasswd</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="p">.</span><span class="n">htpasswd</span> <span class="n">shahriar</span>

<span class="cp"># nginx config → add in desired location block
</span>
    <span class="n">auth_basic</span> <span class="s">"Private Content"</span><span class="p">;</span> 
    <span class="n">auth_basic_user_file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="p">.</span><span class="n">htpasswd</span><span class="p">;</span>
</pre></table></code></div></div><hr /><p>some links:</p><p><a href="https://nginx.org/en/docs/">Official docs</a></p><p><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls">Common config pitfalls (official docs)</a></p><hr /><p>I hope you found this blog post useful… spread the word and tell your friends! also do not hesitate to comment. Have fun sysadmin-ing!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/linux/'>linux</a>, <a href='/categories/network/'>network</a>, <a href='/categories/sysadmin/'>sysadmin</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/cache/" class="post-tag no-text-decoration" >cache</a> <a href="/tags/debian/" class="post-tag no-text-decoration" >debian</a> <a href="/tags/https/" class="post-tag no-text-decoration" >https</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/tags/loadbalance/" class="post-tag no-text-decoration" >loadbalance</a> <a href="/tags/nginx/" class="post-tag no-text-decoration" >nginx</a> <a href="/tags/opensource/" class="post-tag no-text-decoration" >opensource</a> <a href="/tags/php-fpm/" class="post-tag no-text-decoration" >php-fpm</a> <a href="/tags/proxy/" class="post-tag no-text-decoration" >proxy</a> <a href="/tags/webserver/" class="post-tag no-text-decoration" >webserver</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Useful Configs for NGINX - Rayanfam Blog&amp;url=https://rayanfam.com/topics/useful-configs-for-nginx/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Useful Configs for NGINX - Rayanfam Blog&amp;u=https://rayanfam.com/topics/useful-configs-for-nginx/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/useful-configs-for-nginx/&amp;text=Useful Configs for NGINX - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/useful-config-squid3/"><div class="card-body"> <em class="timeago small" data-ts="1490054400" > 2017-03-21 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Useful Configs for Squid3 Cache</h3><div class="text-muted small"><p> Hi everyone! After searching the web so many times and testing different configurations of Squid, I have found these minimal working configs which you can use to achieve the features you want fr...</p></div></div></a></div><div class="card"> <a href="/topics/cisco-ios-and-strongswan-ipsec-vpn/"><div class="card-body"> <em class="timeago small" data-ts="1505606400" > 2017-09-17 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Cisco IOS and StrongSWAN IPSEC VPN</h3><div class="text-muted small"><p> In this blog post we will cover IPSEC tunnel between Linux StrongSWAN and Cisco IOS. The strongSWAN config file can copied exactly as is to another server with the IP of Cisco Router and the tun...</p></div></div></a></div><div class="card"> <a href="/topics/introduction-to-systemd-basic-usage-and-concepts/"><div class="card-body"> <em class="timeago small" data-ts="1522972800" > 2018-04-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introduction to systemd : Basic Usage and Concepts</h3><div class="text-muted small"><p> Hi everyone In this post I am going to explain some essential systemd commands and concepts. As systemd popularity grew much more and changed the linux ecosystem drastically, every sysadmin, Dev...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/assembly-challenge-jump-to-a-non-relative-address-without-using-registers/" class="btn btn-outline-primary" prompt="Older"><p>Assembly Challenge : Jump to a non-relative address without using registers</p></a> <a href="/topics/introduction-to-systemd-basic-usage-and-concepts/" class="btn btn-outline-primary" prompt="Newer"><p>Introduction to systemd : Basic Usage and Concepts</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/useful-configs-for-nginx/'; this.page.identifier = '/topics/useful-configs-for-nginx/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
