<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Bochs Emulator - Debug &amp; Instrument" /><meta name="author" content="Sina Karvandi" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/" /><meta property="og:url" content="https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-04-27T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bochs Emulator - Debug &amp; Instrument" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Sina Karvandi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sina Karvandi"},"dateModified":"2024-07-13T12:45:21+00:00","datePublished":"2018-04-27T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Bochs Emulator - Debug &amp; Instrument","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/"},"url":"https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/"}</script><title>Bochs Emulator - Debug & Instrument | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bochs Emulator - Debug & Instrument</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bochs Emulator - Debug & Instrument</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Intel80x86">Sina Karvandi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1524787200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-04-27 </em> </span> <span> Updated <em class="timeago" data-ts="1720874721" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-07-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1811 words"> <em>10 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/bochs-debugger-gui.png" alt="" data-proofer-ignore></p><p>There is also another post about configuring and building Bochs on Windows &amp; OS X if you have a problem compiling Bochs, take a look at <a href="https://rayanfam.com/topics/bochs-config-and-build-on-windows-and-os-x/">here</a>!</p><p>In my opinion, Bochs is an amazing thing because it provides instrumentation in the lowest level of the Operating System. One of the advantages of the Boch is being able to instrument in kernel-mode, which is not available in other instrumenting tools like Intel’s pin tool.</p><p>You can see how to interact with Bochs debugger <a href="http://bochs.sourceforge.net/doc/docbook/user/internal-debugger.html">here</a>. It’s somehow like Windbg in its syntax, if you enabled the debugger feature during the compilation then after running the OS, you can press ctrl+c and it gives you a command-line interface.</p><p>In the rest of the post, I’m gonna explain about instrumentation.</p><p>Instrumenting in Bochs is depending on the following functions that exist in /stubs/ instrument.cc.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"bochs.h"</span><span class="cp">
</span>
<span class="cp">#if BX_INSTRUMENTATION
</span>
<span class="kt">void</span> <span class="nf">bx_instr_init_env</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_exit_env</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_initialize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_exit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">type</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_hlt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_mwait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_phy_address</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="n">Bit32u</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_debug_promt</span><span class="p">()</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_debug_cmd</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_cnear_branch_taken</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">branch_eip</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">new_eip</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_cnear_branch_not_taken</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">branch_eip</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_ucnear_branch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">branch_eip</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">new_eip</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_far_branch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="n">Bit16u</span> <span class="n">prev_cs</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">prev_eip</span><span class="p">,</span> <span class="n">Bit16u</span> <span class="n">new_cs</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">new_eip</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_opcode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">Bit8u</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="n">bx_bool</span> <span class="n">is32</span><span class="p">,</span> <span class="n">bx_bool</span> <span class="n">is64</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_interrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vector</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_exception</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">error_code</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_hwinterrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vector</span><span class="p">,</span> <span class="n">Bit16u</span> <span class="n">cs</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">eip</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_tlb_cntrl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="n">bx_phy_address</span> <span class="n">new_cr3</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_clflush</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">bx_phy_address</span> <span class="n">paddr</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_cache_cntrl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_prefetch_hint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">seg</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">offset</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_before_execution</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_after_execution</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_repeat_iteration</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_inp</span><span class="p">(</span><span class="n">Bit16u</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_inp2</span><span class="p">(</span><span class="n">Bit16u</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_outp</span><span class="p">(</span><span class="n">Bit16u</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_lin_access</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">lin</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">memtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rw</span><span class="p">)</span> <span class="p">{}</span>
<span class="kt">void</span> <span class="nf">bx_instr_phy_access</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span>                 <span class="n">bx_address</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">memtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rw</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_wrmsr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">addr</span><span class="p">,</span> <span class="n">Bit64u</span> <span class="n">value</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="nf">bx_instr_vmexit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">Bit32u</span> <span class="n">reason</span><span class="p">,</span> <span class="n">Bit64u</span> <span class="n">qualification</span><span class="p">)</span> <span class="p">{}</span>

<span class="cp">#endif
</span></pre></table></code></div></div><p>For using Bochs instrumentation, first, you need to configure Bochs with the following argument:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">instrumentation</span><span class="o">=</span><span class="s">"instrument/stubs"</span>
</pre></table></code></div></div><p>Then you can change the above file and compile your project again and run Bochs with its debugger feature then Bochs automatically sets your function as a callback to its main CPU emulation functions and every time, one of the above functions performed in the target machine, then you’ll be aware.</p><p>The best reference for describing the above functions is Instrument.txt which exists under /instrument/Instrument.txt, I copied the newest version of Instrument.txt (at the time of writing this post), you can see the below file :</p><p><strong>Instrumentation</strong></p><p>To use instrumentation features in bochs, you must compile in support for it. You should build a custom instrumentation library in a separate directory in the “instrument/” directory. To tell configure which instrumentation library you want to use, use the “–enable-instrumentation” option. The default library consists of a set of stubs, and the following are equivalent:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="p">[...]</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">instrumentation</span>
 <span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="p">[...]</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">instrumentation</span><span class="o">=</span><span class="s">"instrument/stubs"</span>
</pre></table></code></div></div><p>You could make a separate directory with your custom library, for example “instrument/myinstrument”, copy the contents of the “instrument/stubs” directory to it, then customize it. Use:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="p">[...]</span> <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">instrumentation</span><span class="o">=</span><span class="s">"instrument/myinstrument"</span>
</pre></table></code></div></div><h3 id="bochs-instrumentation-callbacks"><span class="mr-2">BOCHS instrumentation callbacks</span><a href="#bochs-instrumentation-callbacks" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_init_env</span><span class="p">();</span>
</pre></table></code></div></div><p>The callback is called when Bochs is initialized, before of reading .bochsrc. It can be used for registration of parameters in siminterface. Then when bx_instr_init() is called it can access configuration parameters defined by bx_instr_init_env(), so instrumentalization module can use additional options in .bochsrc.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_exit_env</span><span class="p">();</span>
</pre></table></code></div></div><p>The callback is called each time Bochs exits.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_initialize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs initializes the CPU object. It can be used for initialization of user’s data, dynamic memory allocation and etc.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_exit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs destructs the CPU object. It can be used for destruction of user’s data, allocated by bx_instr_init callback.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_reset</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">type</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs resets the CPU object. It would be executed once at the start of simulation and each time that user presses RESET BUTTON on the simulator’s control panel.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_hlt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs’ emulated CPU enters HALT or SHUTDOWN state.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_mwait</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_phy_address</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="n">Bit32u</span> <span class="n">flags</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs’ emulated CPU enters to the MWAIT state. The callback receives monitored memory range and MWAIT flags as a parameters.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_cnear_branch_taken</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">branch_rip</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">new_rip</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when currently executed instruction is a conditional near branch and it is taken.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_cnear_branch_not_taken</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">branch_rip</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when currently executed instruction is a conditional near branch and it is not taken.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_ucnear_branch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">branch_rip</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">new_rip</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when currently executed instruction is an unconditional near branch (always taken).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_far_branch</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="n">Bit16u</span> <span class="n">prev_cs</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">prev_rip</span><span class="p">,</span> <span class="n">Bit16u</span> <span class="n">new_cs</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">new_rip</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when currently executed instruction is an unconditional far branch (always taken).</p><p>Possible operation types, passed through bx_instr_ucnear_branch and bx_instr_far_branch are:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre> <span class="cp">#define BX_INSTR_IS_JMP 10
</span> <span class="cp">#define BX_INSTR_IS_JMP_INDIRECT 11
</span> <span class="cp">#define BX_INSTR_IS_CALL 12
</span> <span class="cp">#define BX_INSTR_IS_CALL_INDIRECT 13
</span> <span class="cp">#define BX_INSTR_IS_RET 14
</span> <span class="cp">#define BX_INSTR_IS_IRET 15
</span> <span class="cp">#define BX_INSTR_IS_INT 16
</span> <span class="cp">#define BX_INSTR_IS_SYSCALL 17
</span> <span class="cp">#define BX_INSTR_IS_SYSRET 18
</span> <span class="cp">#define BX_INSTR_IS_SYSENTER 19
</span> <span class="cp">#define BX_INSTR_IS_SYSEXIT 20
</span></pre></table></code></div></div><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_vmexit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">Bit32u</span> <span class="n">reason</span><span class="p">,</span> <span class="n">Bit64u</span> <span class="n">qualification</span><span class="p">);</span>
</pre></table></code></div></div><p>This callback is called right before Bochs executes a VMEXIT.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_opcode</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">const</span> <span class="n">Bit8u</span> <span class="o">*</span><span class="n">opcode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="n">bx_bool</span> <span class="n">is32</span><span class="p">,</span> <span class="n">bx_bool</span> <span class="n">is64</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs completes to decode a new instruction. Through this callback function Bochs could provide an opcode of the instruction, opcode length and an execution mode (16/32/64).</p><p>Note, that Bochs uses translation caches so each simulated instruction might be executed multiple times but decoded only once.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_interrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vector</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes an interrupt (software interrupt, hardware interrupt or an exception).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_exception</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vector</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">error_code</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes an exception.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_hwinterrupt</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">vector</span><span class="p">,</span> <span class="n">Bit16u</span> <span class="n">cs</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">rip</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes a hardware interrupt.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_clflush</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">laddr</span><span class="p">,</span> <span class="n">bx_phy_address</span> <span class="n">paddr</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time the CLFLUSH instruction is executed.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_tlb_cntrl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="n">bx_phy_address</span> <span class="n">new_cr_value</span><span class="p">);</span>
 <span class="kt">void</span> <span class="nf">bx_instr_cache_cntrl</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes a cache/tlb control instruction.</p><p>Possible instruction types, passed through bx_instr_tlb_cntrl are:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre> <span class="cp">#define BX_INSTR_MOV_CR0 10
</span> <span class="cp">#define BX_INSTR_MOV_CR3 11
</span> <span class="cp">#define BX_INSTR_MOV_CR4 12
</span> <span class="cp">#define BX_INSTR_TASK_SWITCH 13
</span> <span class="cp">#define BX_INSTR_CONTEXT_SWITCH 14 </span><span class="cm">/* VMM and SMM enter/exit */</span><span class="cp">
</span> <span class="cp">#define BX_INSTR_INVLPG 15
</span> <span class="cp">#define BX_INSTR_INVEPT 16
</span> <span class="cp">#define BX_INSTR_INVVPID 17
</span> <span class="cp">#define BX_INSTR_INVPCID 18
</span></pre></table></code></div></div><p>The new_cr_value is provided for first 4 instruction types only and undefined for all others.</p><p>Possible instruction types, passed through bx_instr_cache_cntrl are:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre> <span class="cp">#define BX_INSTR_INVD 10
</span> <span class="cp">#define BX_INSTR_WBINVD 11
</span></pre></table></code></div></div><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_prefetch_hint</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">what</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">seg</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">offset</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes a PREFETCH instruction.</p><p>Possible PREFETCH types:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre> <span class="cp">#define BX_INSTR_PREFETCH_NTA 00
</span> <span class="cp">#define BX_INSTR_PREFETCH_T0 01
</span> <span class="cp">#define BX_INSTR_PREFETCH_T1 02
</span> <span class="cp">#define BX_INSTR_PREFETCH_T2 03
</span></pre></table></code></div></div><p>The seg/offset arguments indicate the address of the requested prefetch.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_wrmsr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msr</span><span class="p">,</span> <span class="n">Bit64u</span> <span class="n">value</span><span class="p">);</span>
</pre></table></code></div></div><p>This callback is called each time when WRMSR instruction is executed. MSR number and written value passed as parameters to the callback function.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_repeat_iteration</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator starts a new repeat iteration.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_before_execution</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator starts a new instruction execution. In case of repeat instruction the callback will be called only once before the first iteration will be started.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_after_execution</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bxInstruction_c</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator finishes any instruction execution. In case of repeat instruction the callback will be called only once after all repeat iterations.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_lin_access</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">lin</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">memtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rw</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes a linear memory access. Note that no page split accesses will be generated because Bochs splits page split accesses to two different memory accesses during its execution flow. The callback also will not be generated in case of direct physical memory access like page walks, SMM, VMM or SVM operations.</p><p>Possible access types are: BX_READ, BX_WRITE and BX_RW.</p><p>Currently the callback is not supported when repeat-speedups optimization is enabled.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_phy_access</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">lin</span><span class="p">,</span> <span class="n">bx_address</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">memtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">rw</span><span class="p">);</span>
</pre></table></code></div></div><p>The callback is called each time, when Bochs simulator executes a physical memory access. Physical accesses include memory accesses generated by the CPU during page walks, SMM, VMM or SVM operations. Note that no page split accesses will be generated because Bochs splits page split accesses to two different memory accesses during its execution flow.</p><p>Possible access types are: BX_READ, BX_WRITE and BX_RW.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre> <span class="kt">void</span> <span class="nf">bx_instr_inp</span><span class="p">(</span><span class="n">Bit16u</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">);</span>
 <span class="kt">void</span> <span class="nf">bx_instr_inp2</span><span class="p">(</span><span class="n">Bit16u</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">);</span>
 <span class="kt">void</span> <span class="nf">bx_instr_outp</span><span class="p">(</span><span class="n">Bit16u</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">);</span>
</pre></table></code></div></div><p>These callback functions are a feedback from various system devices.</p><h3 id="known-problems"><span class="mr-2">Known problems</span><a href="#known-problems" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>1. BX_INSTR_LIN_ACCESS doesn’t work when repeat-speedups feature is enabled.</p><p>Feature requests:</p><p>1. BX_INSTR_CNEAR_BRANCH_NOT_TAKEN callback should have an additional ‘not taken’ new_rip parameter.</p><p>2. BX_INSTR_SMI, BX_INSTR_NMI, BX_INSTR_SIPI and other external events callbacks</p><p> </p><p>If you read the above description about instrument functions, then let’s have a look at some of the important ones!</p><p>For debugging VMX you should use bx_instr_vmexit, but you should be sure to compile your Bochs with this feature enabled. By default it is enabled in the current version of Bochs :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="cp">#define BX_SUPPORT_VMX 2
</span></pre></table></code></div></div><p>bx_instr_phy_access can also help you debugging EPT (Extended Page Table) by checking physical addresses.</p><p>There are also other functions like bx_instr_wrmsr which is used for detecting what kind of MSR indexes an operating system or system drivers try to use.</p><h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li>[Bochs User Manual] (<a href="http://bochs.sourceforge.net/doc/docbook/user/index.html">http://bochs.sourceforge.net/doc/docbook/user/index.html</a>)<li>[Platform emulation with Bochs] (<a href="https://www.ibm.com/developerworks/library/l-bochs">https://www.ibm.com/developerworks/library/l-bochs</a>) - [PDF Version] (<a href="https://www.ibm.com/developerworks/library/l-bochs/l-bochs-pdf.pdf">https://www.ibm.com/developerworks/library/l-bochs/l-bochs-pdf.pdf</a>)<li>[Wikipedia - Bochs] (<a href="https://en.wikipedia.org/wiki/Bochs">https://en.wikipedia.org/wiki/Bochs</a>)<li>[Using Bochs internal debugger] (<a href="http://bochs.sourceforge.net/doc/docbook/user/internal-debugger.html">http://bochs.sourceforge.net/doc/docbook/user/internal-debugger.html</a>)</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/debugging/'>debugging</a>, <a href='/categories/emulator/'>emulator</a>, <a href='/categories/instrumentation/'>instrumentation</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/debug-using-bochs/" class="post-tag no-text-decoration" >debug-using-bochs</a> <a href="/tags/emulator-debugging/" class="post-tag no-text-decoration" >emulator-debugging</a> <a href="/tags/instrument-instructions-using-bochs/" class="post-tag no-text-decoration" >instrument-instructions-using-bochs</a> <a href="/tags/instrument-kernel-mode/" class="post-tag no-text-decoration" >instrument-kernel-mode</a> <a href="/tags/instrument-linux/" class="post-tag no-text-decoration" >instrument-linux</a> <a href="/tags/instrument-operating-system/" class="post-tag no-text-decoration" >instrument-operating-system</a> <a href="/tags/instrument-os-x/" class="post-tag no-text-decoration" >instrument-os-x</a> <a href="/tags/instrument-windows/" class="post-tag no-text-decoration" >instrument-windows</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bochs Emulator - Debug &amp; Instrument - Rayanfam Blog&amp;url=https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bochs Emulator - Debug &amp; Instrument - Rayanfam Blog&amp;u=https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/&amp;text=Bochs Emulator - Debug &amp; Instrument - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/kernel-mode-debugging-by-windbg/"><div class="card-body"> <em class="timeago small" data-ts="1489881600" > 2017-03-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kernel Mode Debugging by Windbg</h3><div class="text-muted small"><p> Hey there, Today I’m gonna show you how to make a kernel mode debugging using VMWare and Windbg and Windows. So why should you do this ?! It’s clear , everything such as Kernel Mode Driver Deb...</p></div></div></a></div><div class="card"> <a href="/topics/how-to-get-every-details-about-ssdt-gdt-idt-in-a-blink-of-an-eye/"><div class="card-body"> <em class="timeago small" data-ts="1491004800" > 2017-04-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>How to get every detail about SSDT , GDT , IDT in a blink of an eye</h3><div class="text-muted small"><p> In a few days ago I was looking for something to show me the SSDT and GDT (Which is really important in malware analyzing because most of rootkits are interested in hooking and changing this stuf...</p></div></div></a></div><div class="card"> <a href="/topics/finding-the-real-access-rights-needed-by-handles/"><div class="card-body"> <em class="timeago small" data-ts="1559779200" > 2019-06-06 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Why you should not always trust MSDN: Finding Real Access Rights Needed By Handles</h3><div class="text-muted small"><p> Introduction Hi guys, The title of this topic is somehow weird, if you think everything in MSDN is 100% match with what Microsoft implemented in Windows (like what I used to think), you’re defi...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/bochs-config-and-build-on-windows-and-os-x/" class="btn btn-outline-primary" prompt="Older"><p>Bochs Emulator - Config & Build on Windows and OS X</p></a> <a href="/topics/active-directory-certificate-services-migration/" class="btn btn-outline-primary" prompt="Newer"><p>Active Directory Certificate Services Overview and Migration</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/bochs-emulator-debug-and-instrument/'; this.page.identifier = '/topics/bochs-emulator-debug-and-instrument/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
