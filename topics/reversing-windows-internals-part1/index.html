<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks &amp; ObjectTypes" /><meta name="author" content="Sina Karvandi" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/reversing-windows-internals-part1/" /><meta property="og:url" content="https://rayanfam.com/topics/reversing-windows-internals-part1/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-12-09T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks &amp; ObjectTypes" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Sina Karvandi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sina Karvandi"},"dateModified":"2024-07-13T12:45:21+00:00","datePublished":"2019-12-09T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks &amp; ObjectTypes","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/reversing-windows-internals-part1/"},"url":"https://rayanfam.com/topics/reversing-windows-internals-part1/"}</script><title>Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks & ObjectTypes | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks & ObjectTypes</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks & ObjectTypes</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Intel80x86">Sina Karvandi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1575849600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-12-09 </em> </span> <span> Updated <em class="timeago" data-ts="1720874721" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-07-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="9437 words"> <em>52 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/reversing-windows-internals-cover.png" alt="" data-proofer-ignore></p><h2 id="introduction"><span class="mr-2"><strong>Introduction</strong></span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Welcome to the first part of a series of posts about Exploring &amp; Reversing Windows Concepts and Internals. If you reach here then you’re probably a security researcher or a programmer and this post and similar posts can help you understand what’s going on in some parts of Windows when you use objects with different users and credentials and what you can expect from Windows and how it internally works.</p><p>If you want to follow other parts of this tutorial or other tutorials, please visit <a href="https://rayanfam.com/tutorials/">here</a>.</p><h2 id="overview"><span class="mr-2"><strong>Overview</strong></span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this part, I’m gonna describe some internal structures and functions relating to the “<strong>Handles</strong>” and we’ll see how Windows saves these handles in its internal structures then we go to see how callbacks work. For example, when you create a handle what kind of mechanisms exists in Windows to notify you about the handle creation. After that, we’ll see how Windows internally calls these callbacks by analyzing the process of creating a handle when a user-mode application requests a handle to the kernel. At last, we’ll see how Windows saves these callbacks and check other (somehow unknown) callbacks by studying different Object Types in Windows and we’ll practically use them in our drivers.</p><h2 id="table-of-contents"><span class="mr-2"><strong>Table of Contents</strong></span><a href="#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>Introduction</strong><li><strong>Overview</strong><li><strong>Table of Contents</strong><li><strong>Handles</strong><ul><li>What is a Handle?<li>Handles in Windows Kernel<li>Changing Handles Access</ul><li><strong>Callbacks</strong><ul><li>Callbacks for processes</ul><li><strong>Handle Creation Process</strong><ul><li>PsOpenProcess<li>ObOpenObjectByPointer<li>SECURITY_SUBJECT_CONTEXT<li>ACCESS_STATE<li>ObpCreateHandle</ul><li><strong>Object Types</strong><ul><li>ObjectTypes in Windows<li>Finding Process Object Type<li>TypeIndex in Object Types<li>Finding All Windows _OBJECT_TYPE(s)<li>Finding Types which support callback</ul><li><strong>Analyzing Callbacks in ObjectTypes</strong><ul><li>DumpProcedure<li>OpenProcedure<li>CloseProcedure<li>DeleteProcedure<li>ParseProcedure<li>ParseProcedureEx<li>SecurityProcedure<li>QueryNameProcedure<li>OkayToCloseProcedure</ul><li><strong>Using Callbacks in ObjectTypes</strong><li><strong>Conclusion</strong><li><strong>References</strong></ul><p><img data-src="../../assets/images/anime-girl-butterfly.jpg" alt="Aniiiiiime :)" data-proofer-ignore></p><h2 id="what-is-a-handle"><span class="mr-2"><strong>What is a Handle?</strong></span><a href="#what-is-a-handle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you’re familiar with the way Windows shares its resources, then you probably know about the handles. In short, the handle is a value that the Windows kernel returns to the user-mode application (if you have needed privileges or have an account which is not denied by <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces">DACL</a>) and this handle can be used for further action on the object.</p><p>There is a tool called “<strong>handle</strong>” from the <strong>SysInternals</strong> which can be downloaded from <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/handle">here</a>.</p><p>The official site describes :</p><blockquote><p>Ever wondered which program has a particular file or directory open? Now you can find out. <em>Handle</em> is a utility that displays information about open handles for any process in the system. You can use it to see the programs that have a file open, or to see the object types and names of all the handles of a program.</p></blockquote><p>Let’s see what are the handles of processes.</p><p>For example,</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">handle</span> <span class="n">windows</span><span class="err">\</span><span class="n">system</span>
</pre></table></code></div></div><p>This command shows every handle for each process in which their handle name contains “<strong>windows\system</strong>”. The name match is case-insensitive and the fragment specified can be anywhere in the paths you are interested in. You can imagine how this way can be used to find what process(es) are opening a specific file when you try to remove them.</p><p><img data-src="../../assets/images/reversing-windows-internal-3.png" alt="Handles" data-proofer-ignore></p><h2 id="finding-all-the-handles-in-user-mode"><span class="mr-2"><strong>Finding all the handles in User-mode</strong></span><a href="#finding-all-the-handles-in-user-mode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>One interesting thing in Windows is if you are in <strong>Integrity Level &gt;= Medium</strong>, then you can access handles to all processes, even kernel addresses of objects. <a href="https://twitter.com/aionescu">Alex</a> mentioned that KASLR is not designed to protect against processes with Medium Integrity or above. By the way, its one of the known methods to bypass <strong>KASLR</strong> (e.g when you have a write-what-where bug and don’t know where to modify then you can use one of the objects in the kernel as you have the addresses).</p><p>The PoC for this way is available on GitHub (<a href="https://github.com/SinaKarvandi/Process-Magics/tree/master/EnumAllHandles">https://github.com/SinaKarvandi/Process-Magics/tree/master/EnumAllHandles</a>) and you can see the results from the following images.</p><p><img data-src="../../assets/images/enum-all-handles-2.png" alt="Dumping all handles" data-proofer-ignore></p><p>Now you can see all the handles even from other processes (like system process) with an unprivileged (non-elevated UAC) user.</p><p><img data-src="../../assets/images/enum-all-handles-1.png" alt="All kernel handles and addresses" data-proofer-ignore></p><h2 id="handles-in-windows-kernel"><span class="mr-2"><strong>Handles In Windows Kernel</strong></span><a href="#handles-in-windows-kernel" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Let’s see how Windows saves and manages the handles in its kernel.</p><p>In process structure (<strong>nt!_EPROCESS</strong>) there is a field called “<strong>ObjectTable</strong>”.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_EPROCESS</span> <span class="o">-</span><span class="n">y</span> <span class="n">object</span>
   <span class="o">+</span><span class="mh">0x418</span> <span class="n">ObjectTable</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">_HANDLE_TABLE</span>
</pre></table></code></div></div><p>The <strong>nt!_HANDLE_TABLE</strong> is like this :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_HANDLE_TABLE</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">NextHandleNeedingPool</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">ExtraInfoPages</span>   <span class="o">:</span> <span class="n">Int4B</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">TableCode</span>        <span class="o">:</span> <span class="n">Uint8B</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">QuotaProcess</span>     <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">_EPROCESS</span>
   <span class="o">+</span><span class="mh">0x018</span> <span class="n">HandleTableList</span>  <span class="o">:</span> <span class="n">_LIST_ENTRY</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">UniqueProcessId</span>  <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">Flags</span>            <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">StrictFIFO</span>       <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">EnableHandleExceptions</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">Rundown</span>          <span class="o">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">Duplicated</span>       <span class="o">:</span> <span class="n">Pos</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">RaiseUMExceptionOnInvalidHandleClose</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">HandleContentionEvent</span> <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x038</span> <span class="n">HandleTableLock</span>  <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">FreeLists</span>        <span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">_HANDLE_TABLE_FREE_LIST</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">ActualEntry</span>      <span class="o">:</span> <span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="n">UChar</span>
   <span class="o">+</span><span class="mh">0x060</span> <span class="n">DebugInfo</span>        <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">_HANDLE_TRACE_DEBUG_INFO</span>
</pre></table></code></div></div><p>Using <em><strong>HandleTableList,</strong></em> you can traverse through each handle of your target process.</p><p>Each handle is defined in a structure called “<strong>nt!_HANDLE_TABLE_ENTRY</strong> “ and among these fields the most interesting one is <em><strong>GrantedAccessBits</strong></em>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_HANDLE_TABLE_ENTRY</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">VolatileLowValue</span> <span class="o">:</span> <span class="n">Int8B</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">LowValue</span>         <span class="o">:</span> <span class="n">Int8B</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">InfoTable</span>        <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">_HANDLE_TABLE_ENTRY_INFO</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">HighValue</span>        <span class="o">:</span> <span class="n">Int8B</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">NextFreeHandleEntry</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">_HANDLE_TABLE_ENTRY</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">LeafHandleValue</span>  <span class="o">:</span> <span class="n">_EXHANDLE</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">RefCountField</span>    <span class="o">:</span> <span class="n">Int8B</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">Unlocked</span>         <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">RefCnt</span>           <span class="o">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span> <span class="n">Bits</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">Attributes</span>       <span class="o">:</span> <span class="n">Pos</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">3</span> <span class="n">Bits</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">ObjectPointerBits</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">44</span> <span class="n">Bits</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">GrantedAccessBits</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span> <span class="n">Bits</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">NoRightsUpgrade</span>  <span class="o">:</span> <span class="n">Pos</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">Spare1</span>           <span class="o">:</span> <span class="n">Pos</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">6</span> <span class="n">Bits</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">Spare2</span>           <span class="o">:</span> <span class="n">Uint4B</span>
</pre></table></code></div></div><p>There is a command (<strong>!handle</strong>) in windbg which used to show the details about the handle.</p><p>The following picture describes the details of each field in <strong>!handle</strong>.</p><p><img data-src="../../assets/images/windbg-handle.png" alt="!handle windbg" data-proofer-ignore></p><h2 id="changing-handles-grantedaccess"><span class="mr-2"><strong>Changing Handles GrantedAccess</strong></span><a href="#changing-handles-grantedaccess" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you map (<strong>Entry</strong>) field to the <strong>_HANDLE_TABLE_ENTRY</strong> then you can see the following results.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_HANDLE_TABLE_ENTRY</span> <span class="n">ffffa30c9aa26010</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">VolatileLowValue</span> <span class="o">:</span> <span class="mi">0</span><span class="n">n</span><span class="o">-</span><span class="mi">1981244744615788709</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">LowValue</span>         <span class="o">:</span> <span class="mi">0</span><span class="n">n</span><span class="o">-</span><span class="mi">1981244744615788709</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">InfoTable</span>        <span class="o">:</span> <span class="mh">0xe4813466</span><span class="err">`</span><span class="n">e010ff5b</span> <span class="n">_HANDLE_TABLE_ENTRY_INFO</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">HighValue</span>        <span class="o">:</span> <span class="mi">0</span><span class="n">n2097151</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">NextFreeHandleEntry</span> <span class="o">:</span> <span class="mh">0x00000000</span><span class="err">`</span><span class="mo">001</span><span class="n">fffff</span> <span class="n">_HANDLE_TABLE_ENTRY</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">LeafHandleValue</span>  <span class="o">:</span> <span class="n">_EXHANDLE</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">RefCountField</span>    <span class="o">:</span> <span class="mi">0</span><span class="n">n</span><span class="o">-</span><span class="mi">1981244744615788709</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">Unlocked</span>         <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">RefCnt</span>           <span class="o">:</span> <span class="mi">0</span><span class="n">y0111111110101101</span> <span class="p">(</span><span class="mh">0x7fad</span><span class="p">)</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">Attributes</span>       <span class="o">:</span> <span class="mi">0</span><span class="n">y000</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">ObjectPointerBits</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y11100100100000010011010001100110111000000001</span> <span class="p">(</span><span class="mh">0xe4813466e01</span><span class="p">)</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">GrantedAccessBits</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0000111111111111111111111</span> <span class="p">(</span><span class="mh">0x1fffff</span><span class="p">)</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">NoRightsUpgrade</span>  <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">Spare1</span>           <span class="o">:</span> <span class="mi">0</span><span class="n">y000000</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">Spare2</span>           <span class="o">:</span> <span class="mi">0</span>
</pre></table></code></div></div><p>Note that, <strong>0x1fffff</strong> means <strong>FULL CONTROL</strong>. You easily change the access bit, e.g using “eb”. For example when you use a command like “eb ffffa30c9aa26010+8 ee” then if you see the handle again (<strong>!handle 0x04</strong>) you can see that <strong>GrantedAccess</strong> is changed.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">PROCESS</span> <span class="n">ffffe4813466e040</span>
    <span class="n">SessionId</span><span class="o">:</span> <span class="n">none</span>  <span class="n">Cid</span><span class="o">:</span> <span class="mo">0004</span>    <span class="n">Peb</span><span class="o">:</span> <span class="mo">00000000</span>  <span class="n">ParentCid</span><span class="o">:</span> <span class="mo">0000</span>
    <span class="n">DirBase</span><span class="o">:</span> <span class="mo">001</span><span class="n">aa002</span>  <span class="n">ObjectTable</span><span class="o">:</span> <span class="n">ffffa30c9aa06580</span>  <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">2986</span><span class="p">.</span>
    <span class="n">Image</span><span class="o">:</span> <span class="n">System</span>

<span class="n">Kernel</span> <span class="n">handle</span> <span class="n">table</span> <span class="n">at</span> <span class="n">ffffa30c9aa06580</span> <span class="n">with</span> <span class="mi">2986</span> <span class="n">entries</span> <span class="n">in</span> <span class="n">use</span>

<span class="mo">0004</span><span class="o">:</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffffe4813466e040</span>  <span class="n">GrantedAccess</span><span class="o">:</span> <span class="mo">001</span><span class="n">fffee</span> <span class="p">(</span><span class="n">Protected</span><span class="p">)</span> <span class="n">Entry</span><span class="o">:</span> <span class="n">ffffa30c9aa26010</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffe4813466e040</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffe4813467b0c0</span><span class="p">)</span> <span class="n">Process</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffe4813466e010</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
        <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">4</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">131188</span>
</pre></table></code></div></div><p>There is a good post <a href="https://github.com/notscimmy/libelevate">here</a> which describes how the above method can be used in order to bypass the restrictions that a driver can put on a special process or each process that tries to access memory of a protected-process, for example, a game with anit-cheat protection or a security software which protects its memory from being accessed by a remote process and APIs like <strong>WriteProcessMemory</strong> or <strong>ReadProcessMemory</strong>).</p><p>Let’s see some other functions relating to the handles.</p><p>There is a function <strong>ExEnumHandleTable</strong> which enumerates all the handle from a process by passing a pointer to process’s <strong>ObjectTable</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">NTKERNELAPI</span>
<span class="n">BOOLEAN</span>
<span class="n">ExEnumHandleTable</span> <span class="p">(</span>
    <span class="n">__in</span> <span class="n">PHANDLE_TABLE</span> <span class="n">HandleTable</span><span class="p">,</span>
    <span class="n">__in</span> <span class="n">EX_ENUMERATE_HANDLE_ROUTINE</span> <span class="n">EnumHandleProcedure</span><span class="p">,</span>
    <span class="n">__in</span> <span class="n">PVOID</span> <span class="n">EnumParameter</span><span class="p">,</span>
    <span class="n">__out_opt</span> <span class="n">PHANDLE</span> <span class="n">Handle</span>
    <span class="p">)</span>
</pre></table></code></div></div><p>Also, there is a function <strong>ExpLookupHandleTableEntry</strong> which gets the handle table as its first argument (RCX) and the handle value as the second argument (RDX) and returns the <strong>_HANDLE_TABLE_ENTRY</strong> corresponding to that handle. You can use them in your driver or shellcode.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PHANDLE_TABLE_ENTRY</span>
<span class="n">ExpLookupHandleTableEntry</span> <span class="p">(</span>
    <span class="n">IN</span> <span class="n">PHANDLE_TABLE</span> <span class="n">HandleTable</span><span class="p">,</span>
    <span class="n">IN</span> <span class="n">EXHANDLE</span> <span class="n">tHandle</span>
    <span class="p">)</span>
</pre></table></code></div></div><h2 id="callbacks-for-processes"><span class="mr-2"><strong>Callbacks for processes</strong></span><a href="#callbacks-for-processes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In order to set callback whenever a handle to a process is requested or whatever relating to the handles of Threads or Processes, you can <strong><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obregistercallbacks">ObRegisterCallbacks</a></strong> function.</p><p>The <strong>ObRegisterCallbacks</strong> routine registers a list of callback routines for thread, process, and desktop handle operations.</p><p>The sample for using <strong>ObRegisterCallbacks</strong> is available on GitHub :</p><p>[<a href="https://github.com/SinaKarvandi/misc/tree/master/ObRegisterCallbacks">https://github.com/SinaKarvandi/misc/tree/master/ObRegisterCallbacks</a>]</p><p>If you load the above driver, you’ll get the following NTSTATUS error :</p><p><em>“{Access Denied} A process has requested access to an object, but has not been granted those access rights.”</em></p><p>If we look at the decompiled code from IDA and look for the error code (<strong>0xC0000022</strong>), we’ll reach to the following pseudo-code.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>      <span class="k">if</span> <span class="p">(</span> <span class="n">v14</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">MmVerifyCallbackFunctionCheckFlags</span><span class="p">(</span><span class="n">v14</span><span class="p">,</span> <span class="mi">32</span><span class="n">i64</span><span class="p">)</span> <span class="p">)</span>
          <span class="k">goto</span> <span class="n">LABEL_23</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v13</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">v15</span> <span class="o">=</span> <span class="n">v13</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v15</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">MmVerifyCallbackFunctionCheckFlags</span><span class="p">(</span><span class="n">v15</span><span class="p">,</span> <span class="mi">32</span><span class="n">i64</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
<span class="nl">LABEL_23:</span>
        <span class="n">v5</span> <span class="o">=</span> <span class="mh">0xC0000022</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">LABEL_24</span><span class="p">;</span>
      <span class="p">}</span>
</pre></table></code></div></div><p>It’s clear that <strong>MmVerifyCallbackFunctionCheckFlags</strong> is the guilty function, I don’t find a way to register my unsigned driver but for this let’s just patch it.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="mi">0</span><span class="o">:</span>  <span class="mi">48</span> <span class="n">c7</span> <span class="n">c0</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span>    <span class="n">mov</span>    <span class="n">rax</span><span class="p">,</span><span class="mh">0x1</span>
<span class="mi">7</span><span class="o">:</span>  <span class="n">c3</span>                      <span class="n">ret</span>
</pre></table></code></div></div><p>The above assembly code is enough to always return true so we need to execute the following windbg command:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">eb</span> <span class="n">nt</span><span class="o">!</span><span class="n">MmVerifyCallbackFunctionCheckFlags</span> <span class="mi">48</span> <span class="n">c7</span> <span class="n">c0</span> <span class="mo">01</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="n">c3</span>
</pre></table></code></div></div><p><strong>Update 1</strong>: As <a href="https://twitter.com/yarden_shafir">Yarden</a> mentioned, linking in with <strong>/INTEGRITYCHECK</strong> will save you the need to patch the kernel from the debugger so instead of using the above command you can add <strong>/INTEGRITYCHECK</strong> to your linker when you’re compiling your driver.</p><p>Now load the driver again. If you encounter errors like: “<em>An instance already exists at this altitude on the volume specified</em>”, then you have to change the following line :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>	<span class="n">RtlInitUnicodeString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Altitude</span><span class="p">,</span> <span class="s">L"1001"</span><span class="p">);</span>
</pre></table></code></div></div><p>Make sure to run the following windbg command if you previously didn’t enable the debugging outputs.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre> <span class="n">eb</span> <span class="n">nt</span><span class="o">!</span><span class="n">kd_default_mask</span> <span class="n">ff</span> <span class="n">ff</span> <span class="n">ff</span> <span class="n">ff</span>
</pre></table></code></div></div><p>After running driver, you have to see each handle request to processes or threads with its desired access masks and the corresponding operation (e.g creating a handle or duplicate handle or whatever).</p><p>Finally, we’ll get the following results :</p><p><img data-src="../../assets/images/ObRegisterCallback-log.png" alt="Callback results" data-proofer-ignore></p><h1 id="handle-creation-process"><strong>Handle Creation Process</strong></h1><p>Now that we know some of the basic concepts from callbacks and handle tables, let’s have a comprehensive survey from user-mode <strong>OpenProcess</strong> until we come back to user-mode again so we can see how Windows creates handle and saves it on its handle table.</p><p>The following functions have to be called in order to make a handle available to the user-mode in the case of opening a handle to a process.</p><p><strong>OpenProcess (user-mode) -&gt; NtOpenProcess (user-mode) -&gt; NtOpenProcess (kernel-mode) -&gt; PsOpenProcess - &gt; ObOpenObjectByPointer -&gt; ObpCreateHandle</strong></p><p>If you remeber from the <strong>ObRegisterCallbacks</strong>, our callbacks called from “<strong>ObpCallPreOperationCallbacks</strong>” and this function is called by <strong>ObpCreateHandle</strong>. Also “<strong>ObpCallPostOperationCallbacks</strong>” is responsible for calling our post operation callbacks (we’ll see them).</p><p>Let’s start with <strong>OpenProcess</strong>, here is an ordered decompiled version of <strong>OpenProcess</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">HANDLE</span> <span class="kr">__stdcall</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="n">BOOL</span> <span class="n">bInheritHandle</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwProcessId</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax</span>
  <span class="n">CLIENT_ID</span> <span class="n">ClientId</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-48h]</span>
  <span class="n">OBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">;</span> <span class="c1">// [rsp+30h] [rbp-38h]</span>
  <span class="n">HANDLE</span> <span class="n">ProcessHandle</span><span class="p">;</span> <span class="c1">// [rsp+88h] [rbp+20h]</span>

  <span class="n">ObjectAttributes</span><span class="p">.</span><span class="n">Length</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
  <span class="n">ObjectAttributes</span><span class="p">.</span><span class="n">RootDirectory</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
  <span class="n">ClientId</span> <span class="o">=</span> <span class="p">(</span><span class="n">CLIENT_ID</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)(</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)</span><span class="n">dwProcessId</span><span class="p">;</span>
  <span class="n">ObjectAttributes</span><span class="p">.</span><span class="n">Attributes</span> <span class="o">=</span> <span class="n">bInheritHandle</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">ObjectAttributes</span><span class="p">.</span><span class="n">ObjectName</span> <span class="o">=</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
  <span class="n">_mm_storeu_si128</span><span class="p">((</span><span class="n">__m128i</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ObjectAttributes</span><span class="p">.</span><span class="n">SecurityDescriptor</span><span class="p">,</span> <span class="p">(</span><span class="n">__m128i</span><span class="p">)</span><span class="mi">0</span><span class="n">i64</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">NtOpenProcess</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ProcessHandle</span><span class="p">,</span> <span class="n">dwDesiredAccess</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ObjectAttributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ClientId</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">ProcessHandle</span><span class="p">;</span>
  <span class="n">BaseSetLastNTError</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="n">i64</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Among the above parameters, <strong>dwProcessId</strong> and <strong>dwDesiredAccess</strong> is not in our interest as they’re more and less clear but the most interesting field here is <strong>ObjectAttributes</strong>, Microsoft explains about Object Attributes <a href="https://technet.microsoft.com/es-es/ff557749(v=vs.71)">here</a>. The structure is below, you can read about each field in MSDN.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_ATTRIBUTES64</span> <span class="p">{</span>
    <span class="n">ULONG</span> <span class="n">Length</span><span class="p">;</span>
    <span class="n">ULONG64</span> <span class="n">RootDirectory</span><span class="p">;</span>
    <span class="n">ULONG64</span> <span class="n">ObjectName</span><span class="p">;</span>
    <span class="n">ULONG</span> <span class="n">Attributes</span><span class="p">;</span>
    <span class="n">ULONG64</span> <span class="n">SecurityDescriptor</span><span class="p">;</span>
    <span class="n">ULONG64</span> <span class="n">SecurityQualityOfService</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_ATTRIBUTES64</span><span class="p">;</span>
</pre></table></code></div></div><p>The above field has some <strong>Attributes</strong> that is interesting to us, their definition as defined in <a href="https://github.com/tpn/winsdk-10/blob/master/Include/10.0.10240.0/shared/ntdef.h">SDK</a> :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="cp">#define OBJ_INHERIT             			0x00000002L
#define OBJ_PERMANENT           			0x00000010L
#define OBJ_EXCLUSIVE           			0x00000020L
#define OBJ_CASE_INSENSITIVE    			0x00000040L
#define OBJ_OPENIF              			0x00000080L
#define OBJ_OPENLINK            			0x00000100L
#define OBJ_KERNEL_HANDLE       			0x00000200L
#define OBJ_FORCE_ACCESS_CHECK  			0x00000400L
#define OBJ_IGNORE_IMPERSONATED_DEVICEMAP		0x00000800L
#define OBJ_VALID_ATTRIBUTES    			0x00000FF2L
</span></pre></table></code></div></div><p>We’ll see how they affect process handle creation, later.</p><h2 id="ntopenprocess"><span class="mr-2"><strong>NtOpenProcess</strong></span><a href="#ntopenprocess" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>NtOpenProcess</strong>, first checks for its previous mode (user-mode or kernel-mode) then it calls <strong>PsOpenProcess</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">__kernel_entry</span> <span class="n">NTSYSCALLAPI</span> <span class="n">NTSTATUS</span> <span class="nf">NtOpenProcess</span><span class="p">(</span>
  <span class="n">PHANDLE</span>            <span class="n">ProcessHandle</span><span class="p">,</span>
  <span class="n">ACCESS_MASK</span>        <span class="n">DesiredAccess</span><span class="p">,</span>
  <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
  <span class="n">PCLIENT_ID</span>         <span class="n">ClientId</span>
<span class="p">);</span>
</pre></table></code></div></div><h2 id="psopenprocess"><span class="mr-2"><strong>PsOpenProcess</strong></span><a href="#psopenprocess" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The <strong>PsOpenProcess</strong> is something like this, it’s not documented so it’s based on IDA’s decompile results:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">NTSTATUS</span>
<span class="n">FASTCALL</span>
<span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">PsOpenProcess</span><span class="p">(</span>
<span class="n">PHANDLE</span> <span class="n">ProcessHandle</span><span class="p">,</span> 
<span class="n">ACCESS_MASK</span> <span class="n">DesiredAccess</span><span class="p">,</span>
 <span class="n">POBJECT_ATTRIBUTES</span> <span class="n">ObjectAttributes</span><span class="p">,</span>
 <span class="n">PCLIENT_ID</span> <span class="n">ClientId</span><span class="p">,</span> 
<span class="kt">char</span> <span class="n">PreviousMode</span><span class="p">,</span> 
<span class="kt">char</span> <span class="n">PreviousMode2</span><span class="p">);</span>
</pre></table></code></div></div><p>In <strong>PsOpenProcess</strong>, it first checks whether the handle pointer resides to valid user-mode address then it limits the user-mode handles to <strong>0x1df2</strong>. From the following picture, you can see this limitation on handles and their meanings.</p><p><img data-src="../../assets/images/reversing-windows-internal-3.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>In the case of kernel <strong>attributes</strong>, it limits the handle to the following values.</p><p><img data-src="../../assets/images/PsOpenProcess-attributes-kernel.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>As you can see, you don’t have access to <strong>OBJ_KERNEL_HANDLE</strong> and <strong>OBJ_VALID_ATTRIBUTES</strong> in user-mode and also some undocumented values <strong>0x11800</strong> which is not revealed by Microsoft.</p><p>In <strong>PsOpenProcess</strong>, the next check is for <strong>SeDebugPrivilege</strong>. As you might know, this is one of the powerful privileges in Windows that causes to bypass any Privilege checks and give the needed accesses directly. You might see it in tools like <strong>Mimikatz</strong>. It then passes it to the <strong>SePrivilegedServiceAuditAlarm</strong>. <strong>SePrivilegedServiceAuditAlarm</strong> is to be called whenever a privileged system service is attempted.</p><p><img data-src="../../assets/images/SeDebugPrivilege.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>Finally, <strong>PsOpenProcess</strong> calls <strong>ObOpenObjectByPointer</strong>.</p><h2 id="obopenobjectbypointer"><span class="mr-2"><strong>ObOpenObjectByPointer</strong></span><a href="#obopenobjectbypointer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In order to explain about <strong>ObOpenObjectByPointer</strong>, First, we have to know about two structures “<strong>ACCESS_STATE</strong>” and “<strong>SECURITY_SUBJECT_CONTEXT</strong>”.</p><h2 id="security_subject_context"><span class="mr-2"><strong>SECURITY_SUBJECT_CONTEXT</strong></span><a href="#security_subject_context" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The <strong><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_security_subject_context">SECURITY_SUBJECT_CONTEXT</a></strong> is used to capture the subject security context for access validation and auditing. It’s like dumping a special context’s token, then lock it in order to avoid any modification and finally do some privilege checks.</p><p>Functions like <strong><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-secapturesubjectcontext">SeCaptureSubjectContext</a></strong> or <strong>SeCaptureSubjectContextEx</strong> return a pointer to this structure.</p><p>For example, the following code shows how this structure can be used to do some privilege checks.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="n">BOOLEAN</span> <span class="nf">HasPrivilege</span><span class="p">(</span><span class="n">IN</span> <span class="n">PPRIVILEGE_SET</span> <span class="n">Privilege</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BOOLEAN</span> <span class="n">Result</span><span class="p">;</span>
	<span class="n">SECURITY_SUBJECT_CONTEXT</span> <span class="n">SubjectContext</span><span class="p">;</span>

	<span class="cm">/* Capture and lock the security subject context */</span>
	<span class="n">SeCaptureSubjectContext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SubjectContext</span><span class="p">);</span>
	<span class="n">SeLockSubjectContext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SubjectContext</span><span class="p">);</span>

	<span class="cm">/* Do privilege check */</span>
	<span class="n">Result</span> <span class="o">=</span> <span class="n">SePrivilegeCheck</span><span class="p">(</span><span class="n">Privilege</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SubjectContext</span><span class="p">,</span> <span class="n">UserMode</span><span class="p">);</span>

	<span class="cm">/* Audit the privilege */</span>
	<span class="n">SePrivilegeObjectAuditAlarm</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">SubjectContext</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">Privilege</span><span class="p">,</span>
		<span class="n">Result</span><span class="p">,</span>
		<span class="n">UserMode</span><span class="p">);</span>


	<span class="cm">/* Unlock and release the security subject context and return */</span>
	<span class="n">SeUnlockSubjectContext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SubjectContext</span><span class="p">);</span>
	<span class="n">SeReleaseSubjectContext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SubjectContext</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">Result</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>This structure is important because as <a href="https://twitter.com/tiraniddo">James Forshaw</a> mentioned in 3rd part of his <a href="https://tyranidslair.blogspot.com/2019/11/the-internals-of-applocker-part-3.html">post</a> about “<strong>AppLocker internals</strong>” :</p><p>A Windows access check takes 4 main parameters:</p><ul><li>A <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_security_subject_context">SECURITY_SUBJECT_CONTEXT</a> which identifies the caller’s access tokens.<li>A desired access mask.<li>A <a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-generic_mapping">GENERIC_MAPPING</a> structure which allows the access check to convert generic access to object-specific access rights.<li>And most importantly, the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-security_descriptor">Security Descriptor</a> which describes the security of the resource being checked.</ul><p><strong>SECURITY_SUBJECT_CONTEXT</strong> is coming from two above mentioned functions, <strong>DesiredAccess</strong> is also a parameter to <strong>ObOpenObjectByPointer</strong> and <strong>GenericMapping</strong> comes from <strong>_OBJECT_TYPE</strong>’s <strong>_OBJECT_TYPE_INITIALIZER+0x4c</strong> (I’ll describe about Object Types later in this post.) while security descriptor can be derived from the <strong>_OBJECT_HEADER’s +0x28</strong> and object header is also the first parameter to <strong>ObOpenObjectByPointer</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>   <span class="o">+</span><span class="mh">0x028</span> <span class="n">SecurityDescriptor</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">Void</span>
</pre></table></code></div></div><h2 id="access_state"><span class="mr-2"><strong>ACCESS_STATE</strong></span><a href="#access_state" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>As the MSDN describes, The <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_access_state">ACCESS_STATE</a> structure describes the state of an access in progress. It contains an object’s subject context, remaining desired access types, granted access types, and, optionally, a privilege set to indicate which privileges were used to permit the access.</p><p>Now, let’s return to <strong>ObOpenObjectByPointer</strong>, This function checks whether the caller passes an access state if not then it creates a new one based on the desired access and the object type’s <strong>generic mapping</strong> by calling <strong>SepCreateAccessStateFromSubjectContext</strong> , as the name implies it receives an <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/content/wdm/ns-wdm-_access_state">ACCESS_STATE</a> from the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_security_subject_context">SECURITY_SUBJECT_CONTEX</a>.</p><p>Eventually, it checks whether the the function itself (<strong>ObOpenObjectByPointer</strong>) creates <strong>ACCESS_STATE</strong> or not. If it creates, then it deletes the <strong>ACCESS_STATE</strong> and <strong>SECURITY_SUBJECT_CONTEXT</strong> using <strong>SepDeleteAccessState</strong> and <strong>SeReleaseSubjectContext</strong>.</p><p>Finally, this function calls the popular <strong>ObpCreateHandle</strong> which creates the handle.</p><p><img data-src="../../assets/images/PsOpenProcess.png" alt="IDA Decompiled Source" data-proofer-ignore></p><h2 id="obpcreatehandle"><span class="mr-2"><strong>ObpCreateHandle</strong></span><a href="#obpcreatehandle" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>For creating a handle, an undocumented function “<strong>ObpCreateHandle</strong>” is responsible for creating a new handle to an existing object. Generally, <strong><em>ObpCreateHandle</em></strong> creates an entry in the process’ handle table that becomes associated with the object.</p><p><strong>ObpCreateHandle</strong> defines like this: (there are some differences between current definition and WRK’s definition).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="n">__int64</span> <span class="kr">__fastcall</span> <span class="nf">ObpCreateHandle</span><span class="p">(</span>
 <span class="n">_OB_OPEN_REASON</span> <span class="n">OpenReason</span><span class="p">,</span>
 <span class="kt">void</span> <span class="o">*</span><span class="n">Object</span><span class="p">,</span>
 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">DesiredAccess</span><span class="p">,</span>
 <span class="n">_ACCESS_STATE</span> <span class="o">*</span><span class="n">AccessState</span><span class="p">,</span>
 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ObjectPointer</span><span class="p">,</span>
 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Attribute</span><span class="p">,</span>
 <span class="kt">char</span> <span class="n">AccessMode</span><span class="p">,</span>
 <span class="k">struct</span> <span class="n">_OBJECT_CREATE_INFO</span> <span class="o">*</span><span class="n">CreateInfo</span><span class="p">,</span>
 <span class="kt">int</span> <span class="n">AccessMask2</span><span class="p">,</span>
 <span class="n">PVOID</span> <span class="o">*</span><span class="n">NewObject</span><span class="p">,</span>
 <span class="n">PVOID</span> <span class="o">*</span><span class="n">Handle</span><span class="p">);</span>
</pre></table></code></div></div><p>The first argument to this function is <strong>_OB_OPEN_REASON</strong> which defines like this :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">enum</span> <span class="n">_OB_OPEN_REASON</span>
<span class="p">{</span>
         <span class="n">ObCreateHandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
         <span class="n">ObOpenHandle</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
         <span class="n">ObDuplicateHandle</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
         <span class="n">ObInheritHandle</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
         <span class="n">ObMaxOpenReason</span> <span class="o">=</span> <span class="mi">4</span>
<span class="p">}</span> <span class="n">OB_OPEN_REASON</span><span class="p">;</span>
</pre></table></code></div></div><p>From the above structure, you can see the cases where <strong>ObpCreateHandle</strong> might be used for.</p><p>If the handle is requested from kernel-mode then “<strong>ObpKernelHandleTable</strong>” is used as the handle table and if it’s a user-mode application then it calls <strong>ObReferenceProcessHandleTable</strong>.</p><p><img data-src="../../assets/images/reversing-windows-internal-1.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>The above function (<strong>ObReferenceProcessHandleTable</strong>), first checks whether it can acquire <strong>RundownProtect</strong> or not. When run-down protection is in effect, the driver can safely access the object without the risk that the object will be deleted before the access completes. You can imagine that if you use <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exacquirerundownprotection">ExAcquireRundownProtection</a> on this field (<strong>RundownProtect</strong>) then each attempt to create a handle by the special process will cause a <strong>0xC000010A</strong> error (<em>An attempt was made to access an exiting process.</em>).</p><p>This function finally returns <strong>Process-&gt;ObjectTable</strong>.</p><p>In the end, <strong>ObpCreateHandle</strong> calls <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-exreleaserundownprotection"><strong>ExReleaseRundownProtection</strong></a> which releases the <strong>RundownProtect</strong> of our process.</p><p>After that, <strong>ObpCreateHandle</strong> calls some undocumented Callbacks (<strong><em>SecurityProcedure</em></strong>). I’ll give a detailed explanation about these kinds of callbacks later on this topic but for now, it first checks whether <em><strong>SecurityProcedure</strong></em> is <strong>SeDefaultObjectMethod</strong> or not. <strong>SeDefaultObjectMethod</strong> is the default security method for objects. It is responsible for either retrieving, setting, and deleting the security descriptor of an object. It is not used to assign the original security descriptor to an object and as you can see if our callback fails with <em>{buffer too small}</em> error then it tries to call it once more so by now, you know that this callback is responsible for changing <strong>SecurityDescriptor</strong> of any object type (each object type separately using <em><strong>ObjectType’s SecurityProcedure</strong></em>).</p><p>Don’t worry if things are not clear, after reading the last part (about <strong>ObjectTypes</strong>) you can return here and read it once again and sure you’ll understand it.</p><p><img data-src="../../assets/images/reversing-windows-internal-2.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>As you can see, these object type callbacks called for each object separately and it’s not specific to a special object (e.g Process, Thread, or Desktop objects).</p><p>After making <em><strong>SecurityDescriptor</strong></em> ready, it’s time to perform security checks, <strong>ObpCreateHandle</strong> calls <strong><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-seaccesscheck">SeAccessCheck</a></strong>. The <strong>SeAccessCheck</strong> routine determines whether the requested access rights can be granted to an object protected by a security descriptor and an object owner so <strong>ObpCreateHandle</strong> passes the <strong>SecurityDescriptor</strong> of object and <strong>AccessState</strong> that we have from the previous function to see if the access is granted or not.</p><p>As I told you above, <strong>ObpCreateHandle</strong> calls <strong>ObpCallPreOperationCallbacks</strong> and this function is responsible for calling callbacks that are registered by <strong>ObRegisterCallbacks</strong> but in contrast with above callbacks, these callbacks are limited to some object types (e.g Process, Thread, or Desktop).</p><p>This limitation is done by the following check, which checks whether object type supports callbacks and if there is any callback registered.</p><p>Later, we have a section called “<strong>Finding Types which support callback</strong>”, it describes how to find these object types but keep in mind, if you set Support Callback bit of an object manually, then PatchGuard comes in and leads to a BSOD.</p><p><img data-src="../../assets/images/PreOperationCallbacks-checks.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>In order to assign a handle, it first acquires a lock to <em><strong>HANDLE_TABLE</strong>.<strong>HandleTableLock</strong></em> and then search through <strong><em>HANDLE_TABLE.FreeLists</em></strong>. If there isn’t any empty place in our handle table (based on <strong>NextHandleNeedingPool</strong> index) then it tries to allocate a new handle table entry for the specified handle table using <strong>ExpAllocateHandleTableEntrySlow</strong>.</p><p>Now, it’s time to compute the handle’s value.</p><p><img data-src="../../assets/images/compute-handle.png" alt="IDA Decompiled Source" data-proofer-ignore></p><p>When the handle is computed, it calls <strong>ExpSetHandleExtraInfo</strong> which gets the <strong>HandleTable</strong> and <strong>Handle</strong> and sets the <strong>_HANDLE_TABLE_ENTRY_INFO</strong> to the handle entry.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">_HANDLE_TABLE_ENTRY_INFO</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">AuditMask</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MaxRelativeAccessMask</span><span class="p">;</span>
<span class="p">};</span>
</pre></table></code></div></div><p><strong>ExpSetHandleExtraInfo</strong> is used to set <strong>AuditMask</strong> and <strong>AccessMask</strong> to the handle and you can see that it removes the handle if the above function failed (using <strong>ExpFreeHandleTableEntry</strong>).</p><p>And finally, it sets the handle value :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>  <span class="n">HandleAddress</span> <span class="o">=</span> <span class="n">___MainHandle</span> <span class="o">|</span> <span class="mh">0xFFFFFFFF80000000u</span><span class="n">i64</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">IsKernelHandle</span> <span class="p">)</span>
    <span class="n">HandleAddress</span> <span class="o">=</span> <span class="n">___MainHandle</span><span class="p">;</span>
  <span class="o">*</span><span class="n">_Handle</span> <span class="o">=</span> <span class="n">HandleAddress</span><span class="p">;</span>
</pre></table></code></div></div><p>As you can see, if the handle is user-mode handle then it strips the kernel address bit otherwise it’s a kernel handle and address itself is the handle.</p><p>This behavior will be changed in the future if Windows starts supporting <strong>S</strong>upervisor <strong>M</strong>ode <strong>A</strong>ccess <strong>P</strong>revention (<strong>SMAP</strong>) because as long as they use this protection, they won’t be able to directly write on user-mode addresses and they have to execute extra instruction for this purpose.</p><p>The last step is calling <strong>ObpPostInterceptHandleCreate</strong> this function calls <strong>ObpCallPostOperationCallbacks</strong> and its responsible for calling Post Operation Callbacks.</p><p><img data-src="../../assets/images/anime-moon.jpg" alt="Animmmeeeee :)" data-proofer-ignore></p><h1 id="objecttypes-in-windows"><strong>ObjectTypes in Windows</strong></h1><p>If you’d ever used functions like <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obreferenceobjectbyhandle">ObReferenceObjectByHandle</a>, <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-obreferenceobjectbypointer">ObReferenceObjectByPointer</a>, <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-obopenobjectbypointer">ObOpenObjectByPointer</a> or other functions then you’ve probably heard of <strong>POBJECT_TYPE</strong>.</p><p>Also, creation routines for the various objects, like <strong>IoCreateDriver</strong> or <strong>PspCreateProcess</strong>, call the generic <strong>ObCreateObject</strong> and pass it a pointer to an appropriate <strong>_OBJECT_TYPE</strong> structure.</p><p><strong>_OBJECT_TYPE</strong> is one of the important structures in Windows that stores the definition of different object like Process, Thread, Mutex, etc. If you want to know the difference between NT objects and non-objects you can read the article “<a href="https://blogs.msdn.microsoft.com/doronh/2006/12/04/what-is-pobject_type/">What is POBJECT_TYPE?</a>”.</p><p>Let’s see the definition:</p><p>(I dumped the structures using <a href="https://github.com/wbenny/pdbex">pdbex</a> written by one of my best friends <a href="https://twitter.com/PetrBenes">Petr Benes</a>)</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_OBJECT_TYPE</span>
<span class="p">{</span>
  <span class="cm">/* 0x0000 */</span> <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="n">TypeList</span><span class="p">;</span>
  <span class="cm">/* 0x0010 */</span> <span class="k">struct</span> <span class="n">_UNICODE_STRING</span> <span class="n">Name</span><span class="p">;</span>
  <span class="cm">/* 0x0020 */</span> <span class="kt">void</span><span class="o">*</span> <span class="n">DefaultObject</span><span class="p">;</span>
  <span class="cm">/* 0x0028 */</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Index</span><span class="p">;</span>
  <span class="cm">/* 0x0029 */</span> <span class="kt">char</span> <span class="n">Padding_1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="cm">/* 0x002c */</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TotalNumberOfObjects</span><span class="p">;</span>
  <span class="cm">/* 0x0030 */</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">TotalNumberOfHandles</span><span class="p">;</span>
  <span class="cm">/* 0x0034 */</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">HighWaterNumberOfObjects</span><span class="p">;</span>
  <span class="cm">/* 0x0038 */</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">HighWaterNumberOfHandles</span><span class="p">;</span>
  <span class="cm">/* 0x003c */</span> <span class="kt">long</span> <span class="n">Padding_2</span><span class="p">;</span>
  <span class="cm">/* 0x0040 */</span> <span class="k">struct</span> <span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="n">TypeInfo</span><span class="p">;</span>
  <span class="cm">/* 0x00b8 */</span> <span class="k">struct</span> <span class="n">_EX_PUSH_LOCK</span> <span class="n">TypeLock</span><span class="p">;</span>
  <span class="cm">/* 0x00c0 */</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">Key</span><span class="p">;</span>
  <span class="cm">/* 0x00c4 */</span> <span class="kt">long</span> <span class="n">Padding_3</span><span class="p">;</span>
  <span class="cm">/* 0x00c8 */</span> <span class="k">struct</span> <span class="n">_LIST_ENTRY</span> <span class="n">CallbackList</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OBJECT_TYPE</span><span class="p">,</span> <span class="o">*</span><span class="n">POBJECT_TYPE</span><span class="p">;</span> <span class="cm">/* size: 0x00d8 */</span>
</pre></table></code></div></div><h2 id="finding-process-object-type"><span class="mr-2"><strong>Finding Process Object Type</strong></span><a href="#finding-process-object-type" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I’ll talk about some important fields later in this post but for now, let’s see how we can find the <strong>_OBJECT_TYPE</strong> of a specific object, let say process, first find all the processes <strong>EPROCESS</strong>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">dml_proc</span>
<span class="n">Address</span>           <span class="n">PID</span>  <span class="n">Image</span> <span class="n">file</span> <span class="n">name</span>
<span class="n">ffffd689</span><span class="err">`</span><span class="n">fd06b380</span> <span class="mi">4</span>    <span class="n">System</span>         
<span class="n">ffffd689</span><span class="err">`</span><span class="n">fd0ad080</span> <span class="mi">44</span>   <span class="n">Registry</span>       
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">01</span><span class="mi">875040</span> <span class="mi">24</span><span class="n">c</span>  <span class="n">smss</span><span class="p">.</span><span class="n">exe</span>       
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">07</span><span class="n">bf74c0</span> <span class="mi">2</span><span class="n">a4</span>  <span class="n">csrss</span><span class="p">.</span><span class="n">exe</span>      
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">077</span><span class="mi">9</span><span class="n">c080</span> <span class="mi">304</span>  <span class="n">wininit</span><span class="p">.</span><span class="n">exe</span>    
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">077</span><span class="n">ae140</span> <span class="mi">30</span><span class="n">c</span>  <span class="n">csrss</span><span class="p">.</span><span class="n">exe</span>      
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">07</span><span class="n">b21080</span> <span class="mi">33</span><span class="n">c</span>  <span class="n">winlogon</span><span class="p">.</span><span class="n">exe</span>   
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">07</span><span class="n">b5c100</span> <span class="mi">378</span>  <span class="n">services</span><span class="p">.</span><span class="n">exe</span>   
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">07</span><span class="n">b5d080</span> <span class="mi">380</span>  <span class="n">lsass</span><span class="p">.</span><span class="n">exe</span>      
<span class="n">ffffd68a</span><span class="err">`</span><span class="mo">017</span><span class="n">a02c0</span> <span class="mi">3</span><span class="n">dc</span>  <span class="n">svchost</span><span class="p">.</span><span class="n">exe</span>  
	<span class="p">....</span>
</pre></table></code></div></div><p>I choose <em><strong>lsass.exe (ffffd68a07b5d080)</strong></em> as the target. As you might know, Windows saves each object (e.g <strong>_EPROCESS</strong>) like this :</p><ol><li>_POOL_HEADER<li>_OBJECT_QUOTA_CHARGES (optional)<li>_OBJECT_HANDLE_DB (optional)<li>_OBJECT_NAME (optional)<li>_OBJECT_CREATOR_INFO (optional)<li>_OBJECT_HEADER<li>object body (e.g _EPROCESS)</ol><p>So if we subtract <strong>sizeof(_OBJECT_HEADER)</strong> from the <strong>EPROCESS</strong> we’ll reach to the <strong>_OBJECT_HEADER</strong> of this object. (you can perform the same thing for <strong>_POOL_HEADER</strong> too.)</p><p>The object header is like this :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">PointerCount</span>     <span class="o">:</span> <span class="n">Int8B</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">HandleCount</span>      <span class="o">:</span> <span class="n">Int8B</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">NextToFree</span>       <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Lock</span>             <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x018</span> <span class="n">TypeIndex</span>        <span class="o">:</span> <span class="n">UChar</span>
   <span class="o">+</span><span class="mh">0x019</span> <span class="n">TraceFlags</span>       <span class="o">:</span> <span class="n">UChar</span>
   <span class="o">+</span><span class="mh">0x019</span> <span class="n">DbgRefTrace</span>      <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x019</span> <span class="n">DbgTracePermanent</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01a</span> <span class="n">InfoMask</span>         <span class="o">:</span> <span class="n">UChar</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">Flags</span>            <span class="o">:</span> <span class="n">UChar</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">NewObject</span>        <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">KernelObject</span>     <span class="o">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">KernelOnlyAccess</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">ExclusiveObject</span>  <span class="o">:</span> <span class="n">Pos</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">PermanentObject</span>  <span class="o">:</span> <span class="n">Pos</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">DefaultSecurityQuota</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">SingleHandleEntry</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">DeletedInline</span>    <span class="o">:</span> <span class="n">Pos</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x01c</span> <span class="n">Reserved</span>         <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">ObjectCreateInfo</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">_OBJECT_CREATE_INFORMATION</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">QuotaBlockCharged</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">SecurityDescriptor</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">Body</span>             <span class="o">:</span> <span class="n">_QUAD</span>
</pre></table></code></div></div><p>And the <strong>sizeof</strong> is :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="o">??</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER</span><span class="p">)</span>
<span class="kt">unsigned</span> <span class="n">int64</span> <span class="mh">0x38</span>
</pre></table></code></div></div><p>but wait, we’re in top of the object’s Body (means that <strong>EPROCESS</strong> or whatever starts at <strong>_OBJECT_HEADER+0x30</strong>) so we have to subtract -0x30 from the <strong>EPROCESS</strong> <em><strong>(ffffd68a`07b5d080-0x30 = ffffd68a07b5d050)</strong></em> .</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">ffffd68a07b5d050</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">PointerCount</span>     <span class="o">:</span> <span class="mi">0</span><span class="n">n458365</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">HandleCount</span>      <span class="o">:</span> <span class="mi">0</span><span class="n">n14</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">NextToFree</span>       <span class="o">:</span> <span class="mh">0x00000000</span><span class="err">`</span><span class="mo">0000000</span><span class="n">e</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Lock</span>             <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x018</span> <span class="n">TypeIndex</span>        <span class="o">:</span> <span class="mh">0x7a</span> <span class="sc">'z'</span>
   <span class="o">+</span><span class="mh">0x019</span> <span class="n">TraceFlags</span>       <span class="o">:</span> <span class="mi">0</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x019</span> <span class="n">DbgRefTrace</span>      <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x019</span> <span class="n">DbgTracePermanent</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01a</span> <span class="n">InfoMask</span>         <span class="o">:</span> <span class="mh">0x88</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">Flags</span>            <span class="o">:</span> <span class="mi">0</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">NewObject</span>        <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">KernelObject</span>     <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">KernelOnlyAccess</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">ExclusiveObject</span>  <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">PermanentObject</span>  <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">DefaultSecurityQuota</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">SingleHandleEntry</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01b</span> <span class="n">DeletedInline</span>    <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
   <span class="o">+</span><span class="mh">0x01c</span> <span class="n">Reserved</span>         <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">ObjectCreateInfo</span> <span class="o">:</span> <span class="mh">0xfffff803</span><span class="err">`</span><span class="mi">80468240</span> <span class="n">_OBJECT_CREATE_INFORMATION</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">QuotaBlockCharged</span> <span class="o">:</span> <span class="mh">0xfffff803</span><span class="err">`</span><span class="mi">80468240</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">SecurityDescriptor</span> <span class="o">:</span> <span class="mh">0xffffb082</span><span class="err">`</span><span class="mi">5308716</span><span class="n">c</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">Body</span>             <span class="o">:</span> <span class="n">_QUAD</span>
</pre></table></code></div></div><p>You can also confirm this by looking at the “<strong>ObjectHeader</strong>” field of “<strong>!object</strong>” command.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">object</span> <span class="n">ffffd68a</span><span class="err">`</span><span class="mo">07</span><span class="n">b5d080</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffd68a07b5d080</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffd689fd09a4e0</span><span class="p">)</span> <span class="n">Process</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffd68a07b5d050</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">14</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">458365</span>
</pre></table></code></div></div><p>In Windows, each object is derived from a special type and even each type (like process, thread, token) derived from another type called “<strong>type</strong>”.</p><p>Let’s see.</p><p>In the above code you can see there is a “<strong>Type: (ffffd689fd09a4e0) Process</strong>” if we map this to <strong>nt!_OBJECT_TYPE</strong>, we can it’s “<strong>Name</strong>” which is “<strong>Process</strong>”.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="n">ffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span>         <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span> <span class="p">]</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span>             <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Process"</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">DefaultObject</span>    <span class="o">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> 
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">Index</span>            <span class="o">:</span> <span class="mh">0x7</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">TotalNumberOfObjects</span> <span class="o">:</span> <span class="mh">0x85</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">TotalNumberOfHandles</span> <span class="o">:</span> <span class="mh">0x45b</span>
   <span class="o">+</span><span class="mh">0x034</span> <span class="n">HighWaterNumberOfObjects</span> <span class="o">:</span> <span class="mh">0x97</span>
   <span class="o">+</span><span class="mh">0x038</span> <span class="n">HighWaterNumberOfHandles</span> <span class="o">:</span> <span class="mh">0x518</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">TypeInfo</span>         <span class="o">:</span> <span class="n">_OBJECT_TYPE_INITIALIZER</span>
   <span class="o">+</span><span class="mh">0x0b8</span> <span class="n">TypeLock</span>         <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x0c0</span> <span class="n">Key</span>              <span class="o">:</span> <span class="mh">0x636f7250</span>
   <span class="o">+</span><span class="mh">0x0c8</span> <span class="n">CallbackList</span>     <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffb082</span><span class="err">`</span><span class="mi">4</span><span class="n">f982140</span> <span class="o">-</span> <span class="mh">0xffffb082</span><span class="err">`</span><span class="mi">4</span><span class="n">f8f5fb0</span> <span class="p">]</span>
</pre></table></code></div></div><p>This <strong>_OBJECT_TYPE</strong> (process) is also mapped to a global variable called “<strong>nt!PsProcessType</strong>” (Do you remember we filled <em><strong>OB_OPERATION_REGISTRATION.ObjectType</strong></em> with <em><strong>PsProcessType</strong></em> and <strong><em>PsThreadType</em></strong> ?) and These global variables are <strong>OBJECT_TYPE**</strong>, not just single indirection pointers.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dq</span> <span class="n">nt</span><span class="o">!</span><span class="n">PsProcessType</span> <span class="n">L1</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">8056</span><span class="n">f390</span>  <span class="n">ffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span>
</pre></table></code></div></div><h2 id="typeindex-in-object-types"><span class="mr-2"><strong>TypeIndex in Object Types</strong></span><a href="#typeindex-in-object-types" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Another important field from <strong>_OBJECT_HEADER</strong> is <strong><em>TypeIndex</em></strong>.</p><p>Let’s review this line again :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>   <span class="o">+</span><span class="mh">0x018</span> <span class="n">TypeIndex</span>        <span class="o">:</span> <span class="mh">0x7a</span> <span class="sc">'z'</span>
</pre></table></code></div></div><p>This field didn’t exist in until Windows Seven, means that before Windows Seven each <strong>_OBJECT_HEADER</strong> has a field called “<strong>Type</strong>” which was a pointer to its “<strong>_OBJECT_TYPE</strong>”, that’s the reason for (old version) and (new version) in <strong><em>!object</em></strong>’s results. You can read more about it in the article in <a href="https://codemachine.com/article_objectheader.html">CodeMachine</a>.</p><p>But in the newer versions of Windows (&gt; Windows 7) you can see <strong>TypeIndex</strong>. Instead of pointing directly to the <strong>OBJECT_TYPE</strong> data structure, the object header now contains an index into a new global data structure <strong>nt!ObTypeIndexTable</strong>, which is an array of pointers to the different <strong>OBJECT_TYPE</strong> structures.</p><p>The following command is used to get the <strong>_OBJECT_TYPE</strong> of target index, note that in this example 0x7 is index and <strong>@$ptrsize</strong> is defined by Windbg which shows either your pointer are 8 Bytes (x64) or 4 Bytes (x86).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="n">poi</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">ObTypeIndexTable</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7</span><span class="o">*</span><span class="err">@$</span><span class="n">ptrsize</span><span class="p">))</span> 
</pre></table></code></div></div><p>You can see the result here :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="n">poi</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">ObTypeIndexTable</span><span class="o">+</span><span class="p">(</span><span class="mh">0x7</span><span class="o">*</span><span class="err">@$</span><span class="n">ptrsize</span><span class="p">))</span> 
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span>         <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span> <span class="p">]</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span>             <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Process"</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">DefaultObject</span>    <span class="o">:</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span> 
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">Index</span>            <span class="o">:</span> <span class="mh">0x7</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">TotalNumberOfObjects</span> <span class="o">:</span> <span class="mh">0x85</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">TotalNumberOfHandles</span> <span class="o">:</span> <span class="mh">0x45b</span>
   <span class="o">+</span><span class="mh">0x034</span> <span class="n">HighWaterNumberOfObjects</span> <span class="o">:</span> <span class="mh">0x97</span>
   <span class="o">+</span><span class="mh">0x038</span> <span class="n">HighWaterNumberOfHandles</span> <span class="o">:</span> <span class="mh">0x518</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">TypeInfo</span>         <span class="o">:</span> <span class="n">_OBJECT_TYPE_INITIALIZER</span>
   <span class="o">+</span><span class="mh">0x0b8</span> <span class="n">TypeLock</span>         <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x0c0</span> <span class="n">Key</span>              <span class="o">:</span> <span class="mh">0x636f7250</span>
   <span class="o">+</span><span class="mh">0x0c8</span> <span class="n">CallbackList</span>     <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffb082</span><span class="err">`</span><span class="mi">4</span><span class="n">f982140</span> <span class="o">-</span> <span class="mh">0xffffb082</span><span class="err">`</span><span class="mi">4</span><span class="n">f8f5fb0</span> <span class="p">]</span>
</pre></table></code></div></div><p>But wait, in or example we see that (<strong>TypeIndex : 0x7a</strong>) and its index is not <strong>0x7a</strong>! It turns out that in Windows 10 they decided to not directly point to the index (why?) of <strong>nt!ObTypeIndexTable</strong> instead you have to do some <strong>XOR</strong>s in order to find the right index.</p><p><strong>Update 2 :</strong></p><p>Take a look at the following slides from <a href="https://twitter.com/NTarakanov"><strong>NTarakanov</strong></a> :</p><p>[<a href="http://www.powerofcommunity.net/poc2018/nikita.pdf">http://www.powerofcommunity.net/poc2018/nikita.pdf</a>]</p><p>The reason why they XORed <strong>TypeIndex</strong> with <strong>nt!ObHeaderCookie</strong> is the fact that it’s possible to modify the <strong>nt!_OBJECT_HEADER.TypeIndex</strong> of each object (for example in the case of a pool overflow), And then it would be possible to point to other <strong>_OBJECT_TYPE</strong>s like <strong>ALPC_OBJECT</strong> and trigger this vulnerability (pool overflow) as it was possible to control the behavior of callbacks in these objects.</p><p><img data-src="../../assets/images/object-data-corruption.png" alt="Pool over flow (DKOHM)" data-proofer-ignore></p><p>The following picture is copied from <a href="https://medium.com/@ashabdalhalim/a-light-on-windows-10s-object-header-typeindex-value-e8f907e7073a">this post</a> which describes how he understands it by reversing <strong>nt!ObGetObjectType</strong> , you can do the same thing and it works.</p><p><img data-src="../../assets/images/type-index.png" alt="Find TypeIndex in Win 10" data-proofer-ignore></p><p>Keep in mind that the second member of <strong>nt!ObTypeIndexTable</strong> is “<strong>Type</strong>”. If you get the <strong>_OBJECT_HEADER</strong> of Process’s <strong>_OBJECT_TYPE</strong> itself, then you’ll reach to the following <strong>_OBJECT_TYPE</strong> .</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="n">poi</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">ObTypeIndexTable</span><span class="o">+</span><span class="p">((</span><span class="mh">0x2</span><span class="p">)</span><span class="o">*</span><span class="err">@$</span><span class="n">ptrsize</span><span class="p">))</span> 
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span>         <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09acd0</span> <span class="o">-</span> <span class="mh">0xffffd68a</span><span class="err">`</span><span class="mo">01413750</span> <span class="p">]</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span>             <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Type"</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">DefaultObject</span>    <span class="o">:</span> <span class="mh">0xfffff803</span><span class="err">`</span><span class="mi">80442780</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">Index</span>            <span class="o">:</span> <span class="mh">0x2</span> <span class="err">''</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">TotalNumberOfObjects</span> <span class="o">:</span> <span class="mh">0x43</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">TotalNumberOfHandles</span> <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x034</span> <span class="n">HighWaterNumberOfObjects</span> <span class="o">:</span> <span class="mh">0x43</span>
   <span class="o">+</span><span class="mh">0x038</span> <span class="n">HighWaterNumberOfHandles</span> <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">TypeInfo</span>         <span class="o">:</span> <span class="n">_OBJECT_TYPE_INITIALIZER</span>
   <span class="o">+</span><span class="mh">0x0b8</span> <span class="n">TypeLock</span>         <span class="o">:</span> <span class="n">_EX_PUSH_LOCK</span>
   <span class="o">+</span><span class="mh">0x0c0</span> <span class="n">Key</span>              <span class="o">:</span> <span class="mh">0x546a624f</span>
   <span class="o">+</span><span class="mh">0x0c8</span> <span class="n">CallbackList</span>     <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09ade8</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09ade8</span> <span class="p">]</span>
</pre></table></code></div></div><p>Now that we know what the object type is, it’s time to dig deeper into Windows <strong>_OBJECT_TYPE</strong>s and find all of them.</p><h2 id="finding-all-windows-_object_types"><span class="mr-2"><strong>Finding All Windows _OBJECT_TYPE(s)</strong></span><a href="#finding-all-windows-_object_types" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The first and easiest way is using Windbg’s “<strong>!object \ObjectTypes</strong>” or using tools like <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/winobj">SysInternals’ WinObj</a>.</p><p><img data-src="../../assets/images/reversing-windows-internal-3.png" alt="WinObj" data-proofer-ignore></p><p>Using windbg , you’ll get the following results but the result of my tests shows that this command’s results is not complete, that’s why we need a third way to explore the kernel types. WinObj also won’t show a complete result.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">object</span> <span class="err">\</span><span class="n">ObjectTypes</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffb0824ea08700</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffd689fd09a900</span><span class="p">)</span> <span class="n">Directory</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffb0824ea086d0</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">69</span>
    <span class="n">Directory</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffffb0824ea07cb0</span>  <span class="n">Name</span><span class="o">:</span> <span class="n">ObjectTypes</span>

    <span class="n">Hash</span> <span class="n">Address</span>          <span class="n">Type</span>                      <span class="n">Name</span>
    <span class="o">----</span> <span class="o">-------</span> <span class="o">----</span> <span class="o">----</span>
     <span class="mo">00</span>  <span class="n">ffffd689fd0f5640</span> <span class="n">Type</span>                      <span class="n">TmTm</span>
     <span class="mo">01</span>  <span class="n">ffffd689fd094560</span> <span class="n">Type</span>                      <span class="n">Desktop</span>
         <span class="n">ffffd689fd09a4e0</span> <span class="n">Type</span>                      <span class="n">Process</span>
     <span class="mo">02</span>  <span class="n">ffffd689fd0f6400</span> <span class="n">Type</span>                      <span class="n">EnergyTracker</span>
         <span class="n">ffffd689fd0f6980</span> <span class="n">Type</span>                      <span class="n">RegistryTransaction</span>
     <span class="mo">03</span>  <span class="n">ffffd689fd093640</span> <span class="n">Type</span>                      <span class="n">DebugObject</span>
     <span class="mo">04</span>  <span class="n">ffffd68a014137a0</span> <span class="n">Type</span>                      <span class="n">VRegConfigurationContext</span>
         <span class="n">ffffd689fd0f50c0</span> <span class="n">Type</span>                      <span class="n">TpWorkerFactory</span>
     <span class="mo">05</span>  <span class="n">ffffd689fd0f6ae0</span> <span class="n">Type</span>                      <span class="n">Adapter</span>
         <span class="n">ffffd689fd09a220</span> <span class="n">Type</span>                      <span class="n">Token</span>
     <span class="mo">06</span>  <span class="n">ffffd689fd0f9900</span> <span class="n">Type</span>                      <span class="n">DxgkSharedResource</span>
     <span class="mo">07</span>  <span class="n">ffffd689fd0934e0</span> <span class="n">Type</span>                      <span class="n">PsSiloContextPaged</span>
     <span class="mi">08</span>  <span class="n">ffffd689fd0fa400</span> <span class="n">Type</span>                      <span class="n">NdisCmState</span>
         <span class="n">ffffd689fd0937a0</span> <span class="n">Type</span>                      <span class="n">ActivityReference</span>
     <span class="mi">09</span>  <span class="n">ffffd689fd0faf00</span> <span class="n">Type</span>                      <span class="n">PcwObject</span>
         <span class="n">ffffd689fd0f5bc0</span> <span class="n">Type</span>                      <span class="n">WmiGuid</span>
     <span class="mi">11</span>  <span class="n">ffffd689fd0f90c0</span> <span class="n">Type</span>                      <span class="n">DmaAdapter</span>
         <span class="n">ffffd689fd0f5e80</span> <span class="n">Type</span>                      <span class="n">EtwRegistration</span>
     <span class="mi">12</span>  <span class="n">ffffd689fd0f9640</span> <span class="n">Type</span>                      <span class="n">DxgkSharedBundleObject</span>
         <span class="n">ffffd689fd0f5900</span> <span class="n">Type</span>                      <span class="n">Session</span>
         <span class="n">ffffd689fd093d20</span> <span class="n">Type</span>                      <span class="n">RawInputManager</span>
         <span class="n">ffffd689fd093900</span> <span class="n">Type</span>                      <span class="n">Timer</span>
     <span class="mi">13</span>  <span class="n">ffffd689fd094820</span> <span class="n">Type</span>                      <span class="n">Mutant</span>
     <span class="mi">14</span>  <span class="n">ffffd689fd093a60</span> <span class="n">Type</span>                      <span class="n">IRTimer</span>
     <span class="mi">16</span>  <span class="n">ffffd689fd0fa980</span> <span class="n">Type</span>                      <span class="n">DxgkCurrentDxgProcessObject</span>
         <span class="n">ffffd689fd0f6c40</span> <span class="n">Type</span>                      <span class="n">IoCompletion</span>
     <span class="mi">17</span>  <span class="n">ffffd689fd0f94e0</span> <span class="n">Type</span>                      <span class="n">DxgkSharedProtectedSessionObject</span>
         <span class="n">ffffd689fd0fa560</span> <span class="n">Type</span>                      <span class="n">DxgkSharedSyncObject</span>
         <span class="n">ffffd689fd093220</span> <span class="n">Type</span>                      <span class="n">WindowStation</span>
         <span class="n">ffffd689fd094ae0</span> <span class="n">Type</span>                      <span class="n">Profile</span>
     <span class="mi">18</span>  <span class="n">ffffd689fd0f6560</span> <span class="n">Type</span>                      <span class="n">File</span>
     <span class="mi">20</span>  <span class="n">ffffd689fd0930c0</span> <span class="n">Type</span>                      <span class="n">Partition</span>
     <span class="mi">21</span>  <span class="n">ffffd689fd0f9e80</span> <span class="n">Type</span>                      <span class="n">DxgkSharedKeyedMutexObject</span>
         <span class="n">ffffd689fd0946c0</span> <span class="n">Type</span>                      <span class="n">ActivationObject</span>
         <span class="n">ffffd689fd093380</span> <span class="n">Type</span>                      <span class="n">Semaphore</span>
	
	<span class="p">...</span>
         <span class="n">ffffd689fd09ad20</span> <span class="n">Type</span>                      <span class="n">Type</span>
	<span class="p">...</span>
</pre></table></code></div></div><p>The third method for getting objects is interpreting Windows structures manually using Windbg. Before further investigation we have to find the “<strong>Type</strong>“‘s <strong>_OBJECT_TYPE</strong> (e.g a process type itself is a “<strong>Type</strong>”), for this purpose first we have to find Process’s <strong>_OBJECT_TYPE</strong> :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">x</span> <span class="n">nt</span><span class="o">!</span><span class="n">PsProcessType</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">8056</span><span class="n">f390</span> <span class="n">nt</span><span class="o">!</span><span class="n">PsProcessType</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">no</span> <span class="n">type</span> <span class="n">information</span><span class="o">&gt;</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dq</span> <span class="n">fffff803</span><span class="err">`</span><span class="mi">8056</span><span class="n">f390</span> <span class="n">l1</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">8056</span><span class="n">f390</span>  <span class="n">ffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span>
</pre></table></code></div></div><p>Using <strong>!object</strong> we can find its type :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">object</span> <span class="n">ffffd689</span><span class="err">`</span><span class="n">fd09a4e0</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffd689fd09a4e0</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffd689fd09ad20</span><span class="p">)</span> <span class="n">Type</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffd689fd09a4b0</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">2</span>
    <span class="n">Directory</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffffb0824ea08700</span>  <span class="n">Name</span><span class="o">:</span> <span class="n">Process</span>
</pre></table></code></div></div><p>you can also find the “<strong>Type</strong>“‘s location using “<strong>!object \ObjectTypes</strong>”.</p><p>Now that we have a pointer to “<strong>Type</strong>“‘s <strong>_OBJECT_TYPE</strong> ( = ffffd689fd09ad20), it’s time to find other types, <strong>_OBJECT_TYPE</strong> itself has a “<strong>TypeList</strong>” but doesn’t seem to be a list to Object Types, you can traverse it, it won’t give a valid result. If you remember from the first part of this post, I told you the order when Windows allocates the objects (search for “ <strong>Windows saves each object</strong>” in this post and see it again.). It turns out that above the Type’s <strong>_OBJECT_HEADER</strong>, there is another optional structure, called “<strong>_OBJECT_HEADER_CREATOR_INFO</strong>”, let’s see what’s the definition of this structure.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_CREATOR_INFO</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span>         <span class="o">:</span> <span class="n">_LIST_ENTRY</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">CreatorUniqueProcess</span> <span class="o">:</span> <span class="n">Ptr64</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x018</span> <span class="n">CreatorBackTraceIndex</span> <span class="o">:</span> <span class="n">Uint2B</span>
   <span class="o">+</span><span class="mh">0x01a</span> <span class="n">Reserved1</span>        <span class="o">:</span> <span class="n">Uint2B</span>
   <span class="o">+</span><span class="mh">0x01c</span> <span class="n">Reserved2</span>        <span class="o">:</span> <span class="n">Uint4B</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="o">??</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_CREATOR_INFO</span><span class="p">)</span>
<span class="kt">unsigned</span> <span class="n">int64</span> <span class="mh">0x20</span>
</pre></table></code></div></div><p>As I told you, <strong>_OBJECT_HEADER_CREATOR_INFO</strong> is above the <strong>_OBJECT_HEADER</strong> so we need a little calculation here, <em><strong>sizeof( _OBJECT_HEADER_CREATOR_INFO) = 0x20</strong></em> and for reaching to the <strong>_OBJECT_HEADER</strong> we have to subtract the pointer (ffffd689fd09ad20) by 0x30.</p><p><strong><em>ffffd689fd09ad20 - 0x30 - 0x20 = FFFFD689FD09ACD0‬ =&gt; Pointer to _OBJECT_HEADER_CREATOR_INFO</em></strong></p><p>The <strong>TypeList</strong> in <strong>_OBJECT_HEADER_CREATOR_INFO</strong> is <strong>_LIST_ENTRY</strong> which shows us all the <strong>Types</strong>. We’ll use Windbg to traverse through the list.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">FFFFD689FD09ACD0</span><span class="err">‬</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER_CREATOR_INFO</span> <span class="o">-</span><span class="n">l</span> <span class="n">TypeList</span><span class="p">.</span><span class="n">Flink</span> <span class="o">-</span><span class="n">y</span> <span class="n">TypeList</span>
<span class="n">TypeList</span><span class="p">.</span><span class="n">Flink</span> <span class="n">at</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09acd0</span>
<span class="o">---------------------------------------------</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span> <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a8b0</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09ad20</span> <span class="p">]</span>

<span class="n">TypeList</span><span class="p">.</span><span class="n">Flink</span> <span class="n">at</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a8b0</span>
<span class="o">---------------------------------------------</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span> <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a070</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09acd0</span> <span class="p">]</span>

<span class="n">TypeList</span><span class="p">.</span><span class="n">Flink</span> <span class="n">at</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a070</span>
<span class="o">---------------------------------------------</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span> <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a1d0</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a8b0</span> <span class="p">]</span>

<span class="n">TypeList</span><span class="p">.</span><span class="n">Flink</span> <span class="n">at</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a1d0</span>
<span class="o">---------------------------------------------</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">TypeList</span> <span class="o">:</span> <span class="n">_LIST_ENTRY</span> <span class="p">[</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a330</span> <span class="o">-</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a070</span> <span class="p">]</span>
<span class="p">...</span>
</pre></table></code></div></div><p>You can see a pointer to all of the Types (of course from <strong>_OBJECT_HEADER_CREATOR_INFO</strong>). Let’s verify we found them correctly by looking at their names (Don’t forget we have to add <strong><em>0x20</em></strong> and <em><strong>ox30</strong></em> to reach the start of the <strong>_OBJECT_TYPE</strong>).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09acd0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Type"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a8b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Directory"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"SymbolicLink"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a1d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Token"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a330</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Job"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Process"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0943b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Thread"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Partition"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0940f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"UserApcReserve"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094930</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"IoCompletionReserve"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"ActivityReference"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"PsSiloContextPaged"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094250</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"PsSiloContextNonPaged"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0935f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DebugObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094eb0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Event"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0947d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Mutant"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094bf0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Callback"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093330</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Semaphore"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0938b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Timer"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093a10</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"IRTimer"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094a90</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Profile"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094d50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"KeyedEvent"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0931d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"WindowStation"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Desktop"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093b70</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Composition"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093cd0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"RawInputManager"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093e30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"CoreMessaging"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094670</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"ActivationObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"TpWorkerFactory"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6a90</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Adapter"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Controller"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5330</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Device"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Driver"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6bf0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"IoCompletion"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f51d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"WaitCompletionPacket"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"File"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f55f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"TmTm"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f60f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"TmTx"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6670</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"TmRm"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6eb0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"TmEn"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6d50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Section"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f58b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Session"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5a10</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Key"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6930</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"RegistryTransaction"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6250</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"ALPC Port"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f63b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"EnergyTracker"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f67d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"PowerRequest"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5b70</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"WmiGuid"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5e30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"EtwRegistration"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa0f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"EtwSessionDemuxEntry"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fabf0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"EtwConsumer"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9cd0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"CoverageSampler"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DmaAdapter"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0faeb0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"PcwObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fad50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"FilterCommunicationPort"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa250</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"FilterConnectionPort"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa3b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"NdisCmState"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fad50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"FilterCommunicationPort"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa3b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"NdisCmState"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f98b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkSharedResource"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9e30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkSharedKeyedMutexObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkSharedSyncObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa670</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkSharedSwapChainObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa7d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkDisplayManagerObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa930</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkCurrentDxgProcessObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkSharedProtectedSessionObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd68a</span><span class="err">`</span><span class="mo">01413750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"VRegConfigurationContext"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f95f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkSharedBundleObject"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09ad20</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"--- memory read error at address 0x00000130`00000000 ---"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span>  <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"DxgkCompositionObject"</span>
</pre></table></code></div></div><p>There is also another way that you can enumerate the above list by using the following command (thanks to <a href="https://twitter.com/brucedang">Bruce Dang </a> for mentioning it):</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">dx</span> <span class="n">Debugger</span><span class="p">.</span><span class="n">Utility</span><span class="p">.</span><span class="n">Collections</span><span class="p">.</span><span class="n">FromListEntry</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nt</span><span class="o">!</span><span class="n">ObpTypeObjectType</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">TypeList</span><span class="p">,</span> <span class="s">"nt!_OBJECT_TYPE"</span><span class="p">,</span> <span class="s">"TypeList"</span><span class="p">).</span><span class="n">Select</span><span class="p">(</span><span class="n">o</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_HEADER</span><span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">o</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)).</span><span class="n">Select</span><span class="p">(</span> <span class="n">o</span> <span class="o">=&gt;</span> <span class="n">o</span><span class="o">-&gt;</span><span class="n">ObjectName</span><span class="p">)</span>
</pre></table></code></div></div><p>The above result contains more types than using “<strong>!object \ObjectTypes</strong>” (why?) in my case, it finds 70 types while “<strong>!object \ObjectTypes</strong>” gives only 67 types !!!</p><p><strong>Update 1</strong>: As <a href="https://twitter.com/aionescu">Alex</a> mentioned, I got more objects because I copy-pasted <strong>FilterCommunicationPort</strong> and <strong>NdisCmState</strong> twice.</p><p><strong>Update 1</strong>: Also, “<strong>!object 0 Type</strong>” is a built-in way of enumerating the creator info list.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">object</span> <span class="mi">0</span> <span class="n">Type</span>
<span class="n">Scanning</span> <span class="mi">67</span> <span class="n">objects</span> <span class="n">of</span> <span class="n">type</span> <span class="err">'</span><span class="n">Type</span><span class="err">'</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffbc05a907b4e0</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffbc05a907b4e0</span><span class="p">)</span> <span class="n">Type</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffbc05a907b4b0</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">2</span>
    <span class="n">Directory</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffff9f02dca02d90</span>  <span class="n">Name</span><span class="o">:</span> <span class="n">Type</span>
<span class="n">Optional</span> <span class="n">Headers</span><span class="o">:</span> 
    <span class="n">CreatorInfo</span><span class="p">(</span><span class="n">ffffbc05a907b4b0</span><span class="p">)</span><span class="o">:</span> <span class="n">Process</span><span class="o">:</span> <span class="mi">0</span> <span class="n">BackTraceIndex</span><span class="o">:</span> <span class="mi">58</span>
    <span class="n">NameInfo</span><span class="p">(</span><span class="n">ffffbc05a907b4b0</span><span class="p">)</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffbc05a907b640</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffbc05a907b4e0</span><span class="p">)</span> <span class="n">Type</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffbc05a907b610</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">2</span>
    <span class="n">Directory</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffff9f02dca02d90</span>  <span class="n">Name</span><span class="o">:</span> <span class="n">Directory</span>
<span class="n">Optional</span> <span class="n">Headers</span><span class="o">:</span> 
    <span class="n">CreatorInfo</span><span class="p">(</span><span class="n">ffffbc05a907b610</span><span class="p">)</span><span class="o">:</span> <span class="n">Process</span><span class="o">:</span> <span class="mi">0</span> <span class="n">BackTraceIndex</span><span class="o">:</span> <span class="mi">5</span><span class="n">a</span>
    <span class="n">NameInfo</span><span class="p">(</span><span class="n">ffffbc05a907b610</span><span class="p">)</span>
<span class="n">Object</span><span class="o">:</span> <span class="n">ffffbc05a907b380</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffbc05a907b4e0</span><span class="p">)</span> <span class="n">Type</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffbc05a907b350</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">2</span>
    <span class="n">Directory</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffff9f02dca02d90</span>  <span class="n">Name</span><span class="o">:</span> <span class="n">SymbolicLink</span>

<span class="p">...</span>

<span class="n">Object</span><span class="o">:</span> <span class="n">ffffbc05a907b0c0</span>  <span class="n">Type</span><span class="o">:</span> <span class="p">(</span><span class="n">ffffbc05a907b4e0</span><span class="p">)</span> <span class="n">Type</span>
    <span class="n">ObjectHeader</span><span class="o">:</span> <span class="n">ffffbc05a907b090</span> <span class="p">(</span><span class="n">new</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">HandleCount</span><span class="o">:</span> <span class="mi">0</span>  <span class="n">PointerCount</span><span class="o">:</span> <span class="mi">2</span>
    <span class="n">Directory</span> <span class="n">Object</span><span class="o">:</span> <span class="n">ffff9f02dca02d90</span>  <span class="n">Name</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">Optional</span> <span class="n">Headers</span><span class="o">:</span> 
</pre></table></code></div></div><p>Now that we have the pointers to all of the types, it’s time to investigate through each <strong>_OBJECT_TYPE</strong>(s).</p><h2 id="finding-types-which-support-callback"><span class="mr-2"><strong>Finding Types which support callback</strong></span><a href="#finding-types-which-support-callback" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In <strong>_OBJECT_TYPE there is a</strong> structure called “<strong>_OBJECT_TYPE_INITIALIZER</strong>”. It defines like this :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">Length</span>           <span class="o">:</span> <span class="n">Uint2B</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">ObjectTypeFlags</span>  <span class="o">:</span> <span class="n">Uint2B</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">CaseInsensitive</span>  <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">UnnamedObjectsOnly</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">UseDefaultObject</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SecurityRequired</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">MaintainHandleCount</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">MaintainTypeList</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">CacheAligned</span>     <span class="o">:</span> <span class="n">Pos</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x003</span> <span class="n">UseExtendedParameters</span> <span class="o">:</span> <span class="n">Pos</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="n">Bit</span>
   <span class="o">+</span><span class="mh">0x003</span> <span class="n">Reserved</span>         <span class="o">:</span> <span class="n">Pos</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span> <span class="n">Bits</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">ObjectTypeCode</span>   <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">InvalidAttributes</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">GenericMapping</span>   <span class="o">:</span> <span class="n">_GENERIC_MAPPING</span>
   <span class="o">+</span><span class="mh">0x01c</span> <span class="n">ValidAccessMask</span>  <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x020</span> <span class="n">RetainAccess</span>     <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x024</span> <span class="n">PoolType</span>         <span class="o">:</span> <span class="n">_POOL_TYPE</span>
   <span class="o">+</span><span class="mh">0x028</span> <span class="n">DefaultPagedPoolCharge</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x02c</span> <span class="n">DefaultNonPagedPoolCharge</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x030</span> <span class="n">DumpProcedure</span>    <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">void</span> 
   <span class="o">+</span><span class="mh">0x038</span> <span class="n">OpenProcedure</span>    <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">long</span> 
   <span class="o">+</span><span class="mh">0x040</span> <span class="n">CloseProcedure</span>   <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">void</span> 
   <span class="o">+</span><span class="mh">0x048</span> <span class="n">DeleteProcedure</span>  <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">void</span> 
   <span class="o">+</span><span class="mh">0x050</span> <span class="n">ParseProcedure</span>   <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">long</span> 
   <span class="o">+</span><span class="mh">0x050</span> <span class="n">ParseProcedureEx</span> <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">long</span> 
   <span class="o">+</span><span class="mh">0x058</span> <span class="n">SecurityProcedure</span> <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">long</span> 
   <span class="o">+</span><span class="mh">0x060</span> <span class="n">QueryNameProcedure</span> <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">long</span> 
   <span class="o">+</span><span class="mh">0x068</span> <span class="n">OkayToCloseProcedure</span> <span class="o">:</span> <span class="n">Ptr64</span>     <span class="kt">unsigned</span> <span class="kt">char</span> 
   <span class="o">+</span><span class="mh">0x070</span> <span class="n">WaitObjectFlagMask</span> <span class="o">:</span> <span class="n">Uint4B</span>
   <span class="o">+</span><span class="mh">0x074</span> <span class="n">WaitObjectFlagOffset</span> <span class="o">:</span> <span class="n">Uint2B</span>
   <span class="o">+</span><span class="mh">0x076</span> <span class="n">WaitObjectPointerOffset</span> <span class="o">:</span> <span class="n">Uint2B</span>
</pre></table></code></div></div><p>It contains lots of important fields, for example, “<strong>SupportsObjectCallbacks</strong>” shows whether the object supports callbacks or not. <strong>_OBJECT_TYPE_INITIALIZER</strong> starts after 0x40 from the <strong>_OBJECT_TYPE</strong> so let’s find the objects that support callbacks from the <strong>_OBJECT_TYPES</strong> that we previously gathered. (Do you remember <strong>ObpCallPreOperationCallbacks</strong> when we reversed <strong>ObpCreateHandle</strong>? :) )</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
</pre><td class="rouge-code"><pre>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09acd0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a8b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a1d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a330</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0943b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0940f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094930</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094250</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0935f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094eb0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0947d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094bf0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093330</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0938b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093a10</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094a90</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094d50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0931d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093b70</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093cd0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd093e30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094670</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6a90</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5330</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6bf0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f51d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f55f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f60f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6670</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6eb0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6d50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f58b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5a10</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6930</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f6250</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f63b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f67d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5b70</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f5e30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa0f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fabf0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9cd0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9070</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0faeb0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fad50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa250</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa3b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fad50</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa3b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f98b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9e30</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa670</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa7d0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0fa930</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd68a</span><span class="err">`</span><span class="mo">01413750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f95f0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09ad20</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0f9750</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y0</span>
</pre></table></code></div></div><p>You can see that only the following three <strong>_OBJECT_TYPE</strong>s support callbacks,</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE_INITIALIZER</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0943b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span><span class="o">+</span><span class="mi">40</span> <span class="o">-</span><span class="n">b</span> <span class="o">-</span><span class="n">y</span> <span class="n">SupportsObjectCallbacks</span> 
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">SupportsObjectCallbacks</span> <span class="o">:</span> <span class="mi">0</span><span class="n">y1</span>

<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd094510</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Desktop"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd09a490</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Process"</span>
<span class="n">kd</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">nt</span><span class="o">!</span><span class="n">_OBJECT_TYPE</span> <span class="mh">0xffffd689</span><span class="err">`</span><span class="n">fd0943b0</span><span class="o">+</span><span class="mi">20</span><span class="o">+</span><span class="mi">30</span> <span class="o">-</span><span class="n">y</span> <span class="n">Name</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">Name</span> <span class="o">:</span> <span class="n">_UNICODE_STRING</span> <span class="s">"Thread"</span>
</pre></table></code></div></div><p>The result is not really surprising, previously <a href="https://twitter.com/aionescu">Alex</a> and other friends told me that Windows 10 TH2 starts supporting “<strong>ExDesktopOObjectType</strong>”.</p><p><img data-src="../../assets/images/operation-registration-structure.png" alt="OperationRegisteration" data-proofer-ignore></p><p>There are also another important fields in <strong>_OBJECT_TYPE_INITIALIZER</strong> for example you can find the <strong>ValidAccessMask</strong> for that object or find the related functions from <strong>DumpProcedure</strong>, <strong>OpenProcedure</strong>, <strong>CloseProcedure</strong>, <strong>DeleteProcedure</strong>, <strong>ParseProcedure</strong>, <strong>ParseProcedureEx</strong>, <strong>SecurityProcedure</strong>, <strong>QueryNameProcedure</strong>, and <strong>OkayToCloseProcedure</strong>. For example in process type we have the following functions (These are the callbacks that internally used by Microsoft and it’s not revealed to drivers) :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre>    <span class="p">[</span><span class="o">+</span><span class="mh">0x030</span><span class="p">]</span> <span class="n">DumpProcedure</span>    <span class="o">:</span> <span class="mh">0x0</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">_OBJECT_DUMP_CONTROL</span> <span class="o">*</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x038</span><span class="p">]</span> <span class="n">OpenProcedure</span>    <span class="o">:</span> <span class="mh">0xfffff803806b0170</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">long</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="n">_OB_OPEN_REASON</span><span class="p">,</span><span class="kt">char</span><span class="p">,</span><span class="n">_EPROCESS</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x040</span><span class="p">]</span> <span class="n">CloseProcedure</span>   <span class="o">:</span> <span class="mh">0xfffff803806bdd50</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="n">_EPROCESS</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">,</span><span class="kt">unsigned</span> <span class="n">__int64</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x048</span><span class="p">]</span> <span class="n">DeleteProcedure</span>  <span class="o">:</span> <span class="mh">0xfffff80380664c00</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">void</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x050</span><span class="p">]</span> <span class="n">ParseProcedure</span>   <span class="o">:</span> <span class="mh">0x0</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">long</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">_ACCESS_STATE</span> <span class="o">*</span><span class="p">,</span><span class="kt">char</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span><span class="n">_UNICODE_STRING</span> <span class="o">*</span><span class="p">,</span><span class="n">_UNICODE_STRING</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">_SECURITY_QUALITY_OF_SERVICE</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="o">*</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x050</span><span class="p">]</span> <span class="n">ParseProcedureEx</span> <span class="o">:</span> <span class="mh">0x0</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">long</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">_ACCESS_STATE</span> <span class="o">*</span><span class="p">,</span><span class="kt">char</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span><span class="n">_UNICODE_STRING</span> <span class="o">*</span><span class="p">,</span><span class="n">_UNICODE_STRING</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">_SECURITY_QUALITY_OF_SERVICE</span> <span class="o">*</span><span class="p">,</span><span class="n">_OB_EXTENDED_PARSE_PARAMETERS</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="o">*</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x058</span><span class="p">]</span> <span class="n">SecurityProcedure</span> <span class="o">:</span> <span class="mh">0xfffff803805cd360</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">long</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="n">_SECURITY_OPERATION_CODE</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span> <span class="o">*</span><span class="p">,</span><span class="n">_POOL_TYPE</span><span class="p">,</span><span class="n">_GENERIC_MAPPING</span> <span class="o">*</span><span class="p">,</span><span class="kt">char</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x060</span><span class="p">]</span> <span class="n">QueryNameProcedure</span> <span class="o">:</span> <span class="mh">0x0</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">long</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span><span class="n">_OBJECT_NAME_INFORMATION</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">,</span><span class="kt">char</span><span class="p">)]</span>
    <span class="p">[</span><span class="o">+</span><span class="mh">0x068</span><span class="p">]</span> <span class="n">OkayToCloseProcedure</span> <span class="o">:</span> <span class="mh">0x0</span> <span class="p">[</span><span class="n">Type</span><span class="o">:</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="p">(</span><span class="kr">__cdecl</span><span class="o">*</span><span class="p">)(</span><span class="n">_EPROCESS</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span><span class="kt">char</span><span class="p">)]</span>

<span class="n">kd</span><span class="o">&gt;</span>  <span class="n">u</span> <span class="mh">0xfffff803806b0170</span> <span class="n">L1</span>
<span class="n">nt</span><span class="o">!</span><span class="n">PspProcessOpen</span><span class="o">:</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">806</span><span class="n">b0170</span> <span class="mi">48895</span><span class="n">c2408</span>      <span class="n">mov</span>     <span class="n">qword</span> <span class="n">ptr</span> <span class="p">[</span><span class="n">rsp</span><span class="o">+</span><span class="mi">8</span><span class="p">],</span><span class="n">rbx</span>
<span class="n">kd</span><span class="o">&gt;</span>  <span class="n">u</span> <span class="mh">0xfffff803806bdd50</span> <span class="n">L1</span>
<span class="n">nt</span><span class="o">!</span><span class="n">PspProcessClose</span><span class="o">:</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">806</span><span class="n">bdd50</span> <span class="mi">488</span><span class="n">bc4</span>          <span class="n">mov</span>     <span class="n">rax</span><span class="p">,</span><span class="n">rsp</span>
<span class="n">kd</span><span class="o">&gt;</span>  <span class="n">u</span> <span class="mh">0xfffff80380664c00</span> <span class="n">L1</span>
<span class="n">nt</span><span class="o">!</span><span class="n">PspProcessDelete</span><span class="o">:</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">80664</span><span class="n">c00</span> <span class="mi">4</span><span class="n">c8bdc</span>          <span class="n">mov</span>     <span class="n">r11</span><span class="p">,</span><span class="n">rsp</span>
<span class="n">kd</span><span class="o">&gt;</span>  <span class="n">u</span> <span class="mh">0xfffff803805cd360</span> <span class="n">L1</span>
<span class="n">nt</span><span class="o">!</span><span class="n">SeDefaultObjectMethod</span><span class="o">:</span>
<span class="n">fffff803</span><span class="err">`</span><span class="mi">805</span><span class="n">cd360</span> <span class="mi">4053</span>            <span class="n">push</span>    <span class="n">rbx</span>
</pre></table></code></div></div><h2 id="analyzing-callbacks-in-objecttypes"><span class="mr-2"><strong>Analyzing Callbacks in ObjectTypes</strong></span><a href="#analyzing-callbacks-in-objecttypes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>By now, you’re familiar with these callbacks: <strong>DumpProcedure</strong>, <strong>OpenProcedure</strong>, <strong>CloseProcedure</strong>, <strong>DeleteProcedure</strong>, <strong>ParseProcedure</strong>, <strong>ParseProcedureEx</strong>, <strong>SecurityProcedure</strong>, <strong>QueryNameProcedure</strong>, and <strong>OkayToCloseProcedure</strong>. Now let’s see which functions attempt to call them and what is the purpose of calling them.</p><p>The following definitions are the undocumented part of these callbacks.</p><ul><li><strong>DumpProcedure</strong>: Calls from <strong>nt!ObpRemoveObjectRoutine</strong>.</ul><blockquote><p>[Type: void (__cdecl*)(void *,_OBJECT_DUMP_CONTROL *)]</p></blockquote><p>int DumpProcedure_Hook( PVOID Object, OBJECT_DUMP_CONTROL* DumpControl);</p><ul><li><strong>OpenProcedure</strong>: Calls from <strong>nt!ObpIncrementHandleCountEx</strong> and the callback target function for process is <strong>nt!PspProcessOpen</strong>.</ul><blockquote><p>[Type: long (__cdecl*)(_OB_OPEN_REASON,char,_EPROCESS *,void *,unsigned long *,unsigned long)]</p></blockquote><p>int OpenProcedure_Hook( OB_OPEN_REASON OpenReason, CHAR AccessMode, PEPROCESS TargetProcess, PVOID Object, PULONG GrantedAccess, ULONG HandleCount);</p><ul><li><strong>CloseProcedure</strong>: Calls from <strong>nt!ObCloseHandleTableEntry</strong> and the callback target function for process is <strong>nt!PspProcessClose</strong> and for file is <strong>nt!IopCloseFile</strong>.</ul><blockquote><p>[Type: void (__cdecl*)(_EPROCESS *,void *,unsigned __int64,unsigned __int64)]</p></blockquote><p>int CloseProcedure_Hook( PEPROCESS Process, PVOID Object, ULONG ProcessHandleCount, ULONG SystemHandleCount);</p><ul><li><strong>DeleteProcedure</strong>: Calls from <strong>nt!ObpRemoveObjectRoutine</strong> and the callback target function for process is <strong>nt!PspProcessDelete</strong> and for file is <strong>nt!IopDeleteFile</strong>.</ul><blockquote><p>[Type: void (__cdecl*)(void *)]</p></blockquote><p>int DeleteProcedure_Hook( PVOID Object);</p><ul><li><strong>ParseProcedure &amp; ParseProcedureEx</strong>: Calls from <strong>nt!ObpLookupObjectName</strong> and the callback target function for file is <strong>nt!IopParseFile</strong>.</ul><blockquote><p>[Type: long (__cdecl*)(void *,void *,_ACCESS_STATE *,char,unsigned long,_UNICODE_STRING *,_UNICODE_STRING *,void *,_SECURITY_QUALITY_OF_SERVICE *,void * <em>)]</em></p><p>[Type: long (__cdecl)(void *,void *,_ACCESS_STATE *,char,unsigned long,_UNICODE_STRING *,_UNICODE_STRING *,void *,_SECURITY_QUALITY_OF_SERVICE *,_OB_EXTENDED_PARSE_PARAMETERS *,void * *)]</p></blockquote><p>int ParseProcedure_Hook( PVOID ParseObject, PVOID ObjectType, PACCESS_STATE AccessState, CHAR AccessMode, ULONG Attributes, UNICODE_STRING* CompleteName, UNICODE_STRING* RemainingName, PVOID Context, SECURITY_QUALITY_OF_SERVICE* SecurityQos, OB_EXTENDED_PARSE_PARAMETERS* ExtendedParameters, PVOID* Object);</p><ul><li><strong>SecurityProcedure</strong>: Calls from <strong>nt!NtQuerySecurityObject</strong> and <strong>nt!ObpCreateHandle</strong> (Do you remeber? we see it on <strong>ObpCreateHandle</strong> and explained about its purpose) and the callback target function for file is <strong>nt!IopGetSetSecurityObject</strong> and for process is <strong>nt!SeDefaultObjectMethod</strong>.</ul><blockquote><p>[Type: long (__cdecl*)(void *,_SECURITY_OPERATION_CODE,unsigned long *,void *,unsigned long *,void * *,_POOL_TYPE,_GENERIC_MAPPING *,char)]</p></blockquote><p>int SecurityProcedure_Hook( PVOID Object, SECURITY_OPERATION_CODE OperationCode, PULONG SecurityInformation, PVOID SecurityDescriptor, PULONG CapturedLength, PVOID* ObjectsSecurityDescriptor, POOL_TYPE PoolType, PGENERIC_MAPPING GenericMapping, CHAR Mode);</p><ul><li><strong>QueryNameProcedure</strong>: Calls from <strong>nt!ObQueryNameStringMode</strong> and target function for file is <strong>nt!IopQueryName</strong>.</ul><blockquote><p>[Type: long (__cdecl*)(void *,unsigned char,_OBJECT_NAME_INFORMATION *,unsigned long,unsigned long *,char)]</p></blockquote><p>int QueryNameProcedure_Hook( PVOID Object, UCHAR HasObjectName, POBJECT_NAME_INFORMATION ObjectNameInfo, ULONG Length, PULONG* ReturnLength, CHAR Mode);</p><ul><li><strong>OkayToCloseProcedure</strong>: Calls from <strong>nt!ObCloseHandleTableEntry</strong>.</ul><blockquote><p>[Type: unsigned char (__cdecl*)(_EPROCESS *,void *,void *,char)]</p></blockquote><p>int OkayToCloseProcedure_Hook( PEPROCESS Process, DWORD DW, HANDLE Handle, KPROCESSOR_MODE PreviousMode);</p><h2 id="using-callbacks-in-objecttypes"><span class="mr-2"><strong>Using Callbacks in ObjectTypes</strong></span><a href="#using-callbacks-in-objecttypes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>It’s time to use the above information to build a driver that hooks these callbacks, there is an article <a href="http://rce4fun.blogspot.com/2014/07/okaytocloseprocedure-callback-kernel_9.html">here</a> from <a href="https://twitter.com/Dark_Puzzle">Souhail Hammou</a> that describes the behavior of <strong>OkayToCloseProcedure</strong>.</p><p>As he describes,</p><p>The function (<strong>ObpCloseHandleTableEntry</strong>) will access the <strong>OkayToCloseProcedure</strong> field and check if it’s NULL, if that’s true the function will proceed to other checks <strong>(check if the handle is protected from being closed</strong>).</p><p>If the <strong>OkayToCloseProcedre</strong> field isn’t <em><strong>NULL</strong></em>, the function will proceed to call the callback function. If the callback function returns 0 the handle cannot be closed and <strong>ObpCloseHandleTableEntry</strong> will return <strong>STATUS_HANDLE_NOT_CLOSABLE</strong>. If it returns a value other than <strong>0</strong> we will proceed to the other checks as it happens when the <strong>OkayToCloseProcedure</strong> is <em><strong>NULL</strong></em>.</p><p>Now we have to create a driver which hooks all of the non-null callback procedure and also hook <strong>OkayToCloseProcedure</strong>.</p><p>Full source code of object callbacks hook is available on GitHub :</p><p>[ <a href="https://github.com/SinaKarvandi/misc/tree/master/TypeInfoCallbacksHooker">https://github.com/SinaKarvandi/misc/tree/master/TypeInfoCallbacksHooker</a> ]</p><p>For this, first, you have to find a pointer the <strong>_OBJECT_TYPE</strong> structure of the object that you need to hook (e.g Process, File and etc.). For example, as I described above <strong>PsProcessType</strong> contains a pointer to the start of Process <strong>OBJECT_TYPE</strong> so in the case of hooking the processes callbacks you can use the following code.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>	<span class="cm">/* Get the Process Object Type (OBJECT_TYPE) structure */</span>

	<span class="c1">// ProcessObjectType = ObGetObjectType(PsGetCurrentProcess());</span>
	<span class="n">ProcessObjectType</span> <span class="o">=</span> <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="o">*</span><span class="n">PsProcessType</span><span class="p">;</span>
	<span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] Process Object Type Structure at : %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ProcessObjectType</span><span class="p">);</span>
</pre></table></code></div></div><p>Also, there is another option which can be used to do the same task, You can use <strong>ObGetObjectType</strong> and pass you object as its argument. For example, you can use <strong>PsGetCurrentProcess()</strong> which is a Process object or any other object. This way is more general.</p><p>For each of the callbacks, we use the following code. First, we check whether the callback is <em><strong>NULL</strong></em> or not, if it’s not null then we save the callback pointer (For future calls) then we change the address of the callback so that Windows calls our callback method first and we call the original function.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>	<span class="cm">/* CloseProcedure_Hook */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">INT64</span><span class="o">*</span><span class="p">)(</span><span class="n">ProcessObjectType</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="c1">// Store the previous pointer</span>
		<span class="o">*</span><span class="p">(</span><span class="n">INT64</span><span class="o">*</span><span class="p">)(</span><span class="n">CallbacksList</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">INT64</span><span class="o">*</span><span class="p">)(</span><span class="n">ProcessObjectType</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">_CloseProcedure</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">INT64</span><span class="o">*</span><span class="p">)(</span><span class="n">ProcessObjectType</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">);</span>


		<span class="c1">// Save to pointer to new hook address</span>
		<span class="o">*</span><span class="p">(</span><span class="n">INT64</span><span class="o">*</span><span class="p">)(</span><span class="n">ProcessObjectType</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">INT64</span><span class="p">)</span><span class="n">CloseProcedure_Hook</span><span class="p">;</span>

		<span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] CloseProcedure Hook Done !!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] CloseProcedure Hook Failed"</span><span class="p">);</span>
	<span class="p">}</span>
</pre></table></code></div></div><p>Whenever Windows calls our callback method, we have to first show the details about the object and process that causes this callback to be invoked. Then we return the result of previous callback (which Windows sets).</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="nf">int</span><span class="p">(</span><span class="o">*</span><span class="n">CloseProcedure</span><span class="p">)(</span><span class="n">PEPROCESS</span> <span class="n">Process</span><span class="p">,</span> <span class="n">PVOID</span> <span class="n">Object</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">ProcessHandleCount</span><span class="p">,</span> <span class="n">ULONG</span> <span class="n">SystemHandleCount</span><span class="p">);</span>
<span class="n">CloseProcedure</span> <span class="n">_CloseProcedure</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">CloseProcedure_Hook</span><span class="p">(</span>
	<span class="n">PEPROCESS</span> <span class="n">Process</span><span class="p">,</span>
	<span class="n">PVOID</span> <span class="n">Object</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">ProcessHandleCount</span><span class="p">,</span>
	<span class="n">ULONG</span> <span class="n">SystemHandleCount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] CloseProcedure called for object : 0x%llx, Process : %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Object</span><span class="p">,</span> <span class="p">(</span><span class="n">PUCHAR</span><span class="p">)</span><span class="n">Process</span> <span class="o">+</span> <span class="mh">0x450</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_CloseProcedure</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">Object</span><span class="p">,</span> <span class="n">ProcessHandleCount</span><span class="p">,</span> <span class="n">SystemHandleCount</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Keep in mind that these modifications on callbacks are prohibited due to the presence of PatchGuard but PatchGuard won’t start in a debugged environment.</p><p>Finally, the results are:</p><p><img data-src="../../assets/images/type-info-callbacks-hooks.png" alt="TypeInfoCallbacksHooker Driver" data-proofer-ignore></p><h1 id="conclusion"><strong>Conclusion</strong></h1><p>In this post, we saw some important parts of Windows about <strong>handles</strong>, <strong>callbacks, object types</strong> and lots of other cool examples about how to use them.</p><p>The details provided in this post might be changed in the future versions of Windows, these details checked on the latest Windows 10 1903 so please don’t hesitate to correct me if you are sure something is wrong or you want to add some additional details for readers or something that changes in the future.</p><p>I’m not actively working on these series but I’ll try to post new parts as soon as possible.</p><p>That’s it guys, hope you enjoy reading this post.</p><p><img data-src="../../assets/images/anime-girl-night.jpg" alt="Aniiiime :D" data-proofer-ignore></p><h1 id="references"><strong>References</strong></h1><p>[1] Detecting Sysmon on the Victim Host - (<a href="https://ired.team/offensive-security/enumeration-and-discovery/detecting-sysmon-on-the-victim-host">https://ired.team/offensive-security/enumeration-and-discovery/detecting-sysmon-on-the-victim-host</a>)<br /> [2] Sysmon - (<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon">https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon</a>)<br /> [3] Sysmon Event ID 16 - (<a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90016">https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90016</a>)<br /> [4] Handle - (<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/handle">https://docs.microsoft.com/en-us/sysinternals/downloads/handle</a>)<br /> [5] libelevate - Bypass ObRegisterCallbacks via elevation- (<a href="https://github.com/notscimmy/libelevate">https://github.com/notscimmy/libelevate</a>)<br /> [6] Microsoft Windows Security - (<a href="https://www.microsoftpressstore.com/articles/article.aspx?p=2228450&amp;seqNum=3">https://www.microsoftpressstore.com/articles/article.aspx?p=2228450&amp;seqNum=3</a>)<br /> [7] OBJECT_ATTRIBUTES structure - (<a href="https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes">https://docs.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes</a>)<br /> [8] Windows 7 Object Headers - (<a href="https://codemachine.com/article_objectheader.html">https://codemachine.com/article_objectheader.html</a>)<br /> [9] A Light on Windows 10’s “OBJECT_HEADER-&gt;TypeIndex” - (<a href="https://medium.com/@ashabdalhalim/a-light-on-windows-10s-object-header-typeindex-value-e8f907e7073a">https://medium.com/@ashabdalhalim/a-light-on-windows-10s-object-header-typeindex-value-e8f907e7073a</a>)<br /> [10] OB_OPERATION_REGISTRATION structure - (<a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_ob_operation_registration">https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/ns-wdm-_ob_operation_registration</a>)<br /> [11] Kernel Objects - (<a href="https://computer.forensikblog.de/en/2009/04/kernel-objects.html">https://computer.forensikblog.de/en/2009/04/kernel-objects.html</a>)<br /> [12] Operating Offensively Against Sysmon - (<a href="https://www.darkoperator.com/blog/2018/10/5/operating-offensively-against-sysmon">https://www.darkoperator.com/blog/2018/10/5/operating-offensively-against-sysmon</a>)<br /> [13] DACLs and ACEs - (<a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces">https://docs.microsoft.com/en-us/windows/win32/secauthz/dacls-and-aces</a>)<br /> [14] OkayToCloseProcedure callback kernel hook - (<a href="http://rce4fun.blogspot.com/2014/07/okaytocloseprocedure-callback-kernel_9.html">http://rce4fun.blogspot.com/2014/07/okaytocloseprocedure-callback-kernel_9.html</a>)<br /> [15] Part 1: Digging deep into LoadLibrary - (<a href="https://n4r1b.netlify.com/en/posts/2019/03/part-1-digging-deep-into-loadlibrary/">https://n4r1b.netlify.com/en/posts/2019/03/part-1-digging-deep-into-loadlibrary/</a>)<br /> [16] The Internals of AppLocker - Part 3 - Access Tokens and Access Checking - (<a href="https://tyranidslair.blogspot.com/2019/11/the-internals-of-applocker-part-3.html">https://tyranidslair.blogspot.com/2019/11/the-internals-of-applocker-part-3.html</a>)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tutorials/'>tutorials</a>, <a href='/categories/windows/'>windows</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/handle-creation-in-windows/" class="post-tag no-text-decoration" >handle-creation-in-windows</a> <a href="/tags/handle-table-windows/" class="post-tag no-text-decoration" >handle-table-windows</a> <a href="/tags/handles-in-windows/" class="post-tag no-text-decoration" >handles-in-windows</a> <a href="/tags/how-openprocess-works/" class="post-tag no-text-decoration" >how-openprocess-works</a> <a href="/tags/object-internals/" class="post-tag no-text-decoration" >object-internals</a> <a href="/tags/object-type-windows/" class="post-tag no-text-decoration" >object-type-windows</a> <a href="/tags/reversing-windows-internals/" class="post-tag no-text-decoration" >reversing-windows-internals</a> <a href="/tags/windows-callbacks/" class="post-tag no-text-decoration" >windows-callbacks</a> <a href="/tags/windows-internals-tutorial/" class="post-tag no-text-decoration" >windows-internals-tutorial</a> <a href="/tags/windows-objects/" class="post-tag no-text-decoration" >windows-objects</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks &amp; ObjectTypes - Rayanfam Blog&amp;url=https://rayanfam.com/topics/reversing-windows-internals-part1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks &amp; ObjectTypes - Rayanfam Blog&amp;u=https://rayanfam.com/topics/reversing-windows-internals-part1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/reversing-windows-internals-part1/&amp;text=Reversing Windows Internals (Part 1) - Digging Into Handles, Callbacks &amp; ObjectTypes - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/pykd-tutorial-part1/"><div class="card-body"> <em class="timeago small" data-ts="1527206400" > 2018-05-25 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PyKD Tutorial - part 1</h3><div class="text-muted small"><p> Using windbg script syntax is such annoying thing that almost all reverse engineers have problems dealing with it but automating debugging gives such a power that can’t be easily ignored. A good ...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-5/"><div class="card-body"> <em class="timeago small" data-ts="1544918400" > 2018-12-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/call-gates-ring-transitioning-in-ia-32-mode/"><div class="card-body"> <em class="timeago small" data-ts="1547510400" > 2019-01-15 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Call Gates' Ring Transitioning in IA-32 Mode</h3><div class="text-muted small"><p> Have you ever thought how transitions between different rings performed? Well, SYSENTER &amp;amp; SYSCALL used in modern OSs for transitioning between ring 3 to ring 0 but if there are other rings, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/finding-the-real-access-rights-needed-by-handles/" class="btn btn-outline-primary" prompt="Older"><p>Why you should not always trust MSDN: Finding Real Access Rights Needed By Handles</p></a> <a href="/topics/hypervisor-from-scratch-part-7/" class="btn btn-outline-primary" prompt="Newer"><p>Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/reversing-windows-internals-part1/'; this.page.identifier = '/topics/reversing-windows-internals-part1/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
