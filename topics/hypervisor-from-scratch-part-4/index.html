<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT)" /><meta name="author" content="Sina Karvandi" /><meta property="og:locale" content="en" /><meta name="description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><meta property="og:description" content="We write about Windows Internals, Hypervisors, Linux, and Networks." /><link rel="canonical" href="https://rayanfam.com/topics/hypervisor-from-scratch-part-4/" /><meta property="og:url" content="https://rayanfam.com/topics/hypervisor-from-scratch-part-4/" /><meta property="og:site_name" content="Rayanfam Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-10-05T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT)" /><meta name="twitter:site" content="@Intel80x86" /><meta name="twitter:creator" content="@Sina Karvandi" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sina Karvandi"},"dateModified":"2024-07-13T13:14:26+00:00","datePublished":"2018-10-05T00:00:00+00:00","description":"We write about Windows Internals, Hypervisors, Linux, and Networks.","headline":"Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT)","mainEntityOfPage":{"@type":"WebPage","@id":"https://rayanfam.com/topics/hypervisor-from-scratch-part-4/"},"url":"https://rayanfam.com/topics/hypervisor-from-scratch-part-4/"}</script><title>Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT) | Rayanfam Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Rayanfam Blog"><meta name="application-name" content="Rayanfam Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Rayanfam Blog</a></div><div class="site-subtitle font-italic">An aggressive out-of-order, superscalar blog...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tutorials/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TUTORIALS</span> </a><li class="nav-item"> <a href="/tools/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>TOOLS & SCRIPTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/contact/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>CONTACT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/rayanfam" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/Intel80x86" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['sina','rayanfam.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT)</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/Intel80x86">Sina Karvandi</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1538697600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2018-10-05 </em> </span> <span> Updated <em class="timeago" data-ts="1720876466" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-07-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="4204 words"> <em>23 min</em> read</span></div></div></div><div class="post-content"><p><img data-src="../../assets/images/hypervisor-from-scratch-4-cover.png" alt="" data-proofer-ignore></p><p><strong>If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out <a href="https://github.com/HyperDbg/HyperDbg">HyperDbg</a> Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and reversing applications. A free and comprehensive tutorial on hypervisor-based reverse engineering is available at <a href="https://ost2.fyi/dbg3301">OpenSecurityTraining2’s website</a> (<em>preferred</em>) and <a href="https://www.youtube.com/playlist?list=PLUFkSN0XLZ-kF1f143wlw8ujlH2A45nZY">YouTube</a>, which demonstrates numerous practical examples on how to utilize hypervisors for reverse engineering.</strong></p><h2 id="introduction"><span class="mr-2"><strong>Introduction</strong></span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Welcome to the 4th part of the “<strong>Hypervisor From Scratch</strong>”. This part primarily involves translating guest addresses through <strong>Extended Page Table (EPT)</strong> and its implementation. We also see how shadow tables work and basic concepts about EPT.</p><h2 id="table-of-contents"><span class="mr-2"><strong>Table of Contents</strong></span><a href="#table-of-contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><ul><li><strong>Introduction</strong><li><strong>Table of Contents</strong><li><strong>Overview</strong><li><strong>Second Level Address Translation (SLAT)</strong><li><strong>Software-assisted paging (Shadow Page Tables)</strong><li><strong>Hardware-assisted paging (Extended Page Table)</strong><li><strong>Extended Page Table vs. Shadow Page Table</strong><li><strong>Detecting Support for EPT, NPT</strong><li><strong>EPT Translation</strong><ul><li>Implementing Extended Page Table (EPT)<li>Accessed and Dirty Flags in EPTP</ul><li><strong>5-Level EPT Translation</strong><li><strong>Conclusion</strong><li><strong>References</strong></ul><h2 id="overview"><span class="mr-2"><strong>Overview</strong></span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>First of all, make sure to read the <a href="http://rayanfam.com/tutorials">earlier parts</a> before reading this topic, as these parts depend on each other. It would help if you also had a basic understanding of the paging mechanism and how page tables work. A good article is <a href="https://www.triplefault.io/2017/07/introduction-to-ia-32e-hardware-paging.html">here</a> for paging tables.</p><p>Most of this topic is derived from <strong>Chapter 28</strong> - (<strong>VMX SUPPORT FOR ADDRESS TRANSLATION</strong>) available at Intel 64 and IA-32 architectures software developer’s manual combined volumes 3.</p><p>The full source code of this tutorial is available on GitHub :</p><p>[<a href="https://github.com/SinaKarvandi/Hypervisor-From-Scratch">https://github.com/SinaKarvandi/Hypervisor-From-Scratch</a>]</p><p>Before starting, I should give my thanks to <a href="https://twitter.com/PetrBenes">Petr Beneš</a>, as this part would never have been completed without his help.</p><p><strong>Note:</strong> This part tends to give you basic information about EPT. The main implementation of EPT for our hypervisor is explained in <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-7/">part 7</a>. In part 7, we used the concept we learned here to implement EPT on an already virtualized system.</p><p>Note: Remember that hypervisors change over time because new features are added to the operating systems or new technologies are used. For example, updates to Meltdown &amp; Spectre have made a lot of changes to the hypervisors. So, if you want to use Hypervisor From Scratch in your projects, research, or whatever, you should use the <a href="https://github.com/HyperDbg/HyperDbg"><strong>HyperDbg</strong></a> drivers. <strong>HyperDbg</strong> is actively maintained, stable, and reliable, ensuring you avoid the errors and instability problems that can arise from using older parts of the tutorial series.</p><h2 id="second-level-address-translation-slat"><span class="mr-2"><strong>Second Level Address Translation (SLAT)</strong></span><a href="#second-level-address-translation-slat" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><strong>Second Level Address Translation</strong> (<strong>SLAT</strong>) or nested paging is an extended layer in the paging mechanism used to map hardware-based virtualization virtual addresses into the physical memory.</p><p><strong>AMD</strong> implemented <strong>SLAT</strong> through the <strong>Rapid Virtualization Indexing (RVI)</strong> technology known as <strong>Nested Page Tables (NPT)</strong> since the introduction of its third-generation <strong>Opteron</strong> processors and microarchitecture code name <strong>Barcelona</strong>. <strong>Intel</strong> also implemented <strong>SLAT</strong> in <strong>Intel VT-x technologies</strong> since the introduction of microarchitecture code name <strong>Nehalem</strong> and it’s known as <strong>Extended Page Table (EPT)</strong> and is used in <strong>Core i9</strong>, <strong>Core i7</strong>, <strong>Core i5</strong>, and <strong>Core i3</strong> processors.</p><p><strong>ARM</strong> processors also have an implementation known as <strong>Stage-2 page-tables</strong>.</p><p>There are two methods for implementing SLAT. The first one is Shadow Page Tables, and the second one is Extended Page Tables.</p><h2 id="software-assisted-paging-shadow-page-tables"><span class="mr-2"><strong>Software-assisted paging (Shadow Page Tables)</strong></span><a href="#software-assisted-paging-shadow-page-tables" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>The hypervisor uses Shadow Page Tables to keep track of the state of physical memory in which the guest thinks that it has access to physical memory, but in the real world, the hardware prevents it from accessing hardware memory.</p><p>Without this prevention, the guest might control the host, which is not what is intended.</p><p>In this case, VMM maintains Shadow Page Tables that map guest virtual pages directly to machine pages.</p><p><img data-src="../../assets/images/shadow-page-tables-1.png" alt="" data-proofer-ignore></p><p>By the way, using Shadow Page Table is not recommended today as it always leads to VMM traps (which result in a vast amount of VM-exits) and losses the performance due to the TLB flush on every switch. Another caveat is that there is a memory overhead due to shadow copying of guest page tables.</p><h2 id="hardware-assisted-paging-extended-page-table"><span class="mr-2"><strong>Hardware-assisted paging (Extended Page Table)</strong></span><a href="#hardware-assisted-paging-extended-page-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="../../assets/images/anime-girl-designing.jpg" alt="" data-proofer-ignore></p><p>To reduce the complexity of Shadow Page Tables, avoid the excessive VM-exits, and reduce the number of TLB flushes, EPT implemented a hardware-assisted paging strategy to increase performance.</p><p>According to a <strong>VMware</strong> evaluation paper: “<strong>EPT</strong> provides performance gains of up to 48% for MMU-intensive benchmarks and up to 600% for MMU-intensive microbenchmarks”.</p><p>EPT implemented one more page table hierarchy to map guest virtual address to guest physical address, which is valid in the main memory.</p><p>In EPT,</p><ul><li>One page table is maintained by guest OS, which is used to generate the guest’s physical address.<li>The other page table is maintained by VMM, which maps the guest’s physical address to the host’s physical address.</ul><p>So for each memory access operation, EPT MMU directly gets the guest’s physical address from the guest page table and then automatically gets the host’s physical address from the VMM mapping table.</p><h2 id="extended-page-table-vs-shadow-page-table"><span class="mr-2"><strong>Extended Page Table vs. Shadow Page Table</strong></span><a href="#extended-page-table-vs-shadow-page-table" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>EPT:</p><ul><li>Walk any requested address<ul><li>Appropriate to programs that have a large amount of page table miss when executing<li>Less chance to exit VM (less context switch)</ul><li>Two-layer EPT<ul><li>Means each access needs to walk two tables</ul><li>Easier to develop<ul><li>Many particular registers<li>Hardware helps guest OS to notify the VMM</ul></ul><p>SPT:</p><ul><li>Only walk when SPT entry miss<ul><li>Appropriate to programs that would access only some addresses frequently<li>Every access might be intercepted by VMM (many traps)</ul><li>One reference<ul><li>Fast and convenient when page hit</ul><li>Hard to develop<ul><li>Two-layer structure<li>Complicated reverse map<li>Permission emulation</ul></ul><h2 id="detecting-support-for-ept-npt"><span class="mr-2"><strong>Detecting Support for EPT, NPT</strong></span><a href="#detecting-support-for-ept-npt" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>If you want to see whether your system supports EPT on Intel processor or NPT on AMD processor without using assembly (CPUID), you can download <strong>coreinfo.exe</strong> from SysInternals, then run it. The last line will show you if your processor supports EPT or NPT.</p><p><img data-src="../../assets/images/EPT-support.png" alt="" data-proofer-ignore></p><h2 id="ept-translation"><span class="mr-2"><strong>EPT Translation</strong></span><a href="#ept-translation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>EPT defines a layer of address translation that augments the translation of linear addresses.</p><p>The extended page-table mechanism (EPT) is a feature that can be used to support the virtualization of physical memory. When EPT is in use, certain addresses that would normally be treated as physical addresses (and used to access memory) are instead treated as guest physical addresses. Guest physical addresses are translated by traversing a set of EPT paging structures to produce physical addresses that are used to access memory.</p><p>EPT is used when the “<strong>enable EPT</strong>” VM-execution control is 1. It translates the guest physical addresses used in VMX non-root operation and those used by VM entry for event injection.</p><p>EPT translation is exactly like regular paging translation but with some minor differences. In paging, the processor translates a virtual address to a physical address, while in EPT translation, we want to translate a guest’s physical address to a host’s physical address.</p><p>If you’re familiar with paging, the 3rd control register (CR3) is the base address of the <em>PML4</em> table (in an x64 processor or, more generally, it points to the root paging directory). In EPT guest is not aware of EPT translation, so it has CR3 too, but this CR3 is used to convert the guest’s virtual address to the guest’s physical address. Whenever we find our target (the guest’s physical address), the EPT mechanism treats our guest’s physical address like a virtual address and converts it to the host’s physical address. In this mechanism, <strong>EPTP</strong> is like <strong>CR3</strong> but for EPT.</p><p>Just think about the above sentence one more time!</p><p>So your target physical address should be divided into four parts. The first 9 bits point to EPT PML4E (note that the PML4 base address is in EPTP). The second 9 bits indicate the EPT PDPT Entry (the base address of PDPT comes from EPT PML4E), the third 9 bits point to EPT PD Entry (the base address of PD comes from EPT PDPTE), and the last 9 bits of the guest physical address point to an entry in EPT PT table (the base address of PT comes from EPT PDE) and now the EPT PT Entry points to the host physical address of the corresponding page.</p><p><img data-src="../../assets/images/EPT-translations.png" alt="EPT Translation" data-proofer-ignore></p><p>You might ask, as a simple Virtual to Physical Address translation involves accessing four physical addresses, so what happens?</p><p>The answer is the processor internally translates all tables’ physical addresses one by one; that’s why paging and accessing memory in a guest software is slower than hardware address translation. The following picture illustrates the operations for a guest’s virtual address to the host’s physical address.</p><p><img data-src="../../assets/images/EPT-full-translation.png" alt="" data-proofer-ignore></p><p>If you want to think about x86 EPT virtualization, assume, for example, that CR4.PAE = CR4.PSE = 0. The translation of a <strong>32-bit</strong> linear address then operates as follows:</p><ul><li>Bits 31:22 of the linear address select an entry in the guest page directory located at the guest physical address in CR3. The guest’s physical address of the guest page-directory entry (PDE) is translated through EPT to determine the guest PDE’s physical address.<li>Bits 21:12 of the linear address select an entry in the guest page table located at the guest’s physical address in the guest PDE. The guest physical address of the guest page-table entry (PTE) is translated through EPT to determine the guest PTE’s physical address.<li>Bits 11:0 of the linear address is the offset in the page frame located at the guest’s physical address in the guest PTE. The guest’s physical address determined by this offset is translated through EPT to select the physical address to which the original linear address translates.</ul><p>Note that <strong>PAE</strong> stands for <strong>P</strong>hysical <strong>A</strong>ddress <strong>E</strong>xtension, which is a memory management feature for the x86 architecture that extends the address space, and <strong>PSE</strong> stands for <strong>P</strong>age <strong>S</strong>ize <strong>E</strong>xtension that refers to a feature of x86 processors that allows for pages larger than the standard 4 KiB size.</p><p>In addition to translating a guest’s physical address to a host’s physical address, EPT specifies the privileges that software is allowed when accessing the address. Attempts at disallowed accesses are called <strong>EPT violations</strong> and cause <strong>VM-exits</strong>.</p><p>Remember that an address will not translate through EPT when there is no read/write access.</p><h3 id="implementing-extended-page-table-ept"><span class="mr-2"><strong>Implementing Extended Page Table (EPT)</strong></span><a href="#implementing-extended-page-table-ept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Now that we know some basics, let’s implement what we’ve learned before. Based on the Intel manual, we should write (<strong>VMWRITE</strong>) EPTP or Extended-Page-Table Pointer to the VMCS. The EPTP structure is described below.</p><p><img data-src="../../assets/images/EPTP-structure.png" alt="Extended-Page-Table Pointer" data-proofer-ignore></p><p>The above tables can be described using the following structure:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">// See Table 24-8. Format of Extended-Page-Table Pointer</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_EPTP</span> <span class="p">{</span>
    <span class="n">ULONG64</span> <span class="n">All</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="n">UINT64</span> <span class="n">MemoryType</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// bit 2:0 (0 = Uncacheable (UC) - 6 = Write - back(WB))</span>
        <span class="n">UINT64</span> <span class="n">PageWalkLength</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// bit 5:3 (This value is 1 less than the EPT page-walk length) </span>
        <span class="n">UINT64</span> <span class="n">DirtyAndAceessEnabled</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 6  (Setting this control to 1 enables accessed and dirty flags for EPT)</span>
        <span class="n">UINT64</span> <span class="n">Reserved1</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// bit 11:7 </span>
        <span class="n">UINT64</span> <span class="n">PML4Address</span> <span class="o">:</span> <span class="mi">36</span><span class="p">;</span>
        <span class="n">UINT64</span> <span class="n">Reserved2</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
    <span class="p">}</span><span class="n">Fields</span><span class="p">;</span>
<span class="p">}</span><span class="n">EPTP</span><span class="p">,</span> <span class="o">*</span><span class="n">PEPTP</span><span class="p">;</span>
</pre></table></code></div></div><p>Like the regular paging mechanism, each entry in all EPT tables is 64-bit long. EPT PML4E, EPT PDPTE, and EPT PD are the same, but EPT PTE has some minor differences.</p><p>An EPT entry is something like this:</p><p><img data-src="../../assets/images/ept-entries.png" alt="EPT Entries" data-proofer-ignore></p><p>Ok, Now we should implement tables; the first table is PML4. The following table shows the format of an EPT PML4 Entry (PML4E).</p><p><img data-src="../../assets/images/EPT-PML4E.png" alt="EPT PML4E" data-proofer-ignore></p><p>PML4E is a structure like this :</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// See Table 28-1. </span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_EPT_PML4E</span> <span class="p">{</span>
    <span class="n">ULONG64</span> <span class="n">All</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="n">UINT64</span> <span class="n">Read</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 0</span>
        <span class="n">UINT64</span> <span class="n">Write</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 1</span>
        <span class="n">UINT64</span> <span class="n">Execute</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 2</span>
        <span class="n">UINT64</span> <span class="n">Reserved1</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// bit 7:3 (Must be Zero)</span>
        <span class="n">UINT64</span> <span class="n">Accessed</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 8</span>
        <span class="n">UINT64</span> <span class="n">Ignored1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 9</span>
        <span class="n">UINT64</span> <span class="n">ExecuteForUserMode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 10</span>
        <span class="n">UINT64</span> <span class="n">Ignored2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 11</span>
        <span class="n">UINT64</span> <span class="n">PhysicalAddress</span> <span class="o">:</span> <span class="mi">36</span><span class="p">;</span> <span class="c1">// bit (N-1):12 or Page-Frame-Number</span>
        <span class="n">UINT64</span> <span class="n">Reserved2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// bit 51:N</span>
        <span class="n">UINT64</span> <span class="n">Ignored3</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// bit 63:52</span>
    <span class="p">}</span><span class="n">Fields</span><span class="p">;</span>
<span class="p">}</span><span class="n">EPT_PML4E</span><span class="p">,</span> <span class="o">*</span><span class="n">PEPT_PML4E</span><span class="p">;</span>
</pre></table></code></div></div><p>As long as we use 4-level paging, the second table is EPT Page-Directory-Pointer-Table (PDTP). The following picture illustrates the format of PDPTE:</p><p><img data-src="../../assets/images/EPT-PDPTE.png" alt="EPT PDPTE" data-proofer-ignore></p><p>PDPTE’s structure is like this:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// See Table 28-3</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_EPT_PDPTE</span> <span class="p">{</span>
    <span class="n">ULONG64</span> <span class="n">All</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="n">UINT64</span> <span class="n">Read</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 0</span>
        <span class="n">UINT64</span> <span class="n">Write</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 1</span>
        <span class="n">UINT64</span> <span class="n">Execute</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 2</span>
        <span class="n">UINT64</span> <span class="n">Reserved1</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// bit 7:3 (Must be Zero)</span>
        <span class="n">UINT64</span> <span class="n">Accessed</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 8</span>
        <span class="n">UINT64</span> <span class="n">Ignored1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 9</span>
        <span class="n">UINT64</span> <span class="n">ExecuteForUserMode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 10</span>
        <span class="n">UINT64</span> <span class="n">Ignored2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 11</span>
        <span class="n">UINT64</span> <span class="n">PhysicalAddress</span> <span class="o">:</span> <span class="mi">36</span><span class="p">;</span> <span class="c1">// bit (N-1):12 or Page-Frame-Number</span>
        <span class="n">UINT64</span> <span class="n">Reserved2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// bit 51:N</span>
        <span class="n">UINT64</span> <span class="n">Ignored3</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// bit 63:52</span>
    <span class="p">}</span><span class="n">Fields</span><span class="p">;</span>
<span class="p">}</span><span class="n">EPT_PDPTE</span><span class="p">,</span> <span class="o">*</span><span class="n">PEPT_PDPTE</span><span class="p">;</span>
</pre></table></code></div></div><p>For the third table of paging, we should implement an EPT Page-Directory Entry (PDE) as described below:</p><p><img data-src="../../assets/images/EPT-PDE.png" alt="EPT PDE" data-proofer-ignore></p><p>PDE’s structure:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// See Table 28-5</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_EPT_PDE</span> <span class="p">{</span>
    <span class="n">ULONG64</span> <span class="n">All</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="n">UINT64</span> <span class="n">Read</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 0</span>
        <span class="n">UINT64</span> <span class="n">Write</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 1</span>
        <span class="n">UINT64</span> <span class="n">Execute</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 2</span>
        <span class="n">UINT64</span> <span class="n">Reserved1</span> <span class="o">:</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// bit 7:3 (Must be Zero)</span>
        <span class="n">UINT64</span> <span class="n">Accessed</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 8</span>
        <span class="n">UINT64</span> <span class="n">Ignored1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 9</span>
        <span class="n">UINT64</span> <span class="n">ExecuteForUserMode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 10</span>
        <span class="n">UINT64</span> <span class="n">Ignored2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 11</span>
        <span class="n">UINT64</span> <span class="n">PhysicalAddress</span> <span class="o">:</span> <span class="mi">36</span><span class="p">;</span> <span class="c1">// bit (N-1):12 or Page-Frame-Number</span>
        <span class="n">UINT64</span> <span class="n">Reserved2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// bit 51:N</span>
        <span class="n">UINT64</span> <span class="n">Ignored3</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span> <span class="c1">// bit 63:52</span>
    <span class="p">}</span><span class="n">Fields</span><span class="p">;</span>
<span class="p">}</span><span class="n">EPT_PDE</span><span class="p">,</span> <span class="o">*</span><span class="n">PEPT_PDE</span><span class="p">;</span>
</pre></table></code></div></div><p>The last page is EPT which is described below.</p><p><img data-src="../../assets/images/EPT-PTE.png" alt="EPT PTE" data-proofer-ignore></p><p>PTE will be :</p><p>Note that we have <code class="language-c highlighter-rouge"><span class="n">EPTMemoryType</span></code>, <code class="language-c highlighter-rouge"><span class="n">IgnorePAT</span></code>, <code class="language-c highlighter-rouge"><span class="n">DirtyFlag</span></code>, and <code class="language-c highlighter-rouge"><span class="n">SuppressVE</span></code> in addition to the above pages.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="c1">// See Table 28-6</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">_EPT_PTE</span> <span class="p">{</span>
    <span class="n">ULONG64</span> <span class="n">All</span><span class="p">;</span>
    <span class="k">struct</span> <span class="p">{</span>
        <span class="n">UINT64</span> <span class="n">Read</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 0</span>
        <span class="n">UINT64</span> <span class="n">Write</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 1</span>
        <span class="n">UINT64</span> <span class="n">Execute</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 2</span>
        <span class="n">UINT64</span> <span class="n">EPTMemoryType</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// bit 5:3 (EPT Memory type)</span>
        <span class="n">UINT64</span> <span class="n">IgnorePAT</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 6</span>
        <span class="n">UINT64</span> <span class="n">Ignored1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 7</span>
        <span class="n">UINT64</span> <span class="n">AccessedFlag</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 8   </span>
        <span class="n">UINT64</span> <span class="n">DirtyFlag</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 9</span>
        <span class="n">UINT64</span> <span class="n">ExecuteForUserMode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 10</span>
        <span class="n">UINT64</span> <span class="n">Ignored2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 11</span>
        <span class="n">UINT64</span> <span class="n">PhysicalAddress</span> <span class="o">:</span> <span class="mi">36</span><span class="p">;</span> <span class="c1">// bit (N-1):12 or Page-Frame-Number</span>
        <span class="n">UINT64</span> <span class="n">Reserved</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span> <span class="c1">// bit 51:N</span>
        <span class="n">UINT64</span> <span class="n">Ignored3</span> <span class="o">:</span> <span class="mi">11</span><span class="p">;</span> <span class="c1">// bit 62:52</span>
        <span class="n">UINT64</span> <span class="n">SuppressVE</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// bit 63</span>
    <span class="p">}</span><span class="n">Fields</span><span class="p">;</span>
<span class="p">}</span><span class="n">EPT_PTE</span><span class="p">,</span> <span class="o">*</span><span class="n">PEPT_PTE</span><span class="p">;</span>
</pre></table></code></div></div><p>There are other types of implementing page walks (2 or 3 level paging), and if you set the 7th bit of PDPTE (Maps 1 GB) or the 7th bit of PDE (Maps 2 MB) so instead of implementing 4-level paging (like what we want to do for the rest of the topic) we set those bits but keep in mind that the corresponding tables are different. These tables are described in (Table 28-4. Format of an EPT Page-Directory Entry (PDE) that Maps a 2-MByte Page) and (Table 28-2. Format of an EPT Page-Directory-Pointer-Table Entry (PDPTE) that Maps a 1-GByte Page). <a href="https://github.com/ionescu007/SimpleVisor">SimpleVisor</a> is an example of this implementation.</p><p>An important note is almost all the above structures have a 36-bit Physical Address which means our hypervisor supports only 4-level paging. It is because every page table (and every EPT Page Table) consists of 512 entries which means you need 9 bits to select an entry, and as long as we have 4 level tables, we can’t use more than 36 (4 * 9) bits. Another method with a wider address range is not implemented in all major OS like Windows or Linux. I’ll describe EPT PML5E briefly later in this topic, but we don’t implement it in our hypervisor as it’s not widespread yet!</p><p>By the way, <code class="language-c highlighter-rouge"><span class="n">N</span></code> is the physical address width supported by the processor. CPUID with <strong>80000008H</strong> in <code class="language-c highlighter-rouge"><span class="n">EAX</span></code> gives you the supported width in <code class="language-c highlighter-rouge"><span class="n">EAX</span></code> bits 7:0.</p><p>Let’s see the rest of the code. The following code is the <strong>InitializeEptp</strong> function which is responsible for allocating and mapping EPTP.</p><p>Note that the <strong>PAGED_CODE()</strong> macro ensures that the calling thread runs at an IRQL low enough to permit paging.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">UINT64</span>
<span class="nf">InitializeEptp</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">PAGED_CODE</span><span class="p">();</span>
        <span class="p">...</span>
</pre></table></code></div></div><p>First of all, allocate EPTP and put zeros on it.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">// Allocate EPTP</span>
    <span class="c1">//</span>
    <span class="n">PEPTP</span> <span class="n">EPTPointer</span> <span class="o">=</span> <span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EPTPointer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RtlZeroMemory</span><span class="p">(</span><span class="n">EPTPointer</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</pre></table></code></div></div><p>Now, we need a blank page for our EPT PML4 Table.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">//  Allocate EPT PML4</span>
    <span class="c1">//</span>
    <span class="n">PEPT_PML4E</span> <span class="n">EptPml4</span> <span class="o">=</span> <span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EptPml4</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EPTPointer</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RtlZeroMemory</span><span class="p">(</span><span class="n">EptPml4</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</pre></table></code></div></div><p>And another empty page for PDPT.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">//  Allocate EPT Page-Directory-Pointer-Table</span>
    <span class="c1">//</span>
    <span class="n">PEPT_PDPTE</span> <span class="n">EptPdpt</span> <span class="o">=</span> <span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EptPdpt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EptPml4</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EPTPointer</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RtlZeroMemory</span><span class="p">(</span><span class="n">EptPdpt</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</pre></table></code></div></div><p>Of course, it’s true about Page Directory Table.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">//  Allocate EPT Page-Directory</span>
    <span class="c1">//</span>
    <span class="n">PEPT_PDE</span> <span class="n">EptPd</span> <span class="o">=</span> <span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EptPd</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EptPdpt</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EptPml4</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EPTPointer</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RtlZeroMemory</span><span class="p">(</span><span class="n">EptPd</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</pre></table></code></div></div><p>The last table is a blank page for EPT Page Table.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">//  Allocate EPT Page-Table</span>
    <span class="c1">//</span>
    <span class="n">PEPT_PTE</span> <span class="n">EptPt</span> <span class="o">=</span> <span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EptPt</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EptPd</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EptPdpt</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EptPml4</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="n">ExFreePoolWithTag</span><span class="p">(</span><span class="n">EPTPointer</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">RtlZeroMemory</span><span class="p">(</span><span class="n">EptPt</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
</pre></table></code></div></div><p>Now that we have all of our pages available, let’s allocate two pages (2*4096) continuously because we need one of the pages for our <code class="language-c highlighter-rouge"><span class="n">RIP</span></code> register to start and one page for our stack (<code class="language-c highlighter-rouge"><span class="n">RSP</span></code> register). After that, we need two EPT Page Table Entries (PTEs) with permission to <strong>execute</strong>, <strong>read</strong>, and <strong>write</strong>. The physical address should be divided by 4096 (PAGE_SIZE) because if we dived a hex number by 4096 (0x1000), 12 digits from the right (which are zeros) would disappear, and these 12 digits are for choosing between 4096 bytes.</p><p>By the way, we let stack be executable. That’s because, in a regular VM, we should put RWX on all pages. After all, it’s the responsibility of internal page tables to set or clear <strong>NX</strong> bit. We need to change them from EPT tables for special purposes (e.g., intercepting instruction fetch for a special page). Changing from EPT tables will lead to EPT-Violation; this way, we can intercept these events.</p><p>The actual need is two pages, but we need to build page tables inside our guest software; thus, we allocate up to 10 pages.</p><p>I’ll explain about intercepting pages from EPT later in this series.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">// Setup PT by allocating two pages Continuously</span>
    <span class="c1">// We allocate two pages because we need 1 page for our RIP to start and 1 page for RSP 1 + 1 = 2</span>
    <span class="c1">//</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">PagesToAllocate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">UINT64</span>    <span class="n">GuestMemory</span>     <span class="o">=</span> <span class="n">ExAllocatePoolWithTag</span><span class="p">(</span><span class="n">NonPagedPool</span><span class="p">,</span> <span class="n">PagesToAllocate</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">POOLTAG</span><span class="p">);</span>
    <span class="n">RtlZeroMemory</span><span class="p">(</span><span class="n">GuestMemory</span><span class="p">,</span> <span class="n">PagesToAllocate</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PagesToAllocate</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">AccessedFlag</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">DirtyFlag</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">EPTMemoryType</span>      <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">Execute</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">ExecuteForUserMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">IgnorePAT</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">PhysicalAddress</span>    <span class="o">=</span> <span class="p">(</span><span class="n">VirtualToPhysicalAddress</span><span class="p">(</span><span class="n">GuestMemory</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">Read</span>               <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">SuppressVE</span>         <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">EptPt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Fields</span><span class="p">.</span><span class="n">Write</span>              <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>Note: <strong>EPTMemoryType</strong> can be either 0 (for uncached memory) or 6 (writeback) memory, and as we want our memory to be cacheable, so put 6 on it.</p><p>The next table is PDE. PDE should point to the PTE base address, so we just put the address of the first entry from the EPT PTE as the physical address for Page Directory Entry.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">// Setting up PDE</span>
    <span class="c1">//</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Accessed</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Execute</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">ExecuteForUserMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored1</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored2</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored3</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">PhysicalAddress</span>    <span class="o">=</span> <span class="p">(</span><span class="n">VirtualToPhysicalAddress</span><span class="p">(</span><span class="n">EptPt</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Read</span>               <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved1</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved2</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPd</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Write</span>              <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></table></code></div></div><p>The next step is mapping PDPT. PDPT Entry should point to the first entry of Page-Directory.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">// Setting up PDPTE</span>
    <span class="c1">//</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Accessed</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Execute</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">ExecuteForUserMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored1</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored2</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored3</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">PhysicalAddress</span>    <span class="o">=</span> <span class="p">(</span><span class="n">VirtualToPhysicalAddress</span><span class="p">(</span><span class="n">EptPd</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Read</span>               <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved1</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved2</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPdpt</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Write</span>              <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></table></code></div></div><p>The last step is configuring PML4E, which points to the first entry of the PTPT.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">// Setting up PML4E</span>
    <span class="c1">//</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Accessed</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Execute</span>            <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">ExecuteForUserMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored1</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored2</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Ignored3</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">PhysicalAddress</span>    <span class="o">=</span> <span class="p">(</span><span class="n">VirtualToPhysicalAddress</span><span class="p">(</span><span class="n">EptPdpt</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Read</span>               <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved1</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved2</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EptPml4</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Write</span>              <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></table></code></div></div><p>We’ve almost done! Just set up the EPTP for our VMCS by putting 0x6 as the memory type (which is writeback), and we walk four times, so the page walk length is 4-1=3, and the PML4 address is the physical address of the first entry in the PML4 table.</p><p>I’ll explain the <strong>DirtyAndAcessEnabled</strong> field later in this topic.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>    <span class="c1">//</span>
    <span class="c1">// Setting up EPTP</span>
    <span class="c1">//</span>
    <span class="n">EPTPointer</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">DirtyAndAceessEnabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">EPTPointer</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">MemoryType</span>            <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">// 6 = Write-back (WB)</span>
    <span class="n">EPTPointer</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">PageWalkLength</span>        <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// 4 (tables walked) - 1 = 3</span>
    <span class="n">EPTPointer</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">PML4Address</span>           <span class="o">=</span> <span class="p">(</span><span class="n">VirtualToPhysicalAddress</span><span class="p">(</span><span class="n">EptPml4</span><span class="p">)</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
    <span class="n">EPTPointer</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved1</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">EPTPointer</span><span class="o">-&gt;</span><span class="n">Fields</span><span class="p">.</span><span class="n">Reserved2</span>             <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></table></code></div></div><p>And the last step.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>    <span class="n">DbgPrint</span><span class="p">(</span><span class="s">"[*] Extended Page Table Pointer allocated at %llx"</span><span class="p">,</span> <span class="n">EPTPointer</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EPTPointer</span><span class="p">;</span>
</pre></table></code></div></div><p>All the above page tables should be aligned to 4KByte boundaries, but as long as we allocate &gt;= PAGE_SIZE (One PFN record) so it’s automatically 4kb-aligned.</p><p>Our implementation consists of 4 tables; therefore, the full layout is like this:</p><p><img data-src="../../assets/images/EPT-Layout.png" alt="EPT Layout" data-proofer-ignore></p><h3 id="accessed-and-dirty-flags-in-eptp"><span class="mr-2"><strong>Accessed and Dirty Flags in EPTP</strong></span><a href="#accessed-and-dirty-flags-in-eptp" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>In EPTP, we’ll decide whether enable accessed and dirty flags for EPT or not using the 6th bit of the extended-page-table pointer (EPTP). Setting this flag causes processor accesses to guest paging structure entries to be treated as writes.</p><p>For any EPT paging-structure entry that is used during guest-physical-address translation, bit 8 is the accessed flag. For an EPT paging-structure entry that maps a page (as opposed to referencing another EPT paging structure), bit 9 is the dirty flag.</p><p>Whenever the processor uses an EPT paging-structure entry as part of the guest-physical-address translation, it sets the accessed flag in that entry (if it is not already set).</p><p>Whenever there is a write to a guest physical address, the processor sets the dirty flag (if it is not already set) in the EPT paging-structure entry that identifies the final physical address for the guest’s physical address (either an EPT PTE or an EPT paging-structure entry in which bit 7 is 1).</p><p>These flags are “<strong>sticky</strong>”, meaning that, once set, the processor does not clear them; only software can clear them.</p><h2 id="5-level-ept-translation"><span class="mr-2"><strong>5-Level EPT Translation</strong></span><a href="#5-level-ept-translation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Intel suggests a new table in translation hierarchy, called PML5 which extends the EPT into a 5-layer table, and guest operating systems can use up to 57 bits for the virtual addresses, while the classic 4-level EPT is limited to translating 48-bit guest physical addresses. None of the modern OSs use this feature yet.</p><p>PML5 is also applied to both EPT and regular paging mechanisms.</p><p><img data-src="../../assets/images/PML5E-structure.png" alt="" data-proofer-ignore></p><p>Translation begins by identifying a 4-KByte naturally aligned EPT PML5 table. It is located at the physical address specified in bits 51:12 of EPTP. An EPT PML5 table comprises 512 64-bit entries (EPT PML5Es). An EPT PML5E is selected using the physical address defined as follows.</p><ul><li>Bits 63:52 are all 0.<li>Bits 51:12 are from EPTP.<li>Bits 11:3 are bits 56:48 of the guest physical address.<li>Bits 2:0 are all 0.<li>Because an EPT PML5E is identified using bits 56:48 of the guest’s physical address, it controls access to a 256-TByte region of the linear address space.</ul><p>The only difference is we should put PML5 physical address instead of the PML4 address in EPTP.</p><p>For more information about 5-layer paging, take a look at <a href="https://software.intel.com/sites/default/files/managed/2b/80/5-level_paging_white_paper.pdf">this Intel documentation</a>.</p><h2 id="conclusion"><span class="mr-2"><strong>Conclusion</strong></span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>In this part, we see how to initialize the Extended Page Table (EPT) and map the guest’s physical address to the host’s physical address; then, we build the EPTP based on the allocated addresses.</p><p>The future part would be about building the VMCS and implementing other VMX instructions and functionalities.</p><p>The fifth part is also available <a href="https://rayanfam.com/topics/hypervisor-from-scratch-part-5/">here</a>.</p><p>Have a good time!</p><p><img data-src="../../assets/images/anime-girl-playing.jpg" alt="" data-proofer-ignore></p><h2 id="references"><span class="mr-2"><strong>References</strong></span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>[1] Vol 3C - 28.2 THE EXTENDED PAGE TABLE MECHANISM (EPT) (<a href="https://software.intel.com/en-us/articles/intel-sdm">https://software.intel.com/en-us/articles/intel-sdm</a>)</p><p>[2] Performance Evaluation of Intel EPT Hardware Assist (<a href="https://www.vmware.com/pdf/Perf_ESX_Intel-EPT-eval.pdf">https://www.vmware.com/pdf/Perf_ESX_Intel-EPT-eval.pdf</a>)</p><p>[3] Second Level Address Translation (<a href="https://en.wikipedia.org/wiki/Second_Level_Address_Translation">https://en.wikipedia.org/wiki/Second_Level_Address_Translation</a>)</p><p>[4] Memory Virtualization (<a href="http://www.cs.nthu.edu.tw/~ychung/slides/Virtualization/VM-Lecture-2-2-SystemVirtualizationMemory.pptx">http://www.cs.nthu.edu.tw/~ychung/slides/Virtualization/VM-Lecture-2-2-SystemVirtualizationMemory.pptx</a>)</p><p>[5] Best Practices for Paravirtualization Enhancements from Intel® Virtualization Technology: EPT and VT-d (<a href="https://software.intel.com/en-us/articles/best-practices-for-paravirtualization-enhancements-from-intel-virtualization-technology-ept-and-vt-d">https://software.intel.com/en-us/articles/best-practices-for-paravirtualization-enhancements-from-intel-virtualization-technology-ept-and-vt-d</a>)</p><p>[6] 5-Level Paging and 5-Level EPT (<a href="https://software.intel.com/sites/default/files/managed/2b/80/5-level_paging_white_paper.pdf">https://software.intel.com/sites/default/files/managed/2b/80/5-level_paging_white_paper.pdf</a>)</p><p>[7] Xen Summit November 2007 - Jun Nakajima (<a href="http://www-archive.xenproject.org/files/xensummit_fall07/12_JunNakajima.pdf">http://www-archive.xenproject.org/files/xensummit_fall07/12_JunNakajima.pdf</a>)</p><p>[8] gipervizor against rutkitov: as it works (<a href="http://developers-club.com/posts/133906/">http://developers-club.com/posts/133906</a>/)</p><p>[9] Intel SGX Explained (<a href="https://www.semanticscholar.org/paper/Intel-SGX-Explained-Costan-Devadas/2d7f3f4ca3fbb15ae04533456e5031e0d0dc845a">https://www.semanticscholar.org/paper/Intel-SGX-Explained-Costan-Devadas/2d7f3f4ca3fbb15ae04533456e5031e0d0dc845a</a>)</p><p>[10] Intel VT-x (<a href="https://github.com/tnballo/notebook/wiki/Intel-VTx">https://github.com/tnballo/notebook/wiki/Intel-VTx</a>)</p><p>[11] Introduction to IA-32e hardware paging (<a href="https://www.triplefault.io/2017/07/introduction-to-ia-32e-hardware-paging.html">https://www.triplefault.io/2017/07/introduction-to-ia-32e-hardware-paging.html</a>)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/cpu/'>cpu</a>, <a href='/categories/hypervisor/'>hypervisor</a>, <a href='/categories/tutorials/'>tutorials</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/hypervisor/" class="post-tag no-text-decoration" >hypervisor</a> <a href="/tags/all-context/" class="post-tag no-text-decoration" >all-context</a> <a href="/tags/ept/" class="post-tag no-text-decoration" >ept</a> <a href="/tags/eptp/" class="post-tag no-text-decoration" >eptp</a> <a href="/tags/extended-page-table/" class="post-tag no-text-decoration" >extended-page-table</a> <a href="/tags/extended-page-table-pointer/" class="post-tag no-text-decoration" >extended-page-table-pointer</a> <a href="/tags/hypervisor-paging/" class="post-tag no-text-decoration" >hypervisor-paging</a> <a href="/tags/invept/" class="post-tag no-text-decoration" >invept</a> <a href="/tags/nested-page-tables/" class="post-tag no-text-decoration" >nested-page-tables</a> <a href="/tags/npt/" class="post-tag no-text-decoration" >npt</a> <a href="/tags/rapid-virtualization-indexing/" class="post-tag no-text-decoration" >rapid-virtualization-indexing</a> <a href="/tags/rvi/" class="post-tag no-text-decoration" >rvi</a> <a href="/tags/second-level-address-translation/" class="post-tag no-text-decoration" >second-level-address-translation</a> <a href="/tags/single-context/" class="post-tag no-text-decoration" >single-context</a> <a href="/tags/slat/" class="post-tag no-text-decoration" >slat</a> <a href="/tags/stage-2-page-tables/" class="post-tag no-text-decoration" >stage-2-page-tables</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT) - Rayanfam Blog&amp;url=https://rayanfam.com/topics/hypervisor-from-scratch-part-4/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT) - Rayanfam Blog&amp;u=https://rayanfam.com/topics/hypervisor-from-scratch-part-4/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://rayanfam.com/topics/hypervisor-from-scratch-part-4/&amp;text=Hypervisor From Scratch – Part 4: Address Translation Using Extended Page Table (EPT) - Rayanfam Blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/topics/hypervisor-from-scratch-part-1/">Hypervisor From Scratch - Part 1: Basic Concepts & Configure Testing Environment</a><li><a href="/topics/hypervisor-from-scratch-part-2/">Hypervisor From Scratch – Part 2: Entering VMX Operation</a><li><a href="/topics/hypervisor-from-scratch-part-5/">Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</a><li><a href="/topics/hypervisor-from-scratch-part-6/">Hypervisor From Scratch – Part 6: Virtualizing An Already Running System</a><li><a href="/topics/hypervisor-from-scratch-part-7/">Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/topics/hypervisor-from-scratch-part-7/"><div class="card-body"> <em class="timeago small" data-ts="1579478400" > 2020-01-20 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 7: Using EPT & Page-Level Monitoring Features</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-8/"><div class="card-body"> <em class="timeago small" data-ts="1585008000" > 2020-03-24 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 8: How To Do Magic With Hypervisor!</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div><div class="card"> <a href="/topics/hypervisor-from-scratch-part-5/"><div class="card-body"> <em class="timeago small" data-ts="1544918400" > 2018-12-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hypervisor From Scratch – Part 5: Setting up VMCS & Running Guest Code</h3><div class="text-muted small"><p> If you’re looking to use a hypervisor for analysis and reverse engineering tasks, check out HyperDbg Debugger. It’s a hypervisor-based debugger designed specifically for analyzing, fuzzing, and r...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/topics/hypervisor-from-scratch-part-3/" class="btn btn-outline-primary" prompt="Older"><p>Hypervisor From Scratch – Part 3: Setting up Our First Virtual Machine</p></a> <a href="/topics/start-linux-kernel-module-development/" class="btn btn-outline-primary" prompt="Newer"><p>Start linux kernel module development!</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://rayanfam.com/topics/hypervisor-from-scratch-part-4/'; this.page.identifier = '/topics/hypervisor-from-scratch-part-4/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://rayanfam.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (typeof modeToggle !== "undefined") { /* modeToggle.addEventListener('click', reloadDisqus); // not pretty for 'color-scheme' */ window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://github.com/rayanfam">Rayanfam Blog</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hypervisor/">hypervisor</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/debian/">debian</a> <a class="post-tag" href="/tags/network/">network</a> <a class="post-tag" href="/tags/cisco/">cisco</a> <a class="post-tag" href="/tags/invept/">invept</a> <a class="post-tag" href="/tags/ios/">ios</a> <a class="post-tag" href="/tags/vmcs/">vmcs</a> <a class="post-tag" href="/tags/active-directory/">active-directory</a> <a class="post-tag" href="/tags/cache/">cache</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-P6M1BDG57Z"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-P6M1BDG57Z'); }); </script>
